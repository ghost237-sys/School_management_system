{% extends 'base.html' %}
{% block content %}
<style>
  .tabs-card { border-radius: 12px; overflow: hidden; }
  .nav-tabs .nav-link { font-weight: 600; }
  .nav-tabs .nav-link.active { color: #0d47a1; }
  .tab-pane .card { border-radius: 12px; }
  .help-text { color:#6c757d; font-size:.875rem; }
  .sticky-actions { position: sticky; bottom: 0; background: #fff; padding-top: .5rem; }
  .table thead th { font-weight:600; }
  @media (max-width: 576px){ .btn-group-flex { display:block; } }
  .subtle { color:#6c757d; }
  .shadow-soft { box-shadow: 0 6px 18px rgba(0,0,0,.06); }
  .badge-soft-success { background:#e8f7ef; color:#198754; border:1px solid #bbebce; }
  .badge-soft-danger { background:#fdecec; color:#dc3545; border:1px solid #f7c2c7; }
  .badge-soft-secondary { background:#eef2f7; color:#6c757d; border:1px solid #dee2e6; }
  .form-section-title { font-weight:600; margin-bottom:.5rem; }
  /* Scrollable history list with sticky header */
  .history-scroll { max-height: 60vh; overflow-y: auto; }
  .table-sticky thead th { position: sticky; top: 0; z-index: 2; background: #f8f9fa; }
  /* Modern section cards */
  .section-card { border: 1px solid #e9ecef; border-radius: 12px; background: #ffffff; }
  .section-header { display:flex; align-items:center; gap:.5rem; padding:.75rem 1rem; border-bottom:1px solid #eef2f7; background: linear-gradient(180deg,#f8fbff,#ffffff); border-top-left-radius:12px; border-top-right-radius:12px; }
  .section-header .title { margin:0; font-weight:700; font-size:1rem; color:#0d47a1; }
  .section-body { padding:1rem; }
  .brand-accent { color:#0d47a1; }
  .btn-primary-gradient { background: linear-gradient(90deg,#0d6efd,#0bb1ff); border:none; }
  .btn-primary-gradient:hover { filter: brightness(0.98); }
  .muted { color:#6c757d; }
  .chip { display:inline-flex; align-items:center; background:#eef7ff; color:#0d47a1; border:1px solid #d6ecff; border-radius:999px; padding:.15rem .5rem; font-size:.75rem; margin-right:.25rem; margin-top:.25rem; }
  .counter { font-size:.8rem; color:#6c757d; }
  .collapsible-toggle { margin-left:auto; background:transparent; border:0; color:#0d47a1; }
  .chevron { transition: transform .2s ease; }
  .chevron.rotate { transform: rotate(180deg); }
</style>

<div class="container mt-4">
  <div class="card tabs-card shadow-soft">
    <div class="card-header bg-info text-white">
      <h3 class="mb-0 d-flex align-items-center"><i class="bi bi-cash-coin me-2"></i>Finance Messaging</h3>
    </div>
    <div class="card-body">
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3" id="financeTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="send-tab" data-bs-toggle="tab" data-bs-target="#send-pane" type="button" role="tab" aria-controls="send-pane" aria-selected="true">
            <i class="bi bi-send me-1"></i> Send Messages
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-pane" type="button" role="tab" aria-controls="history-pane" aria-selected="false">
            <i class="bi bi-clock-history me-1"></i> Message History
          </button>
        </li>
      </ul>

      <div class="tab-content" id="financeTabsContent">
        <!-- Send Messages Pane -->
        <div class="tab-pane fade show active" id="send-pane" role="tabpanel" aria-labelledby="send-tab">
          <form method="post" id="finance-messaging-form" autocomplete="off">
            {% csrf_token %}
            <div id="email-feedback"></div>
            {% csrf_token %}

            <div class="section-card mb-3">
              <div class="section-header">
                <i class="bi bi-funnel-fill brand-accent"></i>
                <h6 class="title">Filters</h6>
                <button type="button" class="collapsible-toggle" id="filtersToggle" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="false" aria-controls="filtersCollapse" title="Collapse/Expand">
                  <i class="bi bi-chevron-down chevron rotate" id="filtersChevron"></i>
                </button>
              </div>
              <div id="filtersCollapse" class="collapse">
              <div class="section-body">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">Minimum Balance</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="bi bi-currency-exchange"></i></span>
                      {{ form.min_balance }}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Maximum Balance</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="bi bi-cash-stack"></i></span>
                      {{ form.max_balance }}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Class</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="bi bi-people"></i></span>
                      {{ form.class_group }}
                    </div>
                  </div>
                </div>
                <div class="d-flex gap-2 btn-group-flex mt-3">
                  <button type="submit" class="btn btn-secondary"><i class="bi bi-funnel me-1"></i> Apply Filters</button>
                  <button type="button" class="btn btn-outline-secondary" onclick="window.location.href=window.location.pathname"><i class="bi bi-x-circle me-1"></i> Reset Filters</button>
                </div>
              </div>
              </div>
            </div>

            {% if show_full_form %}
            <div class="section-card">
              <div class="section-header">
                <i class="bi bi-pencil-square brand-accent"></i>
                <h6 class="title">Compose</h6>
              </div>
              <div class="section-body">
                <div class="mb-3">
                  <label class="form-label">Recipients</label>
                  {{ form.recipient }}
                  <div class="d-flex justify-content-between mt-1">
                    <div class="help-text">Hold Ctrl (Windows) or Cmd (Mac) to select multiple students.</div>
                    <div class="counter" id="recipients-count"></div>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Subject/Title</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-type"></i></span>
                    {{ form.subject }}
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Message</label>
                  {{ form.message }}
                  <div class="d-flex justify-content-between mt-1">
                    <button type="button" id="regenerate-msg-btn" class="btn btn-outline-info btn-sm"><i class="bi bi-magic"></i> Regenerate Message</button>
                    <div class="counter" id="message-count"></div>
                  </div>
                </div>
                <div class="row g-3 align-items-center mb-2">
                  <div class="col-auto">
                    <div class="form-check">
                      {{ form.send_email }} {{ form.send_email.label_tag }}
                    </div>
                  </div>
                  <div class="col-auto">
                    <div class="form-check">
                      {{ form.send_sms }} {{ form.send_sms.label_tag }}
                    </div>
                  </div>
                </div>
                <div class="sticky-actions pt-2">
                  <button type="submit" class="btn btn-primary-gradient btn-lg" id="send-btn"><i class="bi bi-envelope-paper me-1"></i> Send Message</button>
                </div>
              </div>
            </div>
            {% endif %}
          </form>
        </div>

        <!-- History Pane -->
        <div class="tab-pane fade" id="history-pane" role="tabpanel" aria-labelledby="history-tab">
          <div class="card shadow-soft">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Finance Message History</h5>
            </div>
            <div class="card-body p-0">
              {% if message_history and message_history|length > 0 %}
                <div class="table-responsive history-scroll">
                  <table class="table table-striped table-hover mb-0 table-sticky">
                    <thead class="table-light">
                      <tr>
                        <th>Recipient</th>
                        <th>Message Preview</th>
                        <th>Sent By</th>
                        <th>Sent At</th>
                        <th>Type</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for msg in message_history %}
                      <tr>
                        <td>{{ msg.recipient.get_full_name|default:msg.recipient.username }}</td>
                        <td>
                          <span title="{{ msg.message_content|linebreaksbr }}">
                            {{ msg.message_content|truncatechars:60 }}
                          </span>
                        </td>
                        <td>{{ msg.sent_by.get_full_name|default:msg.sent_by.username }}</td>
                        <td>{{ msg.sent_at|date:'Y-m-d H:i' }}</td>
                        <td>{{ msg.delivery_method|upper }}</td>
                        <td>
                          {% if msg.status == 'sent' %}
                            <span class="badge badge-soft-success">Sent</span>
                          {% else %}
                            <span class="badge badge-soft-danger">Failed</span>
                            <div class="small text-danger mt-1">{{ msg.status }}</div>
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="alert alert-info m-3 mb-0">No finance messages have been sent yet.</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SMS Logs Modal -->
<div class="modal fade" id="smsLogsModal" tabindex="-1" aria-labelledby="smsLogsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title d-flex align-items-center gap-2" id="smsLogsModalLabel">
          <i class="bi bi-chat-dots"></i>
          <span>Bulk SMS Logs</span>
          <span id="smsLogsStatus" class="ms-2 text-muted small"></span>
        </h5>
        <button type="button" class="btn-close" id="smsLogsCloseBtn" data-bs-dismiss="modal" aria-label="Close" disabled></button>
      </div>
      <div class="modal-body">
        <div id="smsSendingSpinner" class="d-none mb-2">
          <div class="d-flex align-items-center gap-2 text-info">
            <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
            <span>Sending... Please wait</span>
          </div>
        </div>
        <div id="smsProgressWrap" class="mb-2">
          <div class="d-flex justify-content-between small mb-1">
            <span id="smsProgressText">0% sent</span>
            <span id="smsCountsText">0/0</span>
          </div>
          <div class="progress" style="height:6px;">
            <div class="progress-bar bg-primary" id="smsProgressBar" role="progressbar" style="width: 0%"></div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Recipient</th>
                <th>Phone</th>
                <th>Status</th>
                <th>Preview</th>
              </tr>
            </thead>
            <tbody id="smsLogsBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-primary" id="resendFailedBtn" disabled>
          <i class="bi bi-arrow-repeat me-1"></i>Resend Failed
        </button>
        <button type="button" class="btn btn-secondary" id="smsLogsFooterCloseBtn" data-bs-dismiss="modal" disabled>Close</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var form = document.getElementById('finance-messaging-form');
    var feedbackDiv = document.getElementById('email-feedback');
    var sendBtn = document.getElementById('send-btn');
    var lastSentSubject = '';
    var lastSentMessage = '';
    var lastSmsLogs = [];
    // Modal elements for live progress
    var modalEl = document.getElementById('smsLogsModal');
    // Bootstrap instance if available
    var modalInstance = null;
    try {
      if (modalEl && window.bootstrap && bootstrap.Modal) {
        modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl, { backdrop: 'static', keyboard: false });
      }
    } catch (e) { modalInstance = null; }
    // Fallback show/hide if Bootstrap JS not present
    function forceShowModal() {
      if (!modalEl) return;
      modalEl.classList.add('show');
      modalEl.style.display = 'block';
      document.body.classList.add('modal-open');
      // add simple backdrop if not exists
      if (!document.querySelector('.modal-backdrop')) {
        var bd = document.createElement('div');
        bd.className = 'modal-backdrop fade show';
        document.body.appendChild(bd);
      }
    }
    function forceHideModal() {
      if (!modalEl) return;
      modalEl.classList.remove('show');
      modalEl.style.display = 'none';
      document.body.classList.remove('modal-open');
      var bd = document.querySelector('.modal-backdrop');
      if (bd) bd.parentNode.removeChild(bd);
    }
    function showModalLocked() {
      if (modalInstance) { modalInstance.show(); }
      else { forceShowModal(); }
    }
    function unlockModalControls() {
      if (modalCloseBtn) modalCloseBtn.disabled = false;
      if (modalFooterCloseBtn) modalFooterCloseBtn.disabled = false;
    }
    function lockModalControls() {
      if (modalCloseBtn) modalCloseBtn.disabled = true;
      if (modalFooterCloseBtn) modalFooterCloseBtn.disabled = true;
    }
    var spinner = document.getElementById('smsSendingSpinner');
    var statusEl = document.getElementById('smsLogsStatus');
    var tbodyEl = document.getElementById('smsLogsBody');
    var modalCloseBtn = document.getElementById('smsLogsCloseBtn');
    var modalFooterCloseBtn = document.getElementById('smsLogsFooterCloseBtn');
    var modalResendBtn = document.getElementById('resendFailedBtn');
    // progress elements
    var progressBar = document.getElementById('smsProgressBar');
    var progressText = document.getElementById('smsProgressText');
    var countsText = document.getElementById('smsCountsText');
    function setProgress(sent, total) {
      sent = Math.max(0, Math.min(sent || 0, total || 0));
      total = Math.max(0, total || 0);
      var pct = total ? Math.round((sent / total) * 100) : 0;
      if (progressBar) progressBar.style.width = pct + '%';
      if (progressText) progressText.textContent = pct + '% sent';
      if (countsText) countsText.textContent = sent + '/' + total;
    }
    // Redundant safety: ensure modal pops on button click instantly
    if (sendBtn) {
      sendBtn.addEventListener('click', function() {
        if (tbodyEl) tbodyEl.innerHTML = '';
        if (statusEl) statusEl.textContent = 'Processing...';
        if (spinner) spinner.classList.remove('d-none');
        lockModalControls();
        if (modalResendBtn) modalResendBtn.disabled = true;
        showModalLocked();
        setProgress(0, 0);
      });
    }
    if(form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            // Show modal immediately upon clicking send
            if (tbodyEl) tbodyEl.innerHTML = '';
            if (statusEl) statusEl.textContent = 'Processing...';
            if (spinner) spinner.classList.remove('d-none');
            if (modalCloseBtn) modalCloseBtn.disabled = true;
            if (modalFooterCloseBtn) modalFooterCloseBtn.disabled = true;
            if (modalResendBtn) modalResendBtn.disabled = true;
            showModalLocked();
            // Prefill table with selected recipients and start progress ticker
            var recipientsSelect = document.getElementById('id_recipient');
            var selectedOptions = Array.from((recipientsSelect && recipientsSelect.selectedOptions) || []);
            var queued = selectedOptions.map(function(opt){
              return { user_id: opt.value, recipient: opt.text, phone: '', status: 'Queued' };
            });
            if (queued.length && tbodyEl) {
              tbodyEl.innerHTML = '';
              queued.forEach(function(item, idx){
                var tr = document.createElement('tr');
                tr.setAttribute('data-user-id', item.user_id || '');
                tr.innerHTML = `
                  <td>${idx + 1}</td>
                  <td>${item.recipient}</td>
                  <td>${item.phone}</td>
                  <td><span class="badge bg-secondary">Queued</span></td>
                  <td><span title="Waiting to send..."> — </span></td>
                `;
                tbodyEl.appendChild(tr);
              });
            }
            // initialize progress
            var totalRecipients = queued.length;
            var approxSent = 0;
            setProgress(0, totalRecipients);
            // live ticker for current/next
            var tickerIdx = 0;
            var tickerTimer = null;
            function updateTicker() {
              var rows = Array.from(document.querySelectorAll('#smsLogsBody tr'));
              rows.forEach(function(r){
                var badge = r.querySelector('.badge');
                if (badge) { badge.className = 'badge bg-secondary'; badge.textContent = 'Queued'; }
              });
              if (!rows.length) return;
              var current = rows[tickerIdx % rows.length];
              var next = rows[(tickerIdx + 1) % rows.length];
              var cBadge = current.querySelector('.badge');
              if (cBadge) { cBadge.className = 'badge bg-info'; cBadge.textContent = 'Sending…'; }
              var cName = current.children[1] ? current.children[1].textContent : '';
              var nName = next && next.children[1] ? next.children[1].textContent : '';
              if (statusEl) statusEl.textContent = `Sending ${((tickerIdx%rows.length)+1)}/${rows.length}: ${cName}${nName? ' • Next: ' + nName : ''}`;
              tickerIdx += 1;
              approxSent = Math.max(0, Math.min(tickerIdx - 1, totalRecipients));
              setProgress(approxSent, totalRecipients);
            }
            if (!window.__smsTickerRunning) {
              updateTicker();
              tickerTimer = setInterval(updateTicker, 1200);
              window.__smsTickerRunning = true;
              window.__smsTickerHandle = tickerTimer;
            }
            var recipients = document.getElementById('id_recipient');
            if (recipients && recipients.selectedOptions.length === 0) {
                feedbackDiv.innerHTML = '<div class="alert alert-warning">Please select at least one recipient.</div>';
                // reflect validation failure in modal too
                if (statusEl) statusEl.textContent = 'Validation required: select at least one recipient';
                if (spinner) spinner.classList.add('d-none');
                unlockModalControls();
                if (window.__smsTickerHandle){ clearInterval(window.__smsTickerHandle); window.__smsTickerRunning = false; }
                return false;
            }
            var formData = new FormData(form);
            // capture the latest subject/message for potential resend
            lastSentSubject = (form.querySelector('#id_subject') || {}).value || '';
            lastSentMessage = (form.querySelector('#id_message') || {}).value || '';
            feedbackDiv.innerHTML = '';
            sendBtn.disabled = true;
            // Update status to sending after validation passes
            if (statusEl) statusEl.textContent = 'Sending...';
            // CSRF helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

fetch(window.location.pathname, {
    method: 'POST',
    headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': csrftoken,
    },
    body: formData
})
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    feedbackDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
                    // Populate SMS logs modal if provided
                    if (Array.isArray(data.sms_logs) && data.sms_logs.length > 0) {
                        const tbody = tbodyEl;
                        tbody.innerHTML = '';
                        lastSmsLogs = data.sms_logs || [];
                        let hasFailures = false;
                        let sentCount = 0;
                        lastSmsLogs.forEach((log, idx) => {
                          const statusBadge = (log.status && log.status.startsWith('sent'))
                            ? '<span class="badge bg-success">Sent</span>'
                            : `<span class="badge bg-danger">${log.status || 'error'}</span>`;
                          if (log.status && log.status.startsWith('sent')) { sentCount += 1; }
                          if (!(log.status && log.status.startsWith('sent'))) { hasFailures = true; }
                          const tr = document.createElement('tr');
                          tr.setAttribute('data-user-id', (log.user_id || ''));
                          tr.innerHTML = `
                            <td>${idx + 1}</td>
                            <td>${(log.recipient || '').toString()}</td>
                            <td>${(log.phone || '').toString()}</td>
                            <td>${statusBadge}</td>
                            <td><span title="${(log.message_preview || '').replace(/"/g,'&quot;')}"> ${(log.message_preview || '').slice(0,80)} </span></td>
                          `;
                          tbody.appendChild(tr);
                        });
                        if (modalResendBtn) modalResendBtn.disabled = !hasFailures;
                        setProgress(sentCount, lastSmsLogs.length);
                    } else {
                        // Fallback: no logs returned; mark existing queued rows as Completed
                        const rows = Array.from(document.querySelectorAll('#smsLogsBody tr'));
                        rows.forEach((r) => {
                          const statusCell = r.children[3];
                          if (statusCell) {
                            statusCell.innerHTML = '<span class="badge bg-success">Completed</span>';
                          }
                        });
                        if (modalResendBtn) modalResendBtn.disabled = true;
                        // assume success for all queued
                        setProgress(rows.length, rows.length);
                    }
                    // Update modal status and unlock controls
                    if (statusEl) statusEl.textContent = 'Completed';
                    if (spinner) spinner.classList.add('d-none');
                    unlockModalControls();
                    if (window.__smsTickerHandle){ clearInterval(window.__smsTickerHandle); window.__smsTickerRunning = false; }
                    form.reset();
                } else {
                    feedbackDiv.innerHTML = '<div class="alert alert-danger">' + (data.error || 'Failed to send email.') + '</div>';
                    if (statusEl) statusEl.textContent = 'Failed';
                    if (spinner) spinner.classList.add('d-none');
                    unlockModalControls();
                    if (window.__smsTickerHandle){ clearInterval(window.__smsTickerHandle); window.__smsTickerRunning = false; }
                }
                sendBtn.disabled = false;
            })
            .catch(error => {
                feedbackDiv.innerHTML = '<div class="alert alert-danger">Error sending email. Please try again.</div>';
                if (statusEl) statusEl.textContent = 'Error';
                if (spinner) spinner.classList.add('d-none');
                unlockModalControls();
                if (window.__smsTickerHandle){ clearInterval(window.__smsTickerHandle); window.__smsTickerRunning = false; }
                sendBtn.disabled = false;
            });
        });
    }
});
</script>
<script>
// Resend failed SMS from the modal
document.addEventListener('DOMContentLoaded', function() {
  const resendBtn = document.getElementById('resendFailedBtn');
  if (!resendBtn) return;

  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }

  resendBtn.addEventListener('click', function() {
    // lock controls and show spinner while resending
    const modalCloseBtn = document.getElementById('smsLogsCloseBtn');
    const modalFooterCloseBtn = document.getElementById('smsLogsFooterCloseBtn');
    const spinner = document.getElementById('smsSendingSpinner');
    const statusEl = document.getElementById('smsLogsStatus');
    if (statusEl) statusEl.textContent = 'Resending failed messages...';
    if (spinner) spinner.classList.remove('d-none');
    if (modalCloseBtn) modalCloseBtn.disabled = true;
    if (modalFooterCloseBtn) modalFooterCloseBtn.disabled = true;
    const rows = Array.from(document.querySelectorAll('#smsLogsBody tr'));
    const failedIds = rows
      .filter(r => r.querySelector('.badge.bg-danger'))
      .map(r => r.getAttribute('data-user-id'))
      .filter(Boolean);
    if (failedIds.length === 0) return;

    const csrftoken = getCookie('csrftoken');
    resendBtn.disabled = true;
    fetch('/finance_messaging/resend-failed/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': csrftoken,
      },
      body: JSON.stringify({ user_ids: failedIds, subject: (window.lastSentSubject || ''), message: (window.lastSentMessage || '') })
    })
    .then(r => r.json())
    .then(data => {
      if (data && data.success && Array.isArray(data.sms_logs)) {
        const tbody = document.getElementById('smsLogsBody');
        tbody.innerHTML = '';
        let hasFailures = false;
        let sentCount = 0;
        data.sms_logs.forEach((log, idx) => {
          const statusBadge = (log.status && log.status.startsWith('sent'))
              ? '<span class="badge bg-success">Sent</span>'
              : `<span class="badge bg-danger">${log.status || 'error'}</span>`;
          if (log.status && log.status.startsWith('sent')) { sentCount += 1; }
          if (!(log.status && log.status.startsWith('sent'))) { hasFailures = true; }
          const tr = document.createElement('tr');
          tr.setAttribute('data-user-id', (log.user_id || ''));
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${(log.recipient || '').toString()}</td>
            <td>${(log.phone || '').toString()}</td>
            <td>${statusBadge}</td>
            <td><span title="${(log.message_preview || '').replace(/"/g,'&quot;')}"> ${(log.message_preview || '').slice(0,80)} </span></td>
          `;
          tbody.appendChild(tr);
        });
        resendBtn.disabled = !hasFailures;
        if (statusEl) statusEl.textContent = 'Resend complete';
        if (spinner) spinner.classList.add('d-none');
        if (modalCloseBtn) modalCloseBtn.disabled = false;
        if (modalFooterCloseBtn) modalFooterCloseBtn.disabled = false;
        setProgress(sentCount, data.sms_logs.length);
      } else {
        // Fallback: no logs returned; mark existing queued rows as Completed
        const rows = Array.from(document.querySelectorAll('#smsLogsBody tr'));
        rows.forEach((r) => {
          const statusCell = r.children[3];
          if (statusCell) {
            statusCell.innerHTML = '<span class="badge bg-success">Completed</span>';
          }
        });
        resendBtn.disabled = false;
        if (statusEl) statusEl.textContent = 'Resend failed';
        if (spinner) spinner.classList.add('d-none');
        if (modalCloseBtn) modalCloseBtn.disabled = false;
        if (modalFooterCloseBtn) modalFooterCloseBtn.disabled = false;
        setProgress(rows.length, rows.length);
      }
    })
    .catch(() => { 
      resendBtn.disabled = false; 
      if (statusEl) statusEl.textContent = 'Resend error';
      if (spinner) spinner.classList.add('d-none');
      if (modalCloseBtn) modalCloseBtn.disabled = false;
      if (modalFooterCloseBtn) modalFooterCloseBtn.disabled = false;
    });
  });

  // expose last subject/message captured in submit handler to window for reuse
  document.addEventListener('submit', function() {
    const subj = document.querySelector('#id_subject');
    const msg = document.querySelector('#id_message');
    window.lastSentSubject = subj ? subj.value : '';
    window.lastSentMessage = msg ? msg.value : '';
  }, true);
});
</script>
<script>
// Regenerate message templates support
const messageTemplates = [
  `Dear Parent/Guardian,\n\nOur records indicate that {student_name} (Admission No: {admission_no}) has an outstanding fee balance of Ksh. {fee_balance}. Kindly clear the arrears at your earliest convenience.\n\nThank you.\nSchool Administration`,
  `Attention: Outstanding Fees\n\nThis is to notify you that {student_name} (Admission No: {admission_no}) currently has a fee balance of Ksh. {fee_balance}. Please arrange payment as soon as possible.\n\nRegards,\nFinance Office`,
  `Dear Parent/Guardian,\n\nPlease note that {student_name} (Admission Number: {admission_no}) has an unpaid balance of Ksh. {fee_balance}. Your prompt action will be appreciated.\n\nThank you.\nAccounts Department`,
  `Hello,\n\nWe wish to remind you that {student_name} (Admission No: {admission_no}) has a pending fee balance of Ksh. {fee_balance}. Kindly settle this amount at your earliest convenience.\n\nBest regards,\nSchool Management`,
  `Fee Reminder\n\n{student_name} (Admission No: {admission_no}) has an outstanding balance of Ksh. {fee_balance}. Please clear the balance to avoid any interruptions.\n\nThank you.\nSchool Bursar`
];
document.addEventListener('DOMContentLoaded', function() {
  const regenBtn = document.getElementById('regenerate-msg-btn');
  const msgBox = document.getElementById('id_message');
  if (regenBtn && msgBox) {
    regenBtn.addEventListener('click', function() {
      const idx = Math.floor(Math.random() * messageTemplates.length);
      msgBox.value = messageTemplates[idx];
    });
  }
});
</script>
<script>
// Display selected students' class/stream dynamically
const studentSelect = document.getElementById('id_students');
const classInfoDiv = document.getElementById('student-class-info');
if (studentSelect) {
    studentSelect.addEventListener('change', function() {
        let selected = Array.from(studentSelect.selectedOptions).map(opt => opt.text);
        classInfoDiv.innerHTML = selected.length ? '<b>Selected:</b><br>' + selected.join('<br>') : '';
    });
}
</script>
<script>
// Counters for recipients and message length
document.addEventListener('DOMContentLoaded', function() {
  const recipientsSelect = document.getElementById('id_recipient');
  const recipientsCount = document.getElementById('recipients-count');
  const messageBox = document.getElementById('id_message');
  const messageCount = document.getElementById('message-count');

  function updateRecipientsCount() {
    if (!recipientsSelect || !recipientsCount) return;
    const count = Array.from(recipientsSelect.selectedOptions || []).length;
    recipientsCount.textContent = count ? `${count} selected` : '';
  }

  function updateMessageCount() {
    if (!messageBox || !messageCount) return;
    const len = (messageBox.value || '').length;
    messageCount.textContent = `${len} chars`;
  }

  if (recipientsSelect) {
    recipientsSelect.addEventListener('change', updateRecipientsCount);
    updateRecipientsCount();
  }
  if (messageBox) {
    messageBox.addEventListener('input', updateMessageCount);
    updateMessageCount();
  }
});
</script>
<script>
// Persist Filters collapse state and rotate chevron
document.addEventListener('DOMContentLoaded', function() {
  const collapseEl = document.getElementById('filtersCollapse');
  const toggleBtn = document.getElementById('filtersToggle');
  const chevron = document.getElementById('filtersChevron');
  if (!collapseEl || !toggleBtn) return;

  const saved = localStorage.getItem('financeFiltersCollapsed');
  const wantCollapsed = saved === 'true';
  if (wantCollapsed) {
    collapseEl.classList.remove('show');
    toggleBtn.setAttribute('aria-expanded','false');
    if (chevron) chevron.classList.add('rotate');
  }

  // Ensure using Bootstrap Collapse without auto-toggling
  const instance = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });

  collapseEl.addEventListener('hidden.bs.collapse', () => {
    localStorage.setItem('financeFiltersCollapsed','true');
    if (chevron) chevron.classList.add('rotate');
  });
  collapseEl.addEventListener('shown.bs.collapse', () => {
    localStorage.setItem('financeFiltersCollapsed','false');
    if (chevron) chevron.classList.remove('rotate');
  });
});
</script>
{% endblock %}

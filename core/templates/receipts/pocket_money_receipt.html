{% extends 'base.html' %}
{% load static %}

{% block title %}Pocket Money Receipt{% endblock %}

{% block content %}
<div class="container py-3">
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-3">
        {% if site_settings and site_settings.logo %}
          <img src="{{ site_settings.logo.url }}" alt="Logo" style="height:40px;"/>
        {% endif %}
        <div>
          <h5 class="mb-0">Pocket Money Receipt</h5>
          <small class="text-muted">Generated {{ generated_at|date:'Y-m-d H:i' }}</small>
        </div>
      </div>
      <a href="?print=1" target="_blank" class="btn btn-outline-primary btn-sm"><i class="bi bi-printer"></i> Print</a>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="fw-semibold">Student</div>
          <div>{{ transaction.student.user.get_full_name|default:transaction.student.user.username }}</div>
          <div class="text-muted small">Adm: {{ transaction.student.admission_no }}{% if transaction.student.class_group %} â€¢ Class: {{ transaction.student.class_group }}{% endif %}</div>
        </div>
        <div class="col-md-6 text-md-end">
          <div class="fw-semibold">Reference</div>
          <div>{{ transaction.reference|default:'N/A' }}</div>
          <div class="text-muted small">Date: {{ transaction.transaction_date|date:'Y-m-d H:i' }}</div>
        </div>
      </div>

      <div class="table-responsive mb-3">
        <table class="table table-sm">
          <tbody>
            <tr>
              <th style="width:220px">Type</th>
              <td>{{ transaction.get_transaction_type_display }}</td>
            </tr>
            <tr>
              <th>Amount</th>
              <td>
                {% if transaction.transaction_type == 'withdrawal' %}-{% endif %}KES {{ transaction.amount|floatformat:2 }}
              </td>
            </tr>
            {% if transaction.description %}
            <tr>
              <th>Description</th>
              <td>{{ transaction.description }}</td>
            </tr>
            {% endif %}
            <tr>
              <th>Status</th>
              <td>{{ transaction.get_status_display }}</td>
            </tr>
            {% if transaction.processed_by %}
            <tr>
              <th>Processed By</th>
              <td>{{ transaction.processed_by.get_full_name|default:transaction.processed_by.username }}</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="text-muted small">Recorded on {{ transaction.transaction_date|date:'Y-m-d H:i' }}</div>
    </div>
  </div>
</div>

<style>
@media print {
  @page { size: A4; margin: 10mm; }
  html, body { width: 210mm; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  body, table, th, td, div, span, small { font-size: 11px !important; line-height: 1.3 !important; }
  h5 { font-size: 16px !important; margin: 0 0 6px 0 !important; }
  .navbar, .sidebar, .footer, header, footer, .btn { display:none !important; }
  .card { margin:0 !important; padding:0 !important; box-shadow:none !important; border: none; page-break-inside: avoid !important; }
  table.table { margin-bottom: 8px !important; border-collapse: collapse !important; }
  table.table th, table.table td { padding: 4px 6px !important; vertical-align: middle !important; }
  table, thead, tbody, tfoot, tr, td, th { page-break-inside: avoid !important; }
  /* Hide any floating action buttons or widgets */
  .fab, .float, .floating, .floating-buttons, .fixed-action-btn, .speed-dial,
  .quick-actions, .chat-widget, .chatbot-launcher, .whatsapp-chat,
  [class*="floating"], [class*="fab"], [class*="speed-dial"], [class*="quick"],
  .position-fixed, .fixed, [style*="position: fixed"], [style*="position:fixed"] {
    display: none !important;
    visibility: hidden !important;
  }
  /* no default scaling; only JS scales slightly if needed */
}
</style>
<script>
(function(){
  function hideFloating() {
    try {
      var all = document.getElementsByTagName('*');
      for (var i=0; i<all.length; i++) {
        var el = all[i];
        var cs = window.getComputedStyle(el);
        var cls = (el.className || '').toString();
        if (cs.position === 'fixed' || /floating|fab|speed-dial|quick-actions|chat|whatsapp|launcher|float/gi.test(cls)) {
          el.style.setProperty('display','none','important');
          el.style.setProperty('visibility','hidden','important');
        }
      }
    } catch(e) {}
  }
  function fitToOnePage(){
    var root = document.querySelector('.container');
    if(!root) return;
    root.style.transformOrigin = 'top left';
    root.style.transform = 'scale(1)';
    var target = 1122 - 46; // printable height px
    var rect = root.getBoundingClientRect();
    var h = rect.height;
    if(h > target && h > 0){
      var scale = target / h; if (scale < 0.75) scale = 0.75;
      root.style.transform = 'scale(' + scale + ')';
    }
  }
  hideFloating();
  window.addEventListener('load', function(){ hideFloating(); setTimeout(fitToOnePage, 50); });
  window.addEventListener('beforeprint', function(){ hideFloating(); fitToOnePage(); });
})();
</script>
{% endblock %}

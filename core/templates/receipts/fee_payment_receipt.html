{% extends 'base.html' %}
{% load static %}

{% block title %}Fee Payment Receipt{% endblock %}

{% block content %}
<div id="receipt-root" class="container py-3">
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-3">
        {% if site_settings and site_settings.logo %}
          <img src="{{ site_settings.logo.url }}" alt="Logo" style="height:40px;"/>
        {% endif %}
        <div>
          <h5 class="mb-0">Fee Payment Receipt</h5>
          <small class="text-muted">Generated {{ generated_at|date:'Y-m-d H:i' }}</small>
          {% if relevant_term %}
            <div class="small">Term: {{ relevant_term.name }} - {{ relevant_term.academic_year.year }}</div>
          {% endif %}
        </div>
      </div>
      <a href="?print=1" target="_blank" class="btn btn-outline-primary btn-sm"><i class="bi bi-printer"></i> Print</a>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="fw-semibold">Payer</div>
          <div>{{ payment.student.user.get_full_name|default:payment.student.user.username }}</div>
          <div class="text-muted small">Adm: {{ payment.student.admission_no }}{% if payment.student.class_group %} • Class: {{ payment.student.class_group }}{% endif %}</div>
        </div>
        <div class="col-md-6 text-md-end">
          <div class="fw-semibold">Receipt No.</div>
          <div>{{ payment.reference|default:'N/A' }}</div>
          <div class="text-muted small">Date: {{ payment.payment_date|date:'Y-m-d H:i' }}</div>
        </div>
      </div>

      <div class="table-responsive mb-4">
        <table class="table table-sm">
          <tbody>
            <tr>
              <th style="width:220px">Amount Paid</th>
              <td>KES {{ payment.amount_paid|floatformat:2 }}</td>
            </tr>
            <tr>
              <th>Payment Method</th>
              <td>{{ payment.payment_method|default:'N/A' }}</td>
            </tr>
            <tr>
              <th>Status</th>
              <td>{{ payment.get_status_display }}</td>
            </tr>
            {% if payment.phone_number %}
            <tr>
              <th>Phone Number</th>
              <td>{{ payment.phone_number }}</td>
            </tr>
            {% endif %}
            {% if payment.mpesa_transaction %}
            <tr>
              <th>M-Pesa Checkout ID</th>
              <td>{{ payment.mpesa_transaction.checkout_request_id }}</td>
            </tr>
            <tr>
              <th>M-Pesa Receipt</th>
              <td>{{ payment.mpesa_transaction.mpesa_receipt }}</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <h6 class="fw-semibold">Term Fee Breakdown</h6>
      <div class="table-responsive">
        <table class="table table-bordered table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Category</th>
              <th class="text-end">Assigned</th>
              <th class="text-end">Paid Before</th>
              <th class="text-end">This Payment</th>
              <th class="text-end">Paid After</th>
              <th class="text-end">Balance</th>
            </tr>
          </thead>
          <tbody>
            {% for row in assignment_rows %}
            <tr>
              <td>{{ row.category }}</td>
              <td class="text-end">KES {{ row.assigned|floatformat:2 }}</td>
              <td class="text-end">KES {{ row.paid_before|floatformat:2 }}</td>
              <td class="text-end">KES {{ row.this_payment|floatformat:2 }}</td>
              <td class="text-end">KES {{ row.paid_after|floatformat:2 }}</td>
              <td class="text-end">KES {{ row.balance|floatformat:2 }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted">No fee assignments found for this term.</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot class="table-light">
            <tr>
              <th>Total</th>
              <th class="text-end">KES {{ assigned_total|floatformat:2 }}</th>
              <th></th>
              <th></th>
              <th class="text-end">KES {{ paid_total_after|floatformat:2 }}</th>
              <th class="text-end">KES {{ balance_total|floatformat:2 }}</th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="text-muted small">
        Processed by: {% if payment.mpesa_transaction and payment.mpesa_transaction.updated_at %}{{ payment.mpesa_transaction.updated_at|date:'Y-m-d H:i' }}{% else %}{{ payment.payment_date|date:'Y-m-d H:i' }}{% endif %}
      </div>
    </div>
  </div>
</div>

<style>
/* Hide site floating widgets on receipt pages */
.fab, .float, .floating, .floating-buttons, .fixed-action-btn, .speed-dial,
.quick-actions, .chat-widget, .chatbot-launcher, .whatsapp-chat,
[class*="floating"], [class*="speed-dial"], [class*="quick-actions"],
.position-fixed.float, .position-fixed.fab { display:none !important; }

@media print {
  @page { size: A4; margin: 10mm; }
  html, body { width: 210mm; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  html, body { height: auto !important; overflow: hidden !important; }
  body { margin: 0 !important; }
  body, table, th, td, div, span, small { font-size: 11px !important; line-height: 1.3 !important; }
  h5 { font-size: 16px !important; margin: 0 0 6px 0 !important; }
  .container { padding: 0 !important; margin: 0 !important; max-width: 100% !important; }
  .card { margin: 0 !important; padding: 0 !important; page-break-inside: avoid !important; page-break-before: avoid !important; page-break-after: avoid !important; box-shadow:none !important; border: none; }
  #receipt-root { page-break-inside: avoid !important; page-break-before: avoid !important; page-break-after: avoid !important; max-height: calc(297mm - 20mm); overflow: hidden !important; }
  .card-header { padding: 6px 8px !important; }
  .card-body { padding: 10px !important; }
  table.table { margin-bottom: 8px !important; border-collapse: collapse !important; }
  table.table th, table.table td { padding: 4px 6px !important; vertical-align: middle !important; }
  table, thead, tbody, tfoot, tr, td, th { page-break-inside: avoid !important; }
  /* shrink logo */
  .card-header img { height: 32px !important; }
  .badge, .btn, .navbar, .sidebar, .footer, header, footer { display:none !important; }
  .navbar, .sidebar, .footer, header, footer, .btn { display:none !important; }
  .card { box-shadow:none !important; border: none; }
  /* Hide any floating action buttons or widgets */
  .fab, .float, .floating, .floating-buttons, .fixed-action-btn, .speed-dial,
  .quick-actions, .chat-widget, .chatbot-launcher, .whatsapp-chat,
  [class*="floating"], [class*="fab"], [class*="speed-dial"], [class*="quick"],
  .position-fixed, .fixed, [style*="position: fixed"], [style*="position:fixed"] {
    display: none !important;
    visibility: hidden !important;
  }
}
</style>
<script>
(function(){
  function hideFloating() {
    try {
      var all = document.getElementsByTagName('*');
      for (var i=0; i<all.length; i++) {
        var el = all[i];
        var cs = window.getComputedStyle(el);
        var cls = (el.className || '').toString();
        if (
          cs.position === 'fixed' ||
          /floating|fab|speed-dial|quick-actions|chat|whatsapp|launcher|float/gi.test(cls)
        ) {
          el.setAttribute('data-hidden-by-receipt', '1');
          el.style.setProperty('display','none','important');
          el.style.setProperty('visibility','hidden','important');
        }
      }
    } catch(e) {}
  }
  hideFloating();
  window.addEventListener('load', hideFloating);
  window.addEventListener('beforeprint', hideFloating);
})();
</script>
<script>
(function(){
  function fitToOnePage(){
    var root = document.getElementById('receipt-root');
    if(!root) return;
    // Reset transform for accurate measurement
    root.style.transformOrigin = 'top left';
    root.style.transform = 'scale(1)';
    // Approx A4 printable height at 96dpi (~1122px) minus 10mm margins top/bottom (~38px each)
    var target = 1122 - 80; // ≈ 1042px
    var rect = root.getBoundingClientRect();
    var h = rect.height;
    if(h > target && h > 0){
      var scale = target / h;
      // Clamp minimum to avoid noticeable shrinking
      if (scale < 0.9) scale = 0.9;
      root.style.transform = 'scale(' + scale + ')';
    }
  }
  window.addEventListener('load', function(){ setTimeout(fitToOnePage, 50); });
  window.addEventListener('beforeprint', fitToOnePage);
})();
</script>
{% endblock %}

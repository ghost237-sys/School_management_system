{% extends 'base.html' %}
{% load static %}
{% block title %}Exams | Admin{% endblock %}

{% block extra_css %}
<style>
    /* Custom FullCalendar styling - Column Layout */
    #exam-calendar {
        max-height: 450px;
        width: 100%;

        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }
    
    .fc-event-exam {
        background-color: #0d47a1 !important;
        border-color: #0d47a1 !important;
        color: white !important;
        font-size: 11px;
    }
    
    .fc-event-exam:hover {
        background-color: #1565c0 !important;
        border-color: #1565c0 !important;
    }
    
    .fc-daygrid-event {
        border-radius: 3px;
        padding: 1px 3px;
        margin: 1px 0;
    }
    
    .fc-toolbar {
        padding: 8px 12px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    
    .fc-toolbar-title {
        color: #0d47a1 !important;
        font-weight: 600;
        font-size: 1.1em;
    }
    
    .fc-button-primary {
        background-color: #0d47a1 !important;
        border-color: #0d47a1 !important;
        padding: 4px 8px;
        font-size: 12px;
    }
    
    .fc-button-primary:hover {
        background-color: #1565c0 !important;
        border-color: #1565c0 !important;
    }
    
    .fc-daygrid-day {
        min-height: 60px;
    }
    
    .fc-col-header-cell {
        padding: 6px 4px;
        font-size: 12px;
        font-weight: 600;
    }
    
    /* Prevent horizontal scrolling */
    body {
        overflow-x: hidden;
    }
    
    .container-fluid {
        max-width: 100vw;
        padding-left: 15px;
        padding-right: 15px;
    }
    
    /* Responsive table adjustments */
    .table-responsive {
        border: none;
    }
    
    /* Modern subtle elevation */
    .card {
        border: 1px solid #e9ecef;
        border-radius: 12px;
        box-shadow: 0 4px 14px rgba(0,0,0,0.06);
    }

    .btn-soft-primary {
        background: #e7f1ff;
        color: #0d47a1;
        border-color: #d6e6ff;
    }

    .table thead th {
        background: #f7f9fc;
        font-weight: 600;
    }

    @media (max-width: 768px) {
        .fc-toolbar {
            flex-direction: column;
            gap: 10px;
        }
        
        .fc-toolbar-chunk {
            display: flex;
            justify-content: center;
        }
        
        .fc-button {
            padding: 3px 6px;
            font-size: 11px;
        }
    }
</style>
{% endblock %}

{% block content %}

<!-- Exams tab cleared as per user request. -->

<div class="container-fluid py-4">  
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-0"><i class="bi bi-clipboard-data me-2"></i>Exams Management</h2>
            <small class="text-muted">Create exams, view the calendar, and manage grades efficiently.</small>
        </div>
        {% if user.is_authenticated %}
            {% if user.role == 'admin' or user.is_staff or user.is_superuser %}
            <div class="d-flex gap-2">
                <a href="/admin_manage_grades/" class="btn btn-primary">
                  <i class="bi bi-journal-check me-1"></i> Manage Grades
                </a>
                <a href="{% url 'admin_block_result_slip' %}" class="btn btn-warning">
                  <i class="bi bi-shield-lock me-1"></i> Restrict Results Access
                </a>
                <div class="btn-group">
                  <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-card-text me-1"></i> Result Slips
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end" id="resultSlipsDropdown">
                    <li class="px-3 py-2 text-muted small">Loading classes...</li>
                  </ul>
                </div>
            </div>
            {% endif %}
        {% endif %}
    </div>
    <!-- Top Sticky Exams Nav -->
    <style>
      .exam-tabs-top { position: sticky; top: 0; z-index: 1020; background: #fff; padding-top: 4px; }
    </style>
    <div class="exam-tabs-top mb-3">
      <ul class="nav nav-tabs" id="examTabsTop" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="add-exam-tab-top" data-bs-toggle="tab" data-bs-target="#add-exam" type="button" role="tab" aria-controls="add-exam" aria-selected="true">Add Exam</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="available-exams-tab-top" data-bs-toggle="tab" data-bs-target="#available-exams" type="button" role="tab" aria-controls="available-exams" aria-selected="false">Available Exams</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="exam-calendar-tab-top" data-bs-toggle="tab" data-bs-target="#exam-calendar-pane" type="button" role="tab" aria-controls="exam-calendar-pane" aria-selected="false">Exam Calendar</button>
        </li>
      </ul>
    </div>

    <!-- Removed always-visible calendar/grade entry row.
         Calendar now appears only inside the "Exam Calendar" tab pane below. -->

<!-- Exam Details Modal -->
<div class="modal fade" id="examDetailModal" tabindex="-1" aria-labelledby="examDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="examDetailModalLabel">Exam Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Exam:</strong> <span id="modalExamName"></span></p>
        <p><strong>Start Date:</strong> <span id="modalExamStart"></span></p>
        <p><strong>End Date:</strong> <span id="modalExamEnd"></span></p>
        <p><strong>Term:</strong> <span id="modalExamTerm"></span></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
    <div class="card mb-4">
    <div class="card-body">
        <!-- Exam Creation Form -->
        <form method="post" class="mb-4">

    <!-- Tabs Navigation -->
    <!-- Lower nav hidden; top sticky nav controls the same panes -->
    <ul class="nav nav-tabs mb-4 d-none" id="examTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="add-exam-tab" data-bs-toggle="tab" data-bs-target="#add-exam" type="button" role="tab" aria-controls="add-exam" aria-selected="true">Add Exam</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="available-exams-tab" data-bs-toggle="tab" data-bs-target="#available-exams" type="button" role="tab" aria-controls="available-exams" aria-selected="false">Available Exams</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="exam-calendar-tab" data-bs-toggle="tab" data-bs-target="#exam-calendar-pane" type="button" role="tab" aria-controls="exam-calendar-pane" aria-selected="false">Exam Calendar</button>
      </li>
    </ul>
    <div class="tab-content" id="examTabsContent">
      <!-- Add Exam Tab -->
      <div class="tab-pane fade show active" id="add-exam" role="tabpanel" aria-labelledby="add-exam-tab">
        <div class="card mb-4">
          <div class="card-body">
            {% if exam_form.fields.term.queryset.count == 0 or exam_form.fields.term.queryset.count == None or exam_form.fields.term.queryset.count == 0 %}
              <div class="alert alert-warning mb-3">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>No terms defined!</strong> Please <a href="/admin/">add a Term</a> in the admin panel before creating exams.
              </div>
              <form method="post" class="mb-4" id="addExamFormDisabled">
                {% csrf_token %}
                <div class="form-grid row g-3">
                  {{ exam_form.as_p|safe }}
                </div>
                <div class="d-flex justify-content-end mt-2">
                  <button type="submit" name="add_exam" class="btn btn-success" disabled>
                    <i class="bi bi-plus-circle me-1"></i>Add Exam
                  </button>
                </div>
              </form>
            {% else %}
              <form method="post" class="mb-4" id="addExamForm">
                {% csrf_token %}
                <div class="form-grid row g-3">
                  {{ exam_form.as_p }}
                </div>
                <div class="d-flex justify-content-end mt-2">
                  <button type="submit" name="add_exam" class="btn btn-success">
                    <i class="bi bi-plus-circle me-1"></i>Add Exam
                  </button>
                </div>
              </form>
            {% endif %}
          </div>
        </div>
      </div>
      <!-- Available Exams Tab -->
      <div class="tab-pane fade" id="available-exams" role="tabpanel" aria-labelledby="available-exams-tab">
        <div class="card mb-4">
          <div class="card-body">
            <div id="availableExamsContainer">
              <div class="text-center p-4">
                <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                <p class="mt-2 mb-0">Loading exams...</p>
              </div>
            </div>
            <script>
            document.addEventListener('DOMContentLoaded', function(){
              const container = document.getElementById('availableExamsContainer');
              if (!container) return;
              function loadPartial() {
                const url = new URL(window.location.origin + '{% url "admin_exams_available_partial" %}');
                const params = new URLSearchParams(window.location.search);
                window._examsQuery = params.toString();
                url.search = params.toString();
                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
                  .then(r => r.text())
                  .then(html => { container.innerHTML = html; })
                  .catch(() => { container.innerHTML = '<div class="alert alert-danger">Failed to load exams.</div>'; });
              }
              // Initial load
              loadPartial();
              // Delegated pagination click
              container.addEventListener('click', function(e){
                const a = e.target.closest('a.page-link[data-page]');
                if (!a) return;
                e.preventDefault();
                const page = a.getAttribute('data-page');
                const url = new URL(window.location.origin + '{% url "admin_exams_available_partial" %}');
                const params = new URLSearchParams(window._examsQuery || window.location.search);
                params.set('page', page);
                url.search = params.toString();
                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
                  .then(r => r.text())
                  .then(html => { container.innerHTML = html; })
                  .catch(() => { container.innerHTML = '<div class="alert alert-danger">Failed to load page.</div>'; });
              });
              // Delegated submit for publish/unpublish/delete
              container.addEventListener('submit', function(e){
                const form = e.target;
                if (!form.matches('form[action*="/publish/"], form[action*="/unpublish/"], form[action*="/delete/"]')) return;
                // Respect inline confirm via onsubmit attribute; if it returns false, browser would have prevented default.
                // Here we intercept default and send via fetch.
                e.preventDefault();
                const action = form.getAttribute('action');
                const csrf = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
                fetch(action, {
                  method: 'POST',
                  headers: { 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/x-www-form-urlencoded' },
                  credentials: 'same-origin',
                  body: new URLSearchParams({ 'csrfmiddlewaretoken': csrf }).toString()
                })
                .then(async (r) => {
                  if (!r.ok) throw new Error(await r.text() || 'Request failed');
                  return loadPartial();
                })
                .catch(() => { window.location.href = window.location.href; });
              });
            });
            </script>
  <style>
    .small-hint { font-size: 12px; color: #6c757d; }
    .inline-tools { display: flex; gap: 6px; margin: 6px 0 4px; }
    .inline-tools .btn { padding: 1px 6px; font-size: 11px; }
    .char-counter { font-size: 12px; color: #6c757d; float: right; }
    /* Floating labels helper styles for legacy as_p structure */
    .form-floating-lite { position: relative; }
    .form-floating-lite > label { position: absolute; top: -8px; left: 10px; background: #fff; padding: 0 6px; font-size: 12px; color: #6c757d; }
    .with-icon { position: relative; }
    .with-icon .left-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #6c757d; }
    .with-icon input, .with-icon select { padding-left: 30px; }
    .invalid-feedback { display: none; }
    .is-invalid ~ .invalid-feedback { display: block; }
  </style>
  <script>
    // Extra UX for Add Exam inputs
    document.addEventListener('DOMContentLoaded', function(){
      const form = document.getElementById('addExamForm');
      if (!form) return;

      // Name field: placeholder, maxlength, counter, required, floating label, icon, inline validation
      const nameInput = form.querySelector('input[name*="name" i], input[name*="Name" i], input[name*="exam_name" i]') || form.querySelector('input[type="text"]');
      if (nameInput) {
        nameInput.placeholder = nameInput.placeholder || 'e.g., Mid Term 1 - 2025';
        nameInput.maxLength = nameInput.maxLength && nameInput.maxLength > 0 ? nameInput.maxLength : 100;
        nameInput.required = true;
        // floating label + icon
        const nameP = nameInput.closest('p') || nameInput.parentElement;
        if (nameP) {
          nameP.classList.add('form-floating-lite','mb-3','with-icon');
          const lbl = nameP.querySelector('label');
          if (lbl) lbl.textContent = 'Name';
          const icon = document.createElement('i');
          icon.className = 'bi bi-type left-icon';
          nameP.appendChild(icon);
        }
        // add counter
        let counter = document.createElement('small');
        counter.className = 'char-counter';
        counter.textContent = `0/${nameInput.maxLength}`;
        if (nameP) nameP.appendChild(counter);
        const updateCount = () => { counter.textContent = `${nameInput.value.length}/${nameInput.maxLength}`; };
        nameInput.addEventListener('input', updateCount); updateCount();
        // inline validation container
        const invalid = document.createElement('div');
        invalid.className = 'invalid-feedback';
        invalid.textContent = 'Please enter a name (max 100 characters).';
        if (nameP) nameP.appendChild(invalid);
      }

      // Term select: required
      const termSelect = form.querySelector('select[name*="term" i]') || form.querySelector('select');
      if (termSelect) {
        termSelect.required = true;
        const termP = termSelect.closest('p') || termSelect.parentElement;
        if (termP) {
          termP.classList.add('form-floating-lite','mb-3','with-icon');
          const lbl = termP.querySelector('label');
          if (lbl) lbl.textContent = 'Term';
          const icon = document.createElement('i');
          icon.className = 'bi bi-calendar3 left-icon';
          termP.appendChild(icon);
          const invalid = document.createElement('div');
          invalid.className = 'invalid-feedback';
          invalid.textContent = 'Please select a term.';
          termP.appendChild(invalid);
        }
      }

      // Multi-select levels: add quick tools + floating label + icon
      const levelSelect = form.querySelector('select[multiple], select[size]');
      if (levelSelect) {
        const tools = document.createElement('div');
        tools.className = 'inline-tools';
        tools.innerHTML = `
          <button type="button" class="btn btn-outline-secondary btn-sm" id="levelsSelectAll">Select All</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="levelsClear">Clear</button>
        `;
        const container = levelSelect.closest('p') || levelSelect.parentElement;
        if (container) container.insertBefore(tools, levelSelect);
        tools.querySelector('#levelsSelectAll').addEventListener('click', ()=>{ for (const o of levelSelect.options) o.selected = true; });
        tools.querySelector('#levelsClear').addEventListener('click', ()=>{ for (const o of levelSelect.options) o.selected = false; });
        // hint
        let hint = document.createElement('div');
        hint.className = 'small-hint';
        hint.textContent = 'Tip: Hold Ctrl/Cmd to select multiple levels.';
        container.appendChild(hint);
        // floating label + icon
        container.classList.add('form-floating-lite','mb-3','with-icon');
        const lbl = container.querySelector('label');
        if (lbl) lbl.textContent = 'Level(s)';
        const icon = document.createElement('i');
        icon.className = 'bi bi-layers left-icon';
        container.appendChild(icon);
        const invalid = document.createElement('div');
        invalid.className = 'invalid-feedback';
        invalid.textContent = 'Please select at least one level.';
        container.appendChild(invalid);
      }

      // Dates: enforce start <= end, floating labels + icons, disable past dates, limit to selected term when available
      const startInput = form.querySelector('input[name*="start" i]');
      const endInput = form.querySelector('input[name*="end" i]');
      if (startInput) startInput.required = true;
      if (endInput) endInput.required = true;
      const todayStr = new Date().toISOString().slice(0,10);
      if (startInput && !startInput.min) startInput.min = todayStr;
      if (endInput && !endInput.min) endInput.min = todayStr;
      function syncDates(){
        if (startInput && endInput) {
          endInput.min = startInput.value || '';
        }
      }
      if (startInput) startInput.addEventListener('change', syncDates);
      if (endInput) endInput.addEventListener('change', syncDates);
      syncDates();
      // floating label + icons + inline validation for dates
      const setupDateDecor = (el, label) => {
        const p = el && (el.closest('p') || el.parentElement);
        if (!p) return;
        p.classList.add('form-floating-lite','mb-3','with-icon');
        const lbl = p.querySelector('label');
        if (lbl) lbl.textContent = label;
        const icon = document.createElement('i'); icon.className = 'bi bi-calendar-event left-icon'; p.appendChild(icon);
        const invalid = document.createElement('div'); invalid.className = 'invalid-feedback'; invalid.textContent = `${label} is required.`; p.appendChild(invalid);
      };
      if (startInput) setupDateDecor(startInput, 'Start date');
      if (endInput) setupDateDecor(endInput, 'End date');

      // Validate on submit
      form.addEventListener('submit', function(e){
        let invalidAny = false;
        const setInvalid = (el, msg) => {
          if (!el) return; invalidAny = true; el.classList.add('is-invalid');
          const fb = (el.closest('p')||el.parentElement).querySelector('.invalid-feedback'); if (fb && msg) fb.textContent = msg;
        };
        const clearInvalid = (el) => { if (!el) return; el.classList.remove('is-invalid'); };
        // basic required checks
        clearInvalid(nameInput); if (nameInput && !nameInput.value.trim()) setInvalid(nameInput);
        clearInvalid(termSelect); if (termSelect && !termSelect.value) setInvalid(termSelect);
        clearInvalid(startInput); if (startInput && !startInput.value) setInvalid(startInput);
        clearInvalid(endInput); if (endInput && !endInput.value) setInvalid(endInput);
        // date order
        if (startInput && endInput && startInput.value && endInput.value && endInput.value < startInput.value) {
          setInvalid(endInput, 'End date must be on or after the start date.');
        }
        if (invalidAny) e.preventDefault();
      });

      // Option 4: Auto-fill Term from date range using /api/terms/ if available
      let termData = null;
      function tryFetchTerms(){
        fetch('/api/terms/', { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
          .then(r => r.ok ? r.json() : Promise.reject())
          .then(data => { termData = data && (data.terms || data); })
          .catch(() => { termData = null; });
      }
      tryFetchTerms();
      function parseYmd(s){ return s ? new Date(s) : null; }
      function ymd(d){ return d ? d.toISOString().slice(0,10) : ''; }
      function autoSelectTerm(){
        if (!termData || !termSelect || !startInput) return;
        const s = parseYmd(startInput.value);
        if (!s) return;
        for (const t of termData){
          const ts = parseYmd(t.start_date || t.start || t.startDate);
          const te = parseYmd(t.end_date || t.end || t.endDate);
          if (ts && te && s >= ts && s <= te){
            // try to match option by id or name
            let matched = false;
            [...termSelect.options].forEach(opt => {
              if (String(opt.value) === String(t.id) || (t.name && opt.text.trim().toLowerCase() === String(t.name).trim().toLowerCase())){
                termSelect.value = opt.value; matched = true;
              }
            });
            // limit date pickers to selected term
            if (matched){
              if (startInput) { startInput.min = ymd(ts); startInput.max = ymd(te); }
              if (endInput)   { endInput.min = startInput.value || ymd(ts); endInput.max = ymd(te); }
            }
            break;
          }
        }
      }
      if (startInput) startInput.addEventListener('change', autoSelectTerm);
      // also adjust when term changes manually
      if (termSelect) termSelect.addEventListener('change', function(){
        if (!termData) return;
        const t = (termData||[]).find(x => String(x.id) === String(termSelect.value) || (x.name && x.name === termSelect.options[termSelect.selectedIndex].text));
        if (t){
          const ts = parseYmd(t.start_date || t.start || t.startDate);
          const te = parseYmd(t.end_date || t.end || t.endDate);
          if (startInput){ startInput.min = ymd(ts); startInput.max = ymd(te); if (startInput.value && startInput.value < startInput.min) startInput.value = startInput.min; }
          if (endInput){ endInput.min = startInput.value || ymd(ts); endInput.max = ymd(te); if (endInput.value && endInput.value > endInput.max) endInput.value = endInput.max; }
        }
      });
    });
  </script>
<style>
  /* Make Django as_p fields look like grid items */
  .form-grid > p { margin-bottom: 0; }
  .form-grid > p label { font-weight: 600; margin-bottom: 4px; display: block; }
  @media (min-width: 768px) {
    .form-grid > p { width: 50%; float: left; padding-right: 10px; }
  }
  @media (max-width: 767.98px) {
    .form-grid > p { width: 100%; }
  }
</style>
<script>
  // Enhance Add Exam form controls with Bootstrap styles and UX
  document.addEventListener('DOMContentLoaded', function(){
    function enhanceForm(formId){
      const form = document.getElementById(formId);
      if (!form) return;
      // Style inputs and selects
      form.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], input[type="email"], input:not([type])').forEach(el => {
        el.classList.add('form-control','form-control-sm');
        if (/start/i.test(el.name)) el.placeholder = el.placeholder || 'yyyy-mm-dd';
        if (/end/i.test(el.name)) el.placeholder = el.placeholder || 'yyyy-mm-dd';
      });
      form.querySelectorAll('select').forEach(sel => {
        sel.classList.add('form-select','form-select-sm');
        // If likely a multi-select for levels, give a reasonable height
        if (/level/i.test(sel.name)) sel.size = sel.size && sel.size > 1 ? sel.size : 6;
      });
      // Convert probable date fields
      form.querySelectorAll('input[name*="start"], input[name*="end"]').forEach(d => {
        if (!d.type || d.type === 'text') d.setAttribute('type','date');
      });
    }
    enhanceForm('addExamForm');
    enhanceForm('addExamFormDisabled');
  });
</script>
            <script>
            // Populate Result Slips dropdown with classes
            document.addEventListener('DOMContentLoaded', function(){
              const dd = document.getElementById('resultSlipsDropdown');
              if (!dd) return;
              fetch('/api/classes/', { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
                .then(r => r.json())
                .then(data => {
                  const classes = data && data.classes ? data.classes : [];
                  if (!classes.length) {
                    dd.innerHTML = '<li class="px-3 py-2 text-muted small">No classes found</li>';
                    return;
                  }
                  dd.innerHTML = '';
                  classes.forEach(cls => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.className = 'dropdown-item';
                    a.textContent = cls.display_name || cls.name || `Class ${cls.id}`;
                    a.href = `/admin_class_result_slip/${cls.id}/`;
                    a.target = '_blank';
                    li.appendChild(a);
                    dd.appendChild(li);
                  });
                })
                .catch(() => {
                  dd.innerHTML = '<li class="px-3 py-2 text-danger small">Failed to load classes</li>';
                });
            });
            </script>
          </div>
        </div>
      </div>
      <!-- Exam Calendar Tab -->
      <div class="tab-pane fade" id="exam-calendar-pane" role="tabpanel" aria-labelledby="exam-calendar-tab">
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="mb-3">Exam Calendar</h5>
            <div id="exam-calendar" style="min-height: 400px;"></div>
            <div id="calendar-error" style="color: red; font-weight: bold; display: none;"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- FullCalendar CSS for calendar tab -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    

{% endblock %}

<div class="card mb-4">
    <div class="card-body">
        <!-- Marksheet Upload Form -->
        <form method="post" enctype="multipart/form-data" class="mb-4">
            {% csrf_token %}
            <div class="input-group mb-2">
                <input type="file" name="marksheet" accept=".xlsx,.xls" class="form-control" required>
                <button type="submit" name="preview" value="1" class="btn btn-secondary me-2"><i class="bi bi-eye me-1"></i>Preview</button>
                <button type="submit" name="process" value="1" class="btn btn-primary"><i class="bi bi-gear me-1"></i>Process</button>
            </div>
        </form>
            {% if table_html %}
                <div class="table-responsive">
                    {{ table_html|safe }}
                </div>
            {% else %}
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle me-2"></i>
                    Exams management features coming soon. Upload an Excel marksheet to preview it here.
                </div>
            {% endif %}

    </div>
</div>



{% block scripts %}
<!-- FullCalendar JavaScript Library -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
    // Wait for FullCalendar to load before initializing
    document.addEventListener('DOMContentLoaded', function() {
        // Check if FullCalendar is loaded
        if (typeof FullCalendar === 'undefined') {
            console.error('FullCalendar library failed to load');
            const calendarEl = document.getElementById('exam-calendar');
            if (calendarEl) {
                calendarEl.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>FullCalendar library failed to load. Please check your internet connection and refresh the page.</div>';
            }
            return;
        }
        // Defer calendar initialization until the Exam Calendar tab is shown
        function ensureExamCalendar() {
            if (window._examCalendarInstance) {
                // Re-render in case container was hidden
                window._examCalendarInstance.render();
                return;
            }
            const calendarEl = document.getElementById('exam-calendar');
            if (!calendarEl) return;
            // Show loading indicator
            calendarEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading exam calendar...</p></div>';
            try {
                const calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    height: 450,
                    contentHeight: 400,
                    headerToolbar: { left: 'prev,next', center: 'title', right: 'today,listWeek' },
                    events: { url: '/api/exams/', failure: function(error) {
                        console.error('Error loading exam events:', error);
                        calendarEl.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Error loading exam calendar. Please refresh the page.</div>';
                    }},
                    loading: function(isLoading) { if (!isLoading) console.log('Exam calendar loaded'); },
                    eventDidMount: function(info) {
                        info.el.setAttribute('title', info.event.extendedProps.description || info.event.title);
                        info.el.classList.add('fc-event-exam');
                    },
                    eventClick: function(info) {
                        // Load grade entry form only if container exists
                        if (document.getElementById('grade-entry-section')) {
                            loadGradeEntryForm(info.event.id, info.event.title);
                        }
                        document.getElementById('modalExamName').textContent = info.event.title;
                        const startDate = info.event.start ? info.event.start.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
                        const endDate = info.event.end ? info.event.end.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
                        document.getElementById('modalExamStart').textContent = startDate;
                        document.getElementById('modalExamEnd').textContent = endDate;
                        document.getElementById('modalExamTerm').textContent = info.event.extendedProps.term || 'No Term';
                        var examModal = new bootstrap.Modal(document.getElementById('examDetailModal'));
                        examModal.show();
                    },
                    dayMaxEvents: 2,
                    moreLinkClick: 'popover',
                    eventDisplay: 'block',
                    fixedWeekCount: false,
                    showNonCurrentDates: false,
                    aspectRatio: window.innerWidth < 768 ? 0.8 : 1.5,
                    eventTextColor: '#ffffff',
                    eventBorderWidth: 1,
                    dayHeaderFormat: { weekday: 'short' },
                    scrollTime: '08:00:00'
                });
                window._examCalendarInstance = calendar;
                calendar.render();
            } catch (e) {
                console.error('Error initializing exam calendar:', e);
                calendarEl.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Error initializing exam calendar: ' + e.message + '</div>';
            }
        }
        // Hook to both possible tab triggers (top and hidden lower)
        ['exam-calendar-tab-top','exam-calendar-tab'].forEach(function(id){
            var el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('shown.bs.tab', function(){ ensureExamCalendar(); });
        });
        // If the calendar pane is already active on load, initialize immediately
        var pane = document.getElementById('exam-calendar-pane');
        if (pane && pane.classList.contains('show') && pane.classList.contains('active')) {
            ensureExamCalendar();
        }
    });
    
    // Function to load grade entry form for selected exam
    function loadGradeEntryForm(examId, examTitle) {
        const gradeSection = document.getElementById('grade-entry-section');
        
        // Set global exam ID
        currentExamId = examId;
        
        // Show loading state
        gradeSection.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading grade entry form...</p>
            </div>
        `;
        
        // Load real classes and subjects from database
        Promise.all([
            fetch('/api/classes/').then(response => response.json()),
            fetch(`/api/exam/${examId}/subjects/`).then(response => response.json())
        ]).then(([classesData, subjectsData]) => {
            let classOptions = '<option value="">Choose a class...</option>';
            if (classesData.classes) {
                classesData.classes.forEach(cls => {
                    classOptions += `<option value="${cls.id}">${cls.display_name}</option>`;
                });
            }
            
            let subjectOptions = '<option value="">Choose a subject...</option>';
            if (subjectsData.subjects) {
                subjectsData.subjects.forEach(subject => {
                    subjectOptions += `<option value="${subject.id}">${subject.name}</option>`;
                });
            }
            
            let formHtml = `
                <h6 class="mb-3">${examTitle} - Grade Entry</h6>
                <form method="post" action="" id="gradeForm">
                    <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                    <input type="hidden" name="exam_id" value="${examId}">
                    
                    <div class="mb-3">
                        <label class="form-label">Select Class:</label>
                        <select class="form-select form-select-sm" id="classSelect" onchange="loadStudentsForClass()">
                            ${classOptions}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Select Subject:</label>
                        <select class="form-select form-select-sm" id="subjectSelect">
                            ${subjectOptions}
                        </select>
                    </div>
                    
                    <!-- Bulk Operations Tabs -->
                    <ul class="nav nav-tabs" id="bulkGradeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="excel-tab" data-bs-toggle="tab" data-bs-target="#excel-upload" type="button" role="tab">
                                <i class="bi bi-file-earmark-excel me-1"></i>Excel Upload
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="batch-tab" data-bs-toggle="tab" data-bs-target="#batch-entry" type="button" role="tab">
                                <i class="bi bi-table me-1"></i>Batch Entry
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="template-tab" data-bs-toggle="tab" data-bs-target="#template-download" type="button" role="tab">
                                <i class="bi bi-download me-1"></i>Templates
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="bulkGradeTabContent">
                        <!-- Excel Upload Tab -->
                        <div class="tab-pane fade show active" id="excel-upload" role="tabpanel">
                            <div class="mt-3">
                                <div class="mb-3">
                                    <label class="form-label">Upload Excel File:</label>
                                    <input type="file" class="form-control form-control-sm" id="gradeExcelFile" accept=".xlsx,.xls" onchange="previewExcelGrades()">
                                    <small class="text-muted">Upload an Excel file with columns: admission_no, student_name, subject, grade</small>
                                </div>
                                <div id="excelPreview"></div>
                                <div class="d-flex gap-2 mt-3">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="uploadBulkGrades()">
                                        <i class="bi bi-upload me-1"></i>Upload Grades
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Batch Entry Tab -->
                        <div class="tab-pane fade" id="batch-entry" role="tabpanel">
                            <div class="mt-3">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Select Class:</label>
                                        <select class="form-select form-select-sm" id="batchClassSelect">
                                            <option value="">Choose a class...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Select Subject:</label>
                                        <select class="form-select form-select-sm" id="batchSubjectSelect">
                                            <option value="">Choose a subject...</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="batchGradeList">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Select class and subject to load students for batch grade entry.
                                    </div>
                                </div>
                                <div class="d-flex gap-2 mt-3">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="loadBatchStudents()">
                                        <i class="bi bi-people me-1"></i>Load Students
                                    </button>
                                    <button type="button" class="btn btn-success btn-sm" style="display:none;" id="saveBatchGradesBtn" onclick="saveBatchGrades()">
                                        <i class="bi bi-check-circle me-1"></i>Save All Grades
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm" style="display:none;" id="fillAllGradesBtn" onclick="fillAllGrades()">
                                        <i class="bi bi-fill me-1"></i>Fill All with Same Grade
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Template Download Tab -->
                        <div class="tab-pane fade" id="template-download" role="tabpanel">
                            <div class="mt-3">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Download templates to prepare your grade data for bulk upload.
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="downloadGradeTemplate()">
                                        <i class="bi bi-download me-1"></i>Download Grade Template
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="downloadClassStudents()">
                                        <i class="bi bi-people me-1"></i>Download Students List
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            `;
            
            gradeSection.innerHTML = formHtml;
            
            // Load classes and subjects for batch entry tab
            loadBatchDropdowns(classesData, subjectsData);
            
        }).catch(error => {
            console.error('Error loading classes and subjects:', error);
            gradeSection.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error loading classes and subjects. Please try again.
                </div>
            `;
        });
    }
    
    function loadBatchDropdowns(classesData, subjectsData) {
        // Populate batch entry dropdowns
        let classOptions = '<option value="">Choose a class...</option>';
        if (classesData.classes) {
            classesData.classes.forEach(cls => {
                classOptions += `<option value="${cls.id}">${cls.display_name}</option>`;
            });
        }
        
        let subjectOptions = '<option value="">Choose a subject...</option>';
        if (subjectsData.subjects) {
            subjectsData.subjects.forEach(subject => {
                subjectOptions += `<option value="${subject.id}">${subject.name}</option>`;
            });
        }
        
        document.getElementById('batchClassSelect').innerHTML = classOptions;
        document.getElementById('batchSubjectSelect').innerHTML = subjectOptions;
    }
    
    function loadBatchStudents() {
        const classId = document.getElementById('batchClassSelect').value;
        const subjectId = document.getElementById('batchSubjectSelect').value;
        
        if (!classId || !subjectId) {
            alert('Please select both class and subject.');
            return;
        }
        
        // Show loading state
        document.getElementById('batchGradeList').innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading students...</p>
            </div>
        `;
        
        // Fetch students from database
        fetch(`/api/students/${classId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.students && data.students.length > 0) {
                    let studentsHtml = `
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th width="15%">Admission No</th>
                                        <th width="40%">Student Name</th>
                                        <th width="25%">Grade (0-100)</th>
                                        <th width="20%">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.students.forEach((student, index) => {
                        studentsHtml += `
                            <tr>
                                <td>${student.admission_no}</td>
                                <td>${student.name}</td>
                                <td>
                                    <input type="number" 
                                           id="grade_${student.id}" 
                                           class="form-control form-control-sm grade-input" 
                                           min="0" max="100" step="0.1" 
                                           data-student-id="${student.id}"
                                           data-subject-id="${subjectId}"
                                           placeholder="Enter grade">
                                </td>
                                <td>
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="copyGradeToAll(${student.id})" title="Copy this grade to all students">
                                        <i class="bi bi-copy"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    studentsHtml += `
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Fill all with grade:</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" id="fillAllGradeValue" class="form-control" min="0" max="100" step="0.1" placeholder="Grade">
                                            <button class="btn btn-outline-secondary" type="button" onclick="fillAllWithValue()">
                                                <i class="bi bi-fill"></i> Fill All
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    `;
                    
                    document.getElementById('batchGradeList').innerHTML = studentsHtml;
                    document.getElementById('saveBatchGradesBtn').style.display = 'inline-block';
                    document.getElementById('fillAllGradesBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('batchGradeList').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            No students found in the selected class.
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading students:', error);
                document.getElementById('batchGradeList').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error loading students. Please try again.
                    </div>
                `;
            });
    }
    
    function copyGradeToAll(sourceStudentId) {
        const sourceGrade = document.getElementById(`grade_${sourceStudentId}`).value;
        if (!sourceGrade) {
            alert('Please enter a grade in the source field first.');
            return;
        }
        
        const gradeInputs = document.querySelectorAll('.grade-input');
        gradeInputs.forEach(input => {
            input.value = sourceGrade;
        });
    }
    
    function fillAllWithValue() {
        const fillValue = document.getElementById('fillAllGradeValue').value;
        if (!fillValue) {
            alert('Please enter a grade value to fill all fields.');
            return;
        }
        
        const gradeInputs = document.querySelectorAll('.grade-input');
        gradeInputs.forEach(input => {
            input.value = fillValue;
        });
    }
    
    function saveBatchGrades() {
        const gradeInputs = document.querySelectorAll('.grade-input');
        const grades = [];
        
        gradeInputs.forEach(input => {
            if (input.value && input.value.trim() !== '') {
                grades.push({
                    student_id: input.dataset.studentId,
                    subject_id: input.dataset.subjectId,
                    grade: parseFloat(input.value),
                    exam_id: currentExamId
                });
            }
        });
        
        if (grades.length === 0) {
            alert('Please enter at least one grade.');
            return;
        }
        
        // Show loading state
        document.getElementById('saveBatchGradesBtn').innerHTML = `
            <div class="spinner-border spinner-border-sm me-1" role="status"></div>
            Saving...
        `;
        document.getElementById('saveBatchGradesBtn').disabled = true;
        
        // Send grades to server
        fetch('/api/bulk-grades/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({grades: grades})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Successfully saved ${data.saved_count} grades!`);
                // Clear the form
                document.getElementById('batchGradeList').innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        Grades saved successfully! Select class and subject to enter more grades.
                    </div>
                `;
                document.getElementById('saveBatchGradesBtn').style.display = 'none';
                document.getElementById('fillAllGradesBtn').style.display = 'none';
            } else {
                alert('Error saving grades: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error saving grades:', error);
            alert('Error saving grades. Please try again.');
        })
        .finally(() => {
            document.getElementById('saveBatchGradesBtn').innerHTML = `
                <i class="bi bi-check-circle me-1"></i>Save All Grades
            `;
            document.getElementById('saveBatchGradesBtn').disabled = false;
        });
    }
    
    // Excel Upload Functions
    function previewExcelGrades() {
        const fileInput = document.getElementById('gradeExcelFile');
        const file = fileInput.files[0];
        
        if (!file) {
            document.getElementById('excelPreview').innerHTML = '';
            return;
        }
        
        if (!file.name.match(/\.(xlsx|xls)$/)) {
            alert('Please select a valid Excel file (.xlsx or .xls)');
            fileInput.value = '';
            return;
        }
        
        document.getElementById('excelPreview').innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-file-earmark-excel me-2"></i>
                File selected: <strong>${file.name}</strong> (${(file.size / 1024).toFixed(1)} KB)
                <br><small>Click "Upload Grades" to process the file.</small>
            </div>
        `;
    }
    
    function uploadBulkGrades() {
        const fileInput = document.getElementById('gradeExcelFile');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Please select an Excel file first.');
            return;
        }
        
        const formData = new FormData();
        formData.append('excel_file', file);
        formData.append('exam_id', currentExamId);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        // Show loading state
        document.getElementById('excelPreview').innerHTML = `
            <div class="alert alert-info">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Processing Excel file... Please wait.
            </div>
        `;
        
        fetch('/api/upload-bulk-grades/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('excelPreview').innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        Successfully uploaded ${data.processed_count} grades!
                        ${data.errors && data.errors.length > 0 ? 
                            `<br><small class="text-warning">Warnings: ${data.errors.join(', ')}</small>` : ''}
                    </div>
                `;
                // Clear file input
                fileInput.value = '';
            } else {
                document.getElementById('excelPreview').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error: ${data.error || 'Failed to process Excel file'}
                        ${data.errors && data.errors.length > 0 ? 
                            `<br><small>Details: ${data.errors.join(', ')}</small>` : ''}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error uploading file:', error);
            document.getElementById('excelPreview').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error uploading file. Please try again.
                </div>
            `;
        });
    }
    
    // Template Download Functions
    function downloadGradeTemplate() {
        const classId = document.getElementById('classSelect').value;
        const subjectId = document.getElementById('subjectSelect').value;
        
        let url = '/api/download-grade-template/';
        const params = new URLSearchParams();
        
        if (currentExamId) params.append('exam_id', currentExamId);
        if (classId) params.append('class_id', classId);
        if (subjectId) params.append('subject_id', subjectId);
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        // Create a temporary link to download the file
        const link = document.createElement('a');
        link.href = url;
        link.download = `grade_template_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function downloadClassStudents() {
        const classId = document.getElementById('classSelect').value;
        
        if (!classId) {
            alert('Please select a class first.');
            return;
        }
        
        const url = `/api/download-class-students/${classId}/`;
        
        // Create a temporary link to download the file
        const link = document.createElement('a');
        link.href = url;
        link.download = `class_students_${classId}_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // Global variable to store current exam ID
    let currentExamId = null;

    // Helper to populate the Exam Details modal from data-* attributes
    function openExamModal(btn) {
        try {
            const name = btn.getAttribute('data-exam-name') || '';
            const start = btn.getAttribute('data-exam-start') || '';
            const end = btn.getAttribute('data-exam-end') || '';
            const term = btn.getAttribute('data-exam-term') || '';
            var nameEl = document.getElementById('modalExamName');
            var startEl = document.getElementById('modalExamStart');
            var endEl = document.getElementById('modalExamEnd');
            var termEl = document.getElementById('modalExamTerm');
            if (nameEl) nameEl.textContent = name;
            if (startEl) startEl.textContent = start;
            if (endEl) endEl.textContent = end;
            if (termEl) termEl.textContent = term;
        } catch (e) {
            console.error('Failed to open exam modal:', e);
        }
    }
</script>
{% endblock %}

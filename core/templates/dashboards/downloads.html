{% extends 'base.html' %}
{% block title %}Downloads{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const overlay = document.getElementById('download-overlay');
  const iframe = document.getElementById('dl_frame');
  const downloadsContainer = document.querySelector('.downloads');
  const fallbackMs = parseInt(downloadsContainer?.dataset.timeoutMs || '12000', 10);
  // Step log utilities
  const stepsEl = document.getElementById('download-steps');
  const progressBar = document.querySelector('#download-overlay .progress-bar');
  const stages = ['Fetching files', 'Preparing download', 'Downloading', 'Downloaded'];
  const stageToPct = { 'Fetching files': 10, 'Preparing download': 40, 'Downloading': 80, 'Downloaded': 100 };
  const showOverlay = () => { if (overlay) overlay.classList.add('show'); };
  const hideOverlay = () => { if (overlay) overlay.classList.remove('show'); };
  // Lock/unlock page scroll when overlay toggles
  const lockScroll = () => document.body.classList.add('no-scroll');
  const unlockScroll = () => document.body.classList.remove('no-scroll');
  let hideTimeout = null;
  const setOverlayText = (text) => {
    const t = document.getElementById('download-text');
    if (t) t.textContent = text || 'Preparing your download…';
  };

  const resetSteps = () => {
    if (!stepsEl) return;
    stepsEl.querySelectorAll('li').forEach(li => { li.classList.remove('done','active'); li.classList.add('pending'); });
    if (progressBar) progressBar.style.width = '0%';
  };
  const setStage = (stage) => {
    if (!stepsEl) return;
    const items = Array.from(stepsEl.querySelectorAll('li'));
    const idx = stages.indexOf(stage);
    items.forEach((li, i) => {
      li.classList.remove('pending','active','done');
      if (i < idx) li.classList.add('done');
      else if (i === idx) li.classList.add('active');
      else li.classList.add('pending');
    });
    if (progressBar && stageToPct[stage] != null) progressBar.style.width = stageToPct[stage] + '%';
  };

  const disableElems = (root) => {
    (root ? root.querySelectorAll('button, a.btn') : document.querySelectorAll('.downloads button, .downloads a.btn')).forEach(el => {
      if (el.tagName === 'A') {
        if (!el.hasAttribute('aria-disabled')) el.setAttribute('data-dl-was-enabled', '1');
        el.setAttribute('aria-disabled', 'true');
        el.classList.add('disabled');
      } else {
        if (!el.disabled) el.setAttribute('data-dl-was-enabled', '1');
        el.disabled = true;
      }
    });
  };
  const enableElems = () => {
    document.querySelectorAll('.downloads [data-dl-was-enabled]')?.forEach(el => {
      el.removeAttribute('data-dl-was-enabled');
      if (el.tagName === 'A') {
        el.removeAttribute('aria-disabled');
        el.classList.remove('disabled');
      } else {
        el.disabled = false;
      }
    });
  };

  if (iframe) {
    iframe.addEventListener('load', () => {
      // Many browsers will still fire load even for attachment responses.
      if (hideTimeout) clearTimeout(hideTimeout);
      setStage('Downloaded');
      setOverlayText('Downloaded');
      hideOverlay();
      enableElems(); unlockScroll();
      // Remove button spinner if present
      const submitBtn = document.getElementById('dl-class-submit');
      const sp = submitBtn && submitBtn.querySelector('.spinner-border');
      if (sp) sp.remove();
    });
  }

  // Intercept all forms within downloads container and target iframe
  document.querySelectorAll('.downloads form').forEach(f => {
    f.addEventListener('submit', () => {
      showOverlay(); lockScroll();
      resetSteps();
      setStage('Fetching files');
      setOverlayText(f.getAttribute('data-dl-text') || 'Preparing your download…');
      // quickly move to preparing
      setTimeout(() => setStage('Preparing download'), 250);
      disableElems(f);
      if (iframe && !f.hasAttribute('target')) {
        f.setAttribute('target', 'dl_frame');
      }
      // during submit we assume network start
      setTimeout(() => setStage('Downloading'), 600);
      // Fallback to auto-hide in case load doesn't fire for attachments
      hideTimeout = setTimeout(() => { setStage('Downloaded'); hideOverlay(); enableElems(); unlockScroll(); }, fallbackMs);
    });
  });

  // Intercept direct download links
  document.querySelectorAll('.downloads a.dl-link').forEach(a => {
    a.addEventListener('click', () => {
      showOverlay(); lockScroll();
      resetSteps();
      setStage('Fetching files');
      setOverlayText(a.getAttribute('data-dl-text') || a.textContent.trim() || 'Preparing your download…');
      setTimeout(() => setStage('Preparing download'), 250);
      disableElems(a.closest('div.card-body') || undefined);
      if (iframe) a.setAttribute('target', 'dl_frame');
      setTimeout(() => setStage('Downloading'), 600);
      hideTimeout = setTimeout(() => { setStage('Downloaded'); hideOverlay(); enableElems(); }, fallbackMs);
    });
  });

  // Delegated handler for any .downloads anchor buttons (fallback if class not present)
  document.addEventListener('click', (ev) => {
    const a = ev.target.closest('.downloads a.btn');
    if (!a) return;
    const href = a.getAttribute('href') || '';
    // Only trigger overlay for same-window navigations to files
    if (href && (href.endsWith('.csv') || href.endsWith('.xlsx') || href.endsWith('.pdf') || a.classList.contains('dl-link'))) {
      showOverlay(); lockScroll();
      resetSteps();
      setStage('Fetching files');
      setOverlayText(a.getAttribute('data-dl-text') || a.textContent.trim() || 'Preparing your download…');
      setTimeout(() => setStage('Preparing download'), 250);
      disableElems(a.closest('div.card-body') || undefined);
      if (iframe) a.setAttribute('target', 'dl_frame');
      setTimeout(() => setStage('Downloading'), 600);
      hideTimeout = setTimeout(() => { setStage('Downloaded'); hideOverlay(); enableElems(); unlockScroll(); }, fallbackMs);
    }
  }, true);

  // Improve class export: stream into iframe instead of navigating window
  const form = document.getElementById('class-export-form');
  if (form) {
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const select = document.getElementById('dl-class-id');
      const cid = select && select.value;
      if (cid) {
        const base = form.dataset.baseUrl;
        const url = base.replace('/0/', '/' + cid + '/');
        if (iframe) {
          showOverlay(); lockScroll();
          resetSteps();
          setStage('Fetching files');
          setOverlayText('Preparing your download…');
          setTimeout(() => setStage('Preparing download'), 250);
          disableElems(form);
          // Button spinner on
          const submitBtn = document.getElementById('dl-class-submit');
          if (submitBtn && !submitBtn.querySelector('.spinner-border')) {
            const sp = document.createElement('span');
            sp.className = 'spinner-border spinner-border-sm';
            sp.setAttribute('role', 'status');
            sp.setAttribute('aria-hidden', 'true');
            submitBtn.appendChild(sp);
          }
          iframe.src = url;
          setTimeout(() => setStage('Downloading'), 600);
          hideTimeout = setTimeout(() => { setStage('Downloaded'); hideOverlay(); enableElems(); unlockScroll(); }, fallbackMs);
        } else {
          window.location = url;
        }
      } else {
        // Show simple validation feedback if no class selected
        if (select) {
          select.classList.add('is-invalid');
          // remove invalid state on change
          const clearInvalid = () => { select.classList.remove('is-invalid'); select.removeEventListener('change', clearInvalid); };
          select.addEventListener('change', clearInvalid);
          const fb = form.querySelector('.invalid-feedback');
          if (fb) { fb.style.display = 'block'; fb.textContent = 'Please select a class before downloading.'; }
        }
      }
    });
    // Disable submit button until a class is selected and maintain a fallback link
    const submitBtn = document.getElementById('dl-class-submit');
    const select = document.getElementById('dl-class-id');
    const fallbackLink = document.getElementById('dl-class-fallback');
    if (submitBtn && select) {
      const toggle = () => {
        const enabled = !!select.value;
        submitBtn.disabled = !enabled;
        if (fallbackLink) {
          if (enabled) {
            const base = form.dataset.baseUrl;
            fallbackLink.href = base.replace('/0/', '/' + select.value + '/');
            fallbackLink.style.display = '';
          } else {
            fallbackLink.removeAttribute('href');
            fallbackLink.style.display = 'none';
          }
        }
      };
      toggle();
      select.addEventListener('change', toggle);
      // When clicking fallback, show overlay too
      if (fallbackLink) {
        fallbackLink.addEventListener('click', () => {
          showOverlay();
          setOverlayText('Preparing your download…');
          disableElems(form);
          hideTimeout = setTimeout(() => { hideOverlay(); enableElems(); }, fallbackMs);
        });
      }
    }
  }

  // Rotate chevrons on expand/collapse
  document.querySelectorAll('[data-bs-toggle="collapse"][data-bs-target]').forEach(btn => {
    const targetSel = btn.getAttribute('data-bs-target');
    const target = targetSel ? document.querySelector(targetSel) : null;
    if (!target) return;
    target.addEventListener('show.bs.collapse', () => btn.classList.add('rotated'));
    target.addEventListener('hide.bs.collapse', () => btn.classList.remove('rotated'));
  });
});
</script>
{% endblock %}

{% block content %}
<div class="container-fluid downloads" data-timeout-ms="12000">
  <div class="mb-3 d-flex align-items-center justify-content-between">
    <h1 class="mb-0"><i class="bi bi-download me-2"></i>Downloads</h1>
  </div>
  <style>
    /* Scoped compact styling for Downloads page */
    .downloads .row.g-4 { --bs-gutter-x: .75rem; --bs-gutter-y: .75rem; }
    .downloads .card-body { padding: .75rem 1rem; }
    .downloads .card-title { font-size: .95rem; margin-bottom: .5rem; }
    .downloads .text-muted { font-size: .85rem; margin-bottom: .5rem; }
    .downloads .form-select-sm, .downloads .form-control-sm { padding: .25rem .5rem; height: calc(1.5em + .5rem + 2px); }
    .downloads .btn { padding: .25rem .5rem; font-size: .875rem; }
    .downloads .section-divider { margin-bottom: .5rem; }
    .downloads h1.mb-0 { font-size: 1.25rem; }
    /* Download overlay */
    .download-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(17,24,39,.35); backdrop-filter: blur(2px); z-index: 50000; display: none; align-items: center; justify-content: center; }
    .download-overlay.show { display: flex; }
    .download-overlay .box { background: #fff; border: 1px solid #e5e7eb; border-radius: .5rem; padding: .75rem 1rem; box-shadow: 0 8px 24px rgba(0,0,0,.08); display: flex; align-items: center; gap: .5rem; }
    .download-overlay .text { font-size: .9rem; color: #374151; }
    .downloads .btn.disabled,[aria-disabled="true"] { pointer-events: none; }
    .downloads .section-divider .btn.rotated i { transform: rotate(180deg); transition: transform .2s ease-in-out; }
    .downloads .section-divider .btn i { transition: transform .2s ease-in-out; }
    .downloads .btn .spinner-border.spinner-border-sm { margin-left: .35rem; vertical-align: text-bottom; }
    .downloads .is-invalid { border-color: #dc3545; }
    .downloads .invalid-feedback { color: #dc3545; font-size: .8rem; }
    /* Step log styles */
    #download-steps { margin: .5rem 0 0; padding-left: 1rem; }
    #download-steps li { position: relative; margin: .125rem 0; }
    #download-steps li::before { content: '•'; position: absolute; left: -1rem; color: #9ca3af; }
    #download-steps li.pending { color: #6b7280; }
    #download-steps li.active { color: #111827; font-weight: 600; }
    #download-steps li.done { color: #059669; }
    /* Prevent background scroll when overlay is visible */
    body.no-scroll { overflow: hidden !important; }
  </style>

  <!-- Hidden iframe target and overlay for downloads -->
  <iframe id="dl_frame" name="dl_frame" style="display:none;width:0;height:0;border:0"></iframe>
  <div id="download-overlay" class="download-overlay" aria-hidden="true">
    <div class="box">
      <div class="spinner-border text-primary spinner-border-sm" role="status" aria-hidden="true"></div>
      <div id="download-text" class="text">Preparing your download…</div>
    </div>
    <div class="w-100 mt-3 px-4">
      <div class="progress" role="progressbar" aria-label="Download progress" aria-valuemin="0" aria-valuemax="100">
        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
      </div>
    </div>
    <div class="w-100 px-4 pb-3">
      <ul id="download-steps" class="list-unstyled small mb-0">
        <li class="pending">Fetching files</li>
        <li class="pending">Preparing download</li>
        <li class="pending">Downloading</li>
        <li class="pending">Downloaded</li>
      </ul>
    </div>
  </div>

  <div class="row g-4" id="downloads-accordion">
    <!-- Administration -->
    <div class="col-12">
      <div class="section-divider d-flex align-items-center justify-content-between">
        <div><span class="divider-icon"><i class="bi bi-gear"></i></span> <span class="divider-title">Administration</span></div>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#admin-group" aria-expanded="false" aria-controls="admin-group">
          <i class="bi bi-chevron-down"></i>
        </button>
      </div>
    </div>
    <div class="col-12 collapse" id="admin-group" data-bs-parent="#downloads-accordion">
    <div class="col-12 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2"><i class="bi bi-people"></i> Users</h5>
          <p class="text-muted">Download all users and roles.</p>
          <div class="d-flex gap-2">
            <a class="btn btn-outline-primary dl-link" href="{% url 'export_users_csv' %}" target="dl_frame"><i class="bi bi-download me-1"></i> users.csv</a>
            <a class="btn btn-outline-secondary dl-link" href="{% url 'export_users_pdf' %}" target="dl_frame"><i class="bi bi-filetype-pdf me-1"></i> users.pdf</a>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2"><i class="bi bi-card-checklist"></i> Result Slip</h5>
          <p class="text-muted">Per-student subject scores for a selected exam. Filter by class or level.</p>
          <form class="row g-2" method="get" action="{% url 'export_result_slip_csv' %}">
            <div class="col-12">
              <label class="form-label small mb-1">Exam</label>
              <select class="form-select form-select-sm" required name="exam_id">
                <option value="" selected disabled>Select exam…</option>
                {% for e in exams %}
                <option value="{{ e.id }}">{{ e.name }} — {{ e.term.name }} ({{ e.term.academic_year.year }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Class</label>
              <select class="form-select form-select-sm" name="class_id">
                <option value="">All</option>
                {% for c in classes %}
                <option value="{{ c.id }}">{{ c.name }}{% if c.stream %} - {{ c.stream }}{% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Level</label>
              <select class="form-select form-select-sm" name="level">
                <option value="">All</option>
                {% for lv in levels %}
                <option value="{{ lv }}">{{ lv }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6 d-flex align-items-end gap-2">
              <button type="submit" class="btn btn-outline-primary w-100"><i class="bi bi-download me-1"></i> CSV</button>
              <button type="submit" class="btn btn-outline-secondary w-100" formaction="{% url 'export_result_slip_pdf' %}"><i class="bi bi-filetype-pdf me-1"></i> PDF</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2"><i class="bi bi-journal-text"></i> Empty Subject List</h5>
          <p class="text-muted">CSV with admission numbers, names, and a chosen subject column for a class.</p>
          <form class="row g-2" method="get" action="{% url 'export_empty_subject_list_csv' %}">
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Class</label>
              <select class="form-select form-select-sm" name="class_id" required>
                <option value="" selected disabled>Select class…</option>
                {% for c in classes %}
                <option value="{{ c.id }}">{{ c.name }}{% if c.stream %} - {{ c.stream }}{% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Subject</label>
              <select class="form-select form-select-sm" name="subject_id" required>
                <option value="" selected disabled>Select subject…</option>
                {% for s in subjects %}
                <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6 d-flex align-items-end gap-2">
              <button type="submit" class="btn btn-outline-secondary w-100"><i class="bi bi-download me-1"></i> CSV</button>
              <button type="submit" class="btn btn-outline-secondary w-100" formaction="{% url 'export_empty_subject_list_pdf' %}"><i class="bi bi-filetype-pdf me-1"></i> PDF</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2"><i class="bi bi-mortarboard"></i> Teachers</h5>
          <p class="text-muted">Export teacher directory (with department/subject filters).</p>
          <form class="row g-2" method="get" action="{% url 'export_teachers_csv' %}">
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Department</label>
              <select class="form-select form-select-sm" name="department_id">
                <option value="">All</option>
                {% for d in departments %}
                <option value="{{ d.id }}">{{ d.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Subject</label>
              <select class="form-select form-select-sm" name="subject_id">
                <option value="">All</option>
                {% for s in subjects %}
                <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Order</label>
              <select class="form-select form-select-sm" name="order">
                <option value="az">A → Z</option>
                <option value="za">Z → A</option>
              </select>
            </div>
            <div class="col-12 col-md-6 d-flex align-items-end gap-2">
              <button type="submit" class="btn btn-outline-primary w-100"><i class="bi bi-download me-1"></i> CSV</button>
              <button type="submit" class="btn btn-outline-secondary w-100" formaction="{% url 'export_teachers_pdf' %}"><i class="bi bi-filetype-pdf me-1"></i> PDF</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2"><i class="bi bi-people-fill"></i> Students</h5>
          <p class="text-muted">Export all students (filter by class or level).</p>
          <form class="row g-2" method="get" action="{% url 'export_students_csv' %}">
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Class</label>
              <select class="form-select form-select-sm" name="class_id">
                <option value="">All</option>
                {% for c in classes %}
                <option value="{{ c.id }}">{{ c.name }}{% if c.stream %} - {{ c.stream }}{% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Level</label>
              <select class="form-select form-select-sm" name="level">
                <option value="">All</option>
                {% for lvl in levels %}
                <option value="{{ lvl }}">{{ lvl }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Sort by</label>
              <select class="form-select form-select-sm" name="sort_by">
                <option value="name">Name</option>
                <option value="admission">Admission No</option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Order</label>
              <select class="form-select form-select-sm" name="order">
                <option value="az">A → Z</option>
                <option value="za">Z → A</option>
              </select>
            </div>
            <div class="col-12 col-md-6 d-flex align-items-end">
              <button type="submit" class="btn btn-outline-primary w-100"><i class="bi bi-download me-1"></i> Download</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    </div> <!-- /#admin-group -->

    <!-- Finance -->
    <div class="col-12 mt-2">
      <div class="section-divider d-flex align-items-center justify-content-between">
        <div><span class="divider-icon"><i class="bi bi-cash-coin"></i></span> <span class="divider-title">Finance</span></div>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#finance-group" aria-expanded="false" aria-controls="finance-group">
          <i class="bi bi-chevron-down"></i>
        </button>
      </div>
    </div>
    <div class="col-12 collapse" id="finance-group" data-bs-parent="#downloads-accordion">
    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2"><i class="bi bi-list-check"></i> Fee Assignments</h5>
          <p class="text-muted">All assigned fees per class and term.</p>
          <div class="d-flex gap-2">
            <a class="btn btn-outline-success dl-link" href="{% url 'export_fee_assignments_csv' %}" target="dl_frame"><i class="bi bi-download me-1"></i> fee-assignments.csv</a>
            <a class="btn btn-outline-secondary dl-link" href="{% url 'export_fee_assignments_pdf' %}" target="dl_frame"><i class="bi bi-filetype-pdf me-1"></i> fee-assignments.pdf</a>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2"><i class="bi bi-receipt"></i> Fee Payments</h5>
          <p class="text-muted">Every payment with method/category filters.</p>
          <form class="row g-2" method="get" action="{% url 'export_fee_payments_csv' %}">
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Method</label>
              <select class="form-select form-select-sm" name="method">
                <option value="">All</option>
                <option value="mpesa">Mpesa</option>
                <option value="cash">Cash</option>
                <option value="bank">Bank</option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Class</label>
              <select class="form-select form-select-sm" name="class_id">
                <option value="">All</option>
                {% for c in classes %}
                <option value="{{ c.id }}">{{ c.name }}{% if c.stream %} - {{ c.stream }}{% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Category</label>
              <select class="form-select form-select-sm" name="category_id">
                <option value="">All</option>
                {% for cat in fee_categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Term</label>
              <select class="form-select form-select-sm" name="term_id">
                <option value="">All</option>
                {% for t in terms %}
                <option value="{{ t.id }}">{{ t.name }} - {{ t.academic_year.year }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6 d-flex align-items-end gap-2">
              <button type="submit" class="btn btn-outline-success w-100"><i class="bi bi-download me-1"></i> CSV</button>
              <button type="submit" class="btn btn-outline-secondary w-100" formaction="{% url 'export_fee_payments_pdf' %}"><i class="bi bi-filetype-pdf me-1"></i> PDF</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2"><i class="bi bi-arrow-down-circle"></i> Students with Arrears</h5>
          <p class="text-muted">Download by class/term with sort by balance, name, or admission.</p>
          <form class="row g-2" method="get" action="{% url 'export_students_with_arrears_csv' %}">
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Class</label>
              <select class="form-select form-select-sm" name="class_id">
                <option value="">All</option>
                {% for c in classes %}
                <option value="{{ c.id }}">{{ c.name }}{% if c.stream %} - {{ c.stream }}{% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Term</label>
              <select class="form-select form-select-sm" name="term_id">
                <option value="">All</option>
                {% for t in terms %}
                <option value="{{ t.id }}">{{ t.name }} - {{ t.academic_year.year }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Sort by</label>
              <select class="form-select form-select-sm" name="sort_by">
                <option value="balance">Balance</option>
                <option value="name">Name</option>
                <option value="admission">Admission No</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small mb-1">Min balance</label>
              <input type="number" class="form-control form-control-sm" name="min_balance" step="0.01" placeholder="0" />
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small mb-1">Max balance</label>
              <input type="number" class="form-control form-control-sm" name="max_balance" step="0.01" placeholder="" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Order</label>
              <select class="form-select form-select-sm" name="order">
                <option value="desc">Largest → Smallest</option>
                <option value="asc">Smallest → Largest</option>
              </select>
            </div>
            <div class="col-12 col-md-6 d-flex align-items-end gap-2">
              <button type="submit" class="btn btn-outline-danger w-100"><i class="bi bi-download me-1"></i> CSV</button>
              <button type="submit" class="btn btn-outline-secondary w-100" formaction="{% url 'export_students_with_arrears_pdf' %}"><i class="bi bi-filetype-pdf me-1"></i> PDF</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2"><i class="bi bi-arrow-up-circle"></i> Students without Arrears</h5>
          <p class="text-muted">Download by class/term with sort options.</p>
          <form class="row g-2" method="get" action="{% url 'export_students_without_arrears_csv' %}">
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Class</label>
              <select class="form-select form-select-sm" name="class_id">
                <option value="">All</option>
                {% for c in classes %}
                <option value="{{ c.id }}">{{ c.name }}{% if c.stream %} - {{ c.stream }}{% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Term</label>
              <select class="form-select form-select-sm" name="term_id">
                <option value="">All</option>
                {% for t in terms %}
                <option value="{{ t.id }}">{{ t.name }} - {{ t.academic_year.year }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Sort by</label>
              <select class="form-select form-select-sm" name="sort_by">
                <option value="name">Name</option>
                <option value="admission">Admission No</option>
                <option value="balance">Balance</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small mb-1">Min balance</label>
              <input type="number" class="form-control form-control-sm" name="min_balance" step="0.01" placeholder="" />
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small mb-1">Max balance</label>
              <input type="number" class="form-control form-control-sm" name="max_balance" step="0.01" placeholder="" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Order</label>
              <select class="form-select form-select-sm" name="order">
                <option value="asc">Smallest → Largest</option>
                <option value="desc">Largest → Smallest</option>
              </select>
            </div>
            <div class="col-12 col-md-6 d-flex align-items-end">
              <button type="submit" class="btn btn-outline-success w-100"><i class="bi bi-download me-1"></i> Download</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    </div> <!-- /#finance-group -->

    <!-- Academics -->
    <div class="col-12 mt-2">
      <div class="section-divider d-flex align-items-center justify-content-between">
        <div><span class="divider-icon"><i class="bi bi-journal-bookmark"></i></span> <span class="divider-title">Academics</span></div>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#academics-group" aria-expanded="false" aria-controls="academics-group">
          <i class="bi bi-chevron-down"></i>
        </button>
      </div>
    </div>
    <div class="col-12 collapse" id="academics-group" data-bs-parent="#downloads-accordion">
    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2"><i class="bi bi-card-checklist"></i> Result Slips</h5>
          <p class="text-muted">Per-student subject scores for a selected exam. Filter by class or level.</p>
          <form class="row g-2" method="get" action="{% url 'export_result_slip_csv' %}">
            <div class="col-12">
              <label class="form-label small mb-1">Exam</label>
              <select class="form-select form-select-sm" required name="exam_id">
                <option value="" selected disabled>Select exam…</option>
                {% for e in exams %}
                <option value="{{ e.id }}">{{ e.name }} — {{ e.term.name }} ({{ e.term.academic_year.year }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Class</label>
              <select class="form-select form-select-sm" name="class_id">
                <option value="">All</option>
                {% for c in classes %}
                <option value="{{ c.id }}">{{ c.name }}{% if c.stream %} - {{ c.stream }}{% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Level</label>
              <select class="form-select form-select-sm" name="level">
                <option value="">All</option>
                {% for lv in levels %}
                <option value="{{ lv }}">{{ lv }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6 d-flex align-items-end gap-2">
              <button type="submit" class="btn btn-outline-primary w-100"><i class="bi bi-download me-1"></i> CSV</button>
              <button type="submit" class="btn btn-outline-secondary w-100" formaction="{% url 'export_result_slip_pdf' %}"><i class="bi bi-filetype-pdf me-1"></i> PDF</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-xl-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2"><i class="bi bi-people"></i> Class Students Export</h5>
          <p class="text-muted">Export students list for a selected class as CSV.</p>
          <form id="class-export-form" method="get" data-base-url="{% url 'api_download_class_students' 0 %}">
            <div class="d-flex gap-2">
              <select id="dl-class-id" class="form-select" required>
                <option value="" selected disabled>Select class…</option>
                {% for c in classes %}
                <option value="{{ c.id }}">{{ c.name }}{% if c.stream %} - {{ c.stream }}{% endif %}</option>
                {% endfor %}
              </select>
              <button id="dl-class-submit" type="submit" class="btn btn-secondary"><i class="bi bi-download"></i></button>
              <a id="dl-class-fallback" href="#" target="_blank" class="btn btn-link btn-sm" style="display:none">Open in new tab</a>
            </div>
            <div class="invalid-feedback d-block" style="display:none"></div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

<!-- Modal for Payment Verification -->
<div class="modal fade" id="verifyPaymentModal" tabindex="-1" aria-labelledby="verifyPaymentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="verifyPaymentModalLabel">Verify Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="verifyPaymentForm" autocomplete="off">
          <div class="mb-3">
            <label for="verifyReference" class="form-label">Payment Reference Code</label>
            <input type="text" class="form-control" id="verifyReference" name="verifyReference" required placeholder="Enter M-PESA reference code">
          </div>
          <div id="verifyResult" class="d-none"></div>
          <button type="submit" class="btn btn-primary" id="verifyBtn"><span id="verifyBtnText">Verify</span><span id="verifySpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span></button>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const verifyForm = document.getElementById('verifyPaymentForm');
  const verifyBtn = document.getElementById('verifyBtn');
  const verifyBtnText = document.getElementById('verifyBtnText');
  const verifySpinner = document.getElementById('verifySpinner');
  const verifyResult = document.getElementById('verifyResult');

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  if (verifyForm && verifyBtn && verifyBtnText && verifySpinner) {
    verifyForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const refInput = document.getElementById('verifyReference');
      const reference = (refInput?.value || '').trim();
      if (!reference) return;

      verifyBtn.disabled = true;
      verifyBtnText.textContent = 'Verifying...';
      verifySpinner.classList.remove('d-none');
      verifyBtn.classList.remove('btn-success');
      verifyBtn.classList.add('btn-primary');
      if (verifyResult) {
        verifyResult.className = 'd-none';
        verifyResult.textContent = '';
      }

      try {
        const res = await fetch('/verify_payment/by-reference/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: new URLSearchParams({ reference })
        });

        const data = await res.json();
        if (!res.ok || !data.success) {
          const msg = data?.error || 'Verification failed';
          if (verifyResult) {
            verifyResult.textContent = msg;
            verifyResult.classList.remove('d-none', 'alert-success');
            verifyResult.classList.add('alert', 'alert-danger');
          }
          verifyBtn.disabled = false;
          verifyBtnText.textContent = 'Verify';
          verifySpinner.classList.add('d-none');
          return;
        }

        // Success
        if (verifyResult) {
          verifyResult.textContent = 'Payment verified and approved.';
          verifyResult.classList.remove('d-none', 'alert-danger');
          verifyResult.classList.add('alert', 'alert-success');
        }
        verifyBtnText.textContent = 'Verified';
        verifySpinner.classList.add('d-none');
        verifyBtn.classList.remove('btn-primary');
        verifyBtn.classList.add('btn-success');
        // Optionally refresh after a short delay to reflect new balances/history
        setTimeout(() => { try { window.location.reload(); } catch(e) {} }, 1200);
      } catch (err) {
        if (verifyResult) {
          verifyResult.textContent = 'Network error while verifying.';
          verifyResult.classList.remove('d-none', 'alert-success');
          verifyResult.classList.add('alert', 'alert-danger');
        }
        verifyBtn.disabled = false;
        verifyBtnText.textContent = 'Verify';
        verifySpinner.classList.add('d-none');
      }
    });
  }
});
</script>

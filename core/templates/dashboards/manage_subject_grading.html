{% extends 'base.html' %}
{% block title %}Manage Subject Grading{% endblock %}
{% block content %}
<h1 class="mb-4">Manage Grading Scheme for {{ subject.name }}</h1>
<form method="post" class="mb-4">
  {% csrf_token %}
  <div class="mb-3">
    <label class="form-label">Grade Boundaries</label>
    <div id="grade-table-container">
      <table class="table table-bordered align-middle" id="grade-table">
        <thead class="table-light">
          <tr>
            <th>Grade</th>
            <th>Min Score</th>
            <th>Max Score</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="grade-table-body">
        </tbody>
      </table>
      <button type="button" class="btn btn-outline-primary btn-sm" onclick="addGradeRow()">Add Grade</button>
    </div>
    <input type="hidden" name="grade_boundaries" id="grade_boundaries">
    <div class="form-text">Set grade letters and score ranges. Example: A (80-100), B (70-79), etc.</div>
    {% if error %}<div class="text-danger">{{ error }}</div>{% endif %}
  </div>
  <script>
    // Parse initial data from backend
    let initialBoundaries = {};
    try { initialBoundaries = JSON.parse('{{ grade_boundaries_json|escapejs }}'); } catch(e) {}
    function renderTable(boundaries) {
      const tbody = document.getElementById('grade-table-body');
      tbody.innerHTML = '';
      Object.entries(boundaries).forEach(([grade, range], idx) => {
        tbody.appendChild(makeRow(grade, range[0], range[1], idx));
      });
    }
    function makeRow(grade, min, max, idx) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><input type='text' class='form-control' value='${grade}' onchange='updateTable()' maxlength='2' style='width:4em'></td>
        <td><input type='number' class='form-control' value='${min}' onchange='updateTable()' step='0.1' min='0' max='100'></td>
        <td><input type='number' class='form-control' value='${max}' onchange='updateTable()' step='0.1' min='0' max='100'></td>
        <td><button type='button' class='btn btn-danger btn-sm' onclick='removeGradeRow(this)'>Remove</button></td>`;
      return tr;
    }
    function updateTable() {
      const tbody = document.getElementById('grade-table-body');
      const rows = Array.from(tbody.children);
      const boundaries = {};
      for (const row of rows) {
        const cells = row.querySelectorAll('input');
        const grade = cells[0].value.trim();
        const min = parseFloat(cells[1].value);
        const max = parseFloat(cells[2].value);
        if (grade && !isNaN(min) && !isNaN(max)) {
          boundaries[grade] = [min, max];
        }
      }
      document.getElementById('grade_boundaries').value = JSON.stringify(boundaries);
    }
    function addGradeRow() {
      const tbody = document.getElementById('grade-table-body');
      tbody.appendChild(makeRow('', '', '', tbody.children.length));
    }
    function removeGradeRow(btn) {
      btn.closest('tr').remove();
      updateTable();
    }
    // Make functions global for inline onclick
    window.addGradeRow = addGradeRow;
    window.removeGradeRow = removeGradeRow;
    // Initial render
    document.addEventListener('DOMContentLoaded', function() {
      renderTable(initialBoundaries);
      updateTable();
    });
    // Update JSON before submit
    document.querySelector('form').addEventListener('submit', updateTable);
  </script>
  <button type="submit" class="btn btn-success">Save Grading Scheme</button>
  <a href="{% url 'admin_subjects' %}" class="btn btn-secondary ms-2">Back to Subjects</a>
</form>
{% if last_updated %}
<div class="alert alert-info">Last updated: {{ last_updated }} by {{ updated_by }}</div>
{% endif %}
{% endblock %}

{% extends 'base.html' %}
{% block title %}Record Fee Payment{% endblock %}
{% block content %}
<div class="container mt-4">
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-2" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
    {% if current_term %}
    <div class="alert alert-success mb-3">
        <strong>Current Term:</strong> {{ current_term.name }} ({{ current_term.start_date|date:'M d, Y' }} to {{ current_term.end_date|date:'M d, Y' }}) in Academic Year {{ current_term.academic_year.year }}
        <a href="{% url 'admin_academic_years' %}" class="btn btn-outline-primary btn-sm float-end">Manage Terms & Academic Years</a>
    </div>
    {% endif %}
    <h2 class="mb-4">Record Fee Payment</h2>
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <button type="button" class="btn btn-outline-secondary mb-3" id="openVerifyPaymentModal" data-bs-toggle="modal" data-bs-target="#verifyPaymentModal">
    Verify Payment
</button>
        </div>
        <div class="card-body">
            <div id="paymentSuccessAlert" class="alert alert-success d-none" role="alert">
  Payment initiated successfully!
</div>
            <form id="paymentForm" method="post" autocomplete="off">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="student_id" class="form-label">Student</label>
                    <select class="form-select" id="student_id" name="student_id" required>
    {% for student in students %}
        <option value="{{ student.id }}" {% if selected_student_id|stringformat:"s" == student.id|stringformat:"s" %}selected{% endif %}>{{ student.full_name }} ({{ student.admission_no }})</option>
    {% endfor %}
</select>
                </div>
                <div class="mb-3">
                    <label for="amount_paid" class="form-label">Amount</label>
                    <input type="number" step="0.01" min="0" class="form-control" id="amount_paid" name="amount_paid" required>
                </div>
                <div class="mb-3">
    <label for="payment_method" class="form-label">Payment Method</label>
    <select class="form-select" id="payment_method" name="payment_method" required>
        <option value="">-- Select Payment Method --</option>
        <option value="Cash">Cash</option>
        <option value="Bank">Bank</option>
        <option value="Mpesa Paybill">Mpesa Paybill</option>
    </select>
</div>
<div class="mb-3" id="reference_group">
    <label for="reference" class="form-label">Reference / Receipt No.</label>
    <input type="text" class="form-control" id="reference" name="reference" placeholder="e.g. Cash Receipt #123 or Bank Txn ABC123" maxlength="100">
    <div class="form-text">Recommended for Bank deposits; optional for Cash.</div>
</div>
<div class="mb-3 d-none" id="phone_group">
    <label for="phone_number" class="form-label">Phone Number (for STK Push)</label>
    <input type="text" class="form-control" id="phone_number" name="phone_number" placeholder="e.g. 0712345678" pattern="^0[7][0-9]{8}$" maxlength="10" minlength="10" inputmode="numeric" aria-describedby="phoneHelp">
    <div id="phoneHelp" class="form-text">Enter a valid Safaricom number starting with 07XXXXXXXX.</div>
    <div class="invalid-feedback">
        Please enter a valid Safaricom phone number (e.g. 0712345678).
    </div>
</div>

                <button type="submit" class="btn btn-primary" id="submitBtn">
  <span id="submitSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
  <span id="submitBtnText">Record Payment</span>
</button>
            </form>
        </div>
    </div>
    <!-- Admin Payment Status Table -->
    {% if request.user.is_authenticated and request.user.role == 'admin' %}
    <div class="card mt-5">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">All Payments (Completed & Pending)</h5>
        </div>
        <div class="card-body p-0">
            <form method="get" class="p-3 border-bottom bg-light">
                <div class="row g-2 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">Search</label>
                        <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Name or Admission No">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Method</label>
                        <select name="method" class="form-select">
                            <option value="">All</option>
                            <option value="Cash" {% if method == 'Cash' %}selected{% endif %}>Cash</option>
                            <option value="Bank" {% if method == 'Bank' %}selected{% endif %}>Bank</option>
                            <option value="Mpesa Paybill" {% if method == 'Mpesa Paybill' %}selected{% endif %}>Mpesa Paybill</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select">
                            <option value="">All</option>
                            <option value="Completed" {% if status_filter == 'Completed' %}selected{% endif %}>Completed</option>
                            <option value="Pending" {% if status_filter == 'Pending' %}selected{% endif %}>Pending</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Start</label>
                        <input type="date" name="start" value="{{ start }}" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">End</label>
                        <input type="date" name="end" value="{{ end }}" class="form-control">
                    </div>
                    <div class="col-md-1 d-grid">
                        <button class="btn btn-primary" type="submit">Filter</button>
                    </div>
                </div>
            </form>
            <div class="table-responsive">
                <table class="table table-bordered table-striped mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Student</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Reference</th>
                            <th>Phone</th>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in all_payments %}
                        <tr class="{% if payment.status == 'Pending' %}table-warning{% elif payment.status == 'Completed' %}table-success{% endif %}">
                            <td>{{ payment.student.full_name }} ({{ payment.student.admission_no }})</td>
                            <td>Ksh. {{ payment.amount_paid }}</td>
                            <td>{{ payment.payment_method }}</td>
                            <td>{{ payment.reference|default:'-' }}</td>
                            <td>{{ payment.phone_number|default:'-' }}</td>
                            <td>{{ payment.payment_date|date:'Y-m-d H:i' }}</td>
                            <td><strong>{{ payment.status }}</strong></td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="7" class="text-center">No payments found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- End Admin Payment Status Table -->
{% include 'dashboards/partials/verify_payment_modal.html' %}
</div>
{% if all_payments %}
<nav aria-label="Payments pagination" class="mt-3">
  <ul class="pagination justify-content-center">
    {% if all_payments.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page=1{% if selected_student_id %}&student_id={{ selected_student_id }}{% endif %}{% if q %}&q={{ q }}{% endif %}{% if method %}&method={{ method }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if start %}&start={{ start }}{% endif %}{% if end %}&end={{ end }}{% endif %}">&laquo; First</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ all_payments.previous_page_number }}{% if selected_student_id %}&student_id={{ selected_student_id }}{% endif %}{% if q %}&q={{ q }}{% endif %}{% if method %}&method={{ method }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if start %}&start={{ start }}{% endif %}{% if end %}&end={{ end }}{% endif %}">Previous</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&laquo; First</span></li>
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}

    <li class="page-item disabled"><span class="page-link">Page {{ all_payments.number }} of {{ all_payments.paginator.num_pages }}</span></li>

    {% if all_payments.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ all_payments.next_page_number }}{% if selected_student_id %}&student_id={{ selected_student_id }}{% endif %}{% if q %}&q={{ q }}{% endif %}{% if method %}&method={{ method }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if start %}&start={{ start }}{% endif %}{% if end %}&end={{ end }}{% endif %}">Next</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ all_payments.paginator.num_pages }}{% if selected_student_id %}&student_id={{ selected_student_id }}{% endif %}{% if q %}&q={{ q }}{% endif %}{% if method %}&method={{ method }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if start %}&start={{ start }}{% endif %}{% if end %}&end={{ end }}{% endif %}">Last &raquo;</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
      <li class="page-item disabled"><span class="page-link">Last &raquo;</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}
<script>
window.addEventListener('DOMContentLoaded', function() {
    const paymentMethod = document.getElementById('payment_method');
    const phoneGroup = document.getElementById('phone_group');
    const referenceGroup = document.getElementById('reference_group');
    const submitBtnText = document.getElementById('submitBtnText');
    const submitBtn = document.getElementById('submitBtn');
    const submitSpinner = document.getElementById('submitSpinner');
    console.log('JS loaded: paymentMethod:', paymentMethod, 'phoneGroup:', phoneGroup, 'submitBtnText:', submitBtnText);
    function togglePhoneFieldAndButton() {
        if (!submitBtnText) {
            console.warn('submitBtnText element not found!');
        }
        if (paymentMethod && phoneGroup && paymentMethod.value === 'Mpesa Paybill') {
            phoneGroup.classList.remove('d-none');
            document.getElementById('phone_number').required = true;
            if (submitBtnText) submitBtnText.textContent = 'Initiate Payment';
            console.log('Set button text to Initiate Payment');
            if (referenceGroup) referenceGroup.classList.add('d-none');
            const refInput = document.getElementById('reference');
            if (refInput) refInput.required = false;
        } else if (paymentMethod && phoneGroup) {
            phoneGroup.classList.add('d-none');
            document.getElementById('phone_number').required = false;
            if (submitBtnText) submitBtnText.textContent = 'Record Payment';
            console.log('Set button text to Record Payment');
            if (referenceGroup) referenceGroup.classList.remove('d-none');
            const refInput = document.getElementById('reference');
            if (refInput) {
                refInput.required = (paymentMethod.value === 'Bank');
            }
        }
    }
    if (paymentMethod && phoneGroup) {
        paymentMethod.addEventListener('change', togglePhoneFieldAndButton);
        togglePhoneFieldAndButton(); // initial state
    }
    const form = document.getElementById('paymentForm');
    form.addEventListener('submit', function(e) {
        if (submitBtnText.textContent === 'Initiate Payment') {
            submitBtnText.textContent = 'Initiating Payment...';
            submitSpinner.classList.remove('d-none');
            submitBtn.disabled = true;
            // Simulate payment initiation success after 1.5s (for demo)
            setTimeout(function() {
                submitBtnText.textContent = 'Payment Initiated Successfully';
                submitSpinner.classList.add('d-none');
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-success');
                // Keep button disabled
            }, 1500);
        }
    });
});
</script>
{% endblock %}

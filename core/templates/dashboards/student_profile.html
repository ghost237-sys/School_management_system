{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
    <style>
      /* Mobile-first refinements for student profile dashboard */
      .fee-card .card-body { padding: 1rem; }
      .fee-card .metric-title { font-size: 1rem; }
      .fee-card .metric-value { font-size: 1.25rem; font-weight: 700; }
      .fee-card .metric-icon { font-size: 1.5rem; margin-right: .75rem; }

      /* Make nav tabs scrollable on small screens */
      .nav-tabs { flex-wrap: nowrap; overflow-x: auto; overflow-y: hidden; }
      .nav-tabs .nav-link { white-space: nowrap; }

      /* Wrap action buttons and reduce size on very small widths */
      .action-buttons { gap: .5rem; flex-wrap: wrap; }
      @media (max-width: 576.98px) {
        .btn-lg { padding: .45rem .75rem; font-size: .95rem; }
        .fee-card .metric-title { font-size: .95rem; }
        .fee-card .metric-value { font-size: 1.15rem; }
        .fee-card .metric-icon { font-size: 1.35rem; }
        .profile-photo { width: 120px !important; height: 135px !important; }
        .card-header { align-items: flex-start !important; }
      }

      /* Ensure tables are scrollable horizontally on mobile */
      .table-responsive-mobile { overflow-x: auto; }
    </style>
    <div class="d-flex justify-content-end mb-3">
    <a href="{% url 'logout' %}" class="btn btn-outline-danger">
        <i class="bi bi-power"></i> Log Out
    </a>
</div>
<!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" id="studentProfileTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">Dashboard</button>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab" aria-controls="performance" aria-selected="false">Performance</a>
      </li>
    </ul>
    <!-- End Tab Navigation -->
<div class="tab-content" id="studentProfileTabsContent">
  <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">

    {% if current_term %}
    <div class="alert alert-success">
        <strong>Current Term:</strong> {{ current_term.name }} ({{ current_term.start_date|date:'M d, Y' }} to {{ current_term.end_date|date:'M d, Y' }}) in Academic Year {{ current_term.academic_year.year }}
    </div>
    {% endif %}
    <!-- Fee Summary Cards -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-md-4">
            <div class="card text-white fee-card" style="background-color: #f39c12;">
                <div class="card-body d-flex align-items-center">
                    <div class="metric-icon"><i class="fa fa-tag"></i></div>
                    <div>
                        <div class="metric-title">TOTAL BILLED:</div>
                        <div class="metric-value">Ksh. {{ total_billed|floatformat:2 }}</div>
                        <a href="#" class="btn btn-link text-white p-0" data-bs-toggle="modal" data-bs-target="#feeDetailsModal" data-tab="billed">View Details <i class="fa fa-arrow-circle-right"></i></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card text-white fee-card" style="background-color: #16a085;">
                <div class="card-body d-flex align-items-center">
                    <div class="metric-icon"><i class="fa fa-heart"></i></div>
                    <div>
                        <div class="metric-title">TOTAL PAID:</div>
                        <div class="metric-value">Ksh. {{ total_paid|floatformat:2 }}</div>
                        <a href="#" class="btn btn-link text-white p-0" data-bs-toggle="modal" data-bs-target="#feeDetailsModal" data-tab="paid">View Details <i class="fa fa-arrow-circle-right"></i></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card text-white fee-card" style="background-color: #00bcd4;">
                <div class="card-body d-flex align-items-center">
                    <div class="metric-icon"><i class="fa fa-comment"></i></div>
                    <div>
                        <div class="metric-title">BALANCE:</div>
                        <div class="metric-value">Ksh. {{ balance|floatformat:2 }}</div>
                        <a href="#" class="btn btn-link text-white p-0" data-bs-toggle="modal" data-bs-target="#feeDetailsModal" data-tab="billed">View Details <i class="fa fa-arrow-circle-right"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Ranking Widgets -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-md-4">
        <div class="card border-0" style="background:#f8f9fa;">
          <div class="card-body d-flex align-items-center">
            <div class="metric-icon me-3" style="font-size:1.5rem;"><i class="fa fa-trophy text-warning"></i></div>
            <div>
              <div class="metric-title">Class Rank</div>
              <div class="metric-value">
                {% if class_rank %} {{ class_rank }} <small class="text-muted">/ {{ class_total }}</small>{% else %} N/A {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card border-0" style="background:#f8f9fa;">
          <div class="card-body d-flex align-items-center">
            <div class="metric-icon me-3" style="font-size:1.5rem;"><i class="fa fa-globe text-success"></i></div>
            <div>
              <div class="metric-title">Overall Level Rank</div>
              <div class="metric-value">
                {% if overall_level_rank %} {{ overall_level_rank }} <small class="text-muted">/ {{ overall_level_total }}</small>{% else %} N/A {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Profile and Info Section -->
    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <strong>User Profile</strong>
    <div class="d-flex gap-2">
        <a href="{% url 'student_messaging' %}" class="btn btn-outline-success btn-sm">
            Message Admin/Class Teacher
        </a>
        <a href="{% url 'student_messaging' %}?recipient_role=clerk" class="btn btn-outline-primary btn-sm">
            Message Clerk
        </a>
    </div>
                    <button class="btn btn-sm btn-outline-secondary float-end" title="Close" onclick="this.closest('.card').remove();">&times;</button>
                </div>
                <div class="card-body text-center">
                    {% if student.photo %}
                        <img src="{{ student.photo.url }}" class="rounded mb-2 profile-photo" style="width:160px;height:180px;object-fit:cover;" alt="Profile Photo">
                    {% else %}
                        <img src="https://ui-avatars.com/api/?name={{ student.user.get_full_name|default:student.user.username|urlencode }}&size=180" class="rounded mb-2 profile-photo" style="width:160px;height:180px;object-fit:cover;" alt="Profile Photo">
                    {% endif %}
                    <div class="fw-bold fs-5 mt-2">{{ student.admission_no }}</div>
                    <div class="text-muted mb-2"><b>Programme</b><br> {{ student.class_group.name }}</div>
                    <hr>
                    <div class="accordion" id="profileAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="stageHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#stageCollapse" aria-expanded="false" aria-controls="stageCollapse">
                                    My Stage
                                </button>
                            </h2>
                            <div id="stageCollapse" class="accordion-collapse collapse" aria-labelledby="stageHeading" data-bs-parent="#profileAccordion">
                                <div class="accordion-body">
                                    <!-- Stage info placeholder -->
                                    {{ student.class_group.level|default:'N/A' }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header bg-light d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
                    <strong class="me-md-3">Personal Information</strong>
                    <div class="ms-md-auto d-flex flex-wrap align-items-center gap-2">
                        <div class="btn-group btn-group-sm me-md-2 flex-wrap" role="group" aria-label="Print actions">
                            {% if can_view_results %}
                              <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#actionChooseModal" data-section="result-slip-section" data-title="Result Slip"><i class="fa fa-file"></i> Result Slip</button>
                            {% else %}
                              <button class="btn btn-outline-primary disabled" title="{{ fee_restriction_message }}" data-restricted="1" data-section="result-slip-section" data-title="Result Slip"><i class="fa fa-file"></i> Result Slip</button>
                            {% endif %}
                            <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#actionChooseModal" data-section="fees-statement-section" data-title="Fees Statement"><i class="fa fa-file"></i> Fees Statement</button>
                            <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#actionChooseModal" data-section="fees-structure-section" data-title="Fees Structure"><i class="fa fa-file"></i> Fees Structure</button>
                        </div>
                        <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#editContactModal">Update Profile</button>
                    </div>
                </div>
                <div class="card-body">
                    {% if restrict_results_by_fee and not can_view_results and user.role == 'student' %}
                    <div class="alert alert-warning d-flex align-items-start" role="alert">
                      <i class="bi bi-exclamation-triangle-fill me-2"></i>
                      <div>
                        {{ fee_restriction_message }}
                      </div>
                    </div>
                    {% endif %}
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">Admission No:</div>
                        <div class="col-sm-8">{{ student.admission_no }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">ID/Passport:</div>
                        <div class="col-sm-8">{{ student.id_number|default:'-' }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">Full Name:</div>
                        <div class="col-sm-8">{{ student.user.get_full_name|default:student.user.username }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">Gender:</div>
                        <div class="col-sm-8">{{ student.gender|title }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">Date of Birth:</div>
                        <div class="col-sm-8">{{ student.birthdate|date:'d/m/Y' }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">Phone Number:</div>
                        <div class="col-sm-8">{{ student.phone|default:'-' }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">Email Address:</div>
                        <div class="col-sm-8">{{ student.user.email }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">Postal Address:</div>
                        <div class="col-sm-8">{{ student.postal_address|default:'-' }}</div>
                    </div>

                    {% if can_update_contact %}
<div class="text-end mb-2">
    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editContactModal" title="Edit Contact Info">
        <i class="bi bi-pencil"></i>
    </button>
</div>
{% endif %}

<!-- Modal: Always rendered for all users -->
<div class="modal fade" id="editContactModal" tabindex="-1" aria-labelledby="editContactModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editContactModalLabel">Update Contact Information</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post">
        <div class="modal-body">
            {% csrf_token %}
            <div class="mb-3">
                <label class="form-label">Phone Number</label>
                {{ contact_form.phone }}
            </div>
            <div class="mb-3">
                <label class="form-label">Email Address</label>
                {{ contact_form.email }}
            </div>
            <div class="mb-3">
                <label class="form-label">Postal Address</label>
                {{ contact_form.postal_address }}
            </div>
            {% if contact_form.errors %}
                <div class="alert alert-danger mt-2">{{ contact_form.errors }}</div>
            {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" name="update_contact" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Export Progress Modal -->
<div class="modal fade" id="exportProgressModal" tabindex="-1" aria-labelledby="exportProgressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exportProgressModalLabel">Preparing PDF…</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="progress" role="progressbar" aria-label="PDF progress" aria-valuemin="0" aria-valuemax="100">
          <div id="exportProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">0%</div>
        </div>
        <div id="exportStatus" class="mt-2 small text-muted">Starting…</div>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <div id="exportError" class="text-danger small d-none"></div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hide</button>
      </div>
    </div>
  </div>
  </div>

<!-- Attendance Section -->
<div class="card mb-4" id="attendance-section">
  <div class="card-header bg-light d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
    <strong class="me-md-3">Attendance</strong>
    <form method="get" class="ms-md-auto d-flex align-items-center gap-2">
      <label for="att_term" class="form-label mb-0">Term</label>
      <select name="att_term" id="att_term" class="form-select form-select-sm" onchange="this.form.submit()">
        <option value="">All</option>
        {% for t in attendance_terms %}
          <option value="{{ t.id }}" {% if attendance_current_term_id == t.id %}selected{% endif %}>
            {{ t.name }} - {{ t.academic_year.year }}
          </option>
        {% endfor %}
      </select>
    </form>
  </div>
  <div class="card-body">
    <div class="row g-2 mb-3">
      <div class="col-6 col-md-2">
        <div class="border rounded p-2 text-center">
          <div class="text-muted" style="font-size: .85rem;">Total Lessons</div>
          <div class="fw-bold">{{ attendance_summary.total }}</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="border rounded p-2 text-center">
          <div class="text-muted" style="font-size: .85rem;">Present</div>
          <div class="fw-bold text-success">{{ attendance_summary.present }}</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="border rounded p-2 text-center">
          <div class="text-muted" style="font-size: .85rem;">Absent</div>
          <div class="fw-bold text-danger">{{ attendance_summary.absent }}</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="border rounded p-2 text-center">
          <div class="text-muted" style="font-size: .85rem;">Late</div>
          <div class="fw-bold text-warning">{{ attendance_summary.late }}</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="border rounded p-2 text-center">
          <div class="text-muted" style="font-size: .85rem;">Excused</div>
          <div class="fw-bold text-info">{{ attendance_summary.excused }}</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="border rounded p-2 text-center">
          <div class="text-muted" style="font-size: .85rem;">Attendance Rate</div>
          <div class="fw-bold">{{ attendance_summary.rate }}%</div>
        </div>
      </div>
    </div>
    <div class="table-responsive-mobile">
      <table class="table table-sm table-striped align-middle">
        <thead>
          <tr>
            <th>Date</th>
            <th>Subject</th>
            <th>Status</th>
            <th>Teacher</th>
          </tr>
        </thead>
        <tbody>
          {% for att in attendance_records %}
            <tr>
              <td>{{ att.date|date:'Y-m-d' }}</td>
              <td>{{ att.subject.name }}</td>
              <td>
                {% if att.status == 'present' %}<span class="badge bg-success">Present</span>
                {% elif att.status == 'absent' %}<span class="badge bg-danger">Absent</span>
                {% elif att.status == 'late' %}<span class="badge bg-warning text-dark">Late</span>
                {% elif att.status == 'excused' %}<span class="badge bg-info text-dark">Excused</span>
                {% else %}{{ att.status|title }}{% endif %}
              </td>
              <td>{{ att.teacher.user.get_full_name|default:att.teacher.user.username }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="4" class="text-center">No attendance records found for the selected term.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>


                    <div class="text-end mt-3">
                        {% if user.role == 'admin' %}
<a href="{% url 'admin_payment' %}?student_id={{ student.id }}" class="btn btn-success btn-lg"><i class="fa fa-credit-card"></i> Make Payment</a>
<button type="button" class="btn btn-outline-primary btn-lg ms-2" data-bs-toggle="modal" data-bs-target="#editContactModal" title="Edit Profile">
    <i class="bi bi-pencil"></i>
</button>
{% else %}
<a href="{% url 'student_fees' %}" class="btn btn-success btn-lg"><i class="fa fa-credit-card"></i> Make Payment</a>
<button type="button" class="btn btn-outline-primary btn-lg ms-2" data-bs-toggle="modal" data-bs-target="#editContactModal" title="Edit Profile">
    <i class="bi bi-pencil"></i>
</button>
{% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

  </div>
  <div class="tab-pane fade" id="performance" role="tabpanel" aria-labelledby="performance-tab">
    {% if can_view_results %}
      <div id="result-slip-section">
        {% include 'dashboards/student_report_card.html' with student=student grades=grades average_score=average_score term=current_term %}
      </div>
    {% else %}
      <div class="alert alert-warning mt-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        {{ fee_restriction_message }}
      </div>
    {% endif %}
    <!-- html2pdf for client-side PDF downloads (no SRI to avoid mismatch blocking) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- dom-to-image fallback for more reliable rasterization -->
<script src="https://cdn.jsdelivr.net/npm/dom-to-image-more@3.4.0/dist/dom-to-image-more.min.js"></script>
  </div>
<!-- Fee Details Modal -->
<div class="modal fade" id="feeDetailsModal" tabindex="-1" aria-labelledby="feeDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="feeDetailsModalLabel">Fee Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs mb-3" id="feeDetailsTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="billed-tab" data-bs-toggle="tab" data-bs-target="#billed" type="button" role="tab">Assigned Fees</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="paid-tab" data-bs-toggle="tab" data-bs-target="#paid" type="button" role="tab">Payment History</button>
          </li>
        </ul>
        <div class="tab-content" id="feeDetailsTabsContent">
          <div class="tab-pane fade show active" id="billed" role="tabpanel">
    <div id="fees-structure-section" class="table-responsive-mobile">
        <h6>Assigned Fees</h6>
        <table class="table table-bordered mb-0">
          <thead>
            <tr>
              <th>Fee Category</th>
              <th>Amount</th>
              <th>Paid</th>
              <th>Outstanding</th>
            </tr>
          </thead>
          <tbody>
          {% for assignment in fee_assignments %}
            <tr>
              <td>{{ assignment.fee_category.name }}</td>
              <td>{{ assignment.amount }}</td>
              <td>{{ assignment.paid }}</td>
              <td>{{ assignment.outstanding }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="4">No fees assigned for this term.</td></tr>
          {% endfor %}
          </tbody>
        </table>
    </div>
</div>
          <div class="tab-pane fade" id="paid" role="tabpanel">
    <div id="fees-statement-section" class="table-responsive-mobile">
        <h6>Payment History</h6>
        <table class="table table-sm table-striped mb-0">
          <thead>
            <tr>
              <th>Date</th>
              <th>Fee Category</th>
              <th>Amount Paid</th>
              <th>Method</th>
              <th>Reference</th>
            </tr>
          </thead>
          <tbody>
          {% for payment in fee_payments|dictsortreversed:'payment_date' %}
            <tr>
              <td>{{ payment.payment_date|date:'Y-m-d H:i' }}</td>
              <td>{{ payment.fee_assignment.fee_category.name }}</td>
              <td>{{ payment.amount_paid }}</td>
              <td>{{ payment.payment_method|default:'-' }}</td>
              <td>{{ payment.reference|default:'-' }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="5">No payments recorded.</td></tr>
          {% endfor %}
          </tbody>
        </table>
    </div>
</div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Exam Select Modal (only for Result Slip) -->
<div class="modal fade" id="examSelectModal" tabindex="-1" aria-labelledby="examSelectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="examSelectModalLabel">Select Exam to Print/Download</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% if published_exams and published_exams.exists %}
          <div class="mb-3">
            <label for="examSelect" class="form-label">Exam</label>
            <select id="examSelect" class="form-select">
              {% for ex in published_exams %}
                <option value="{{ ex.id }}" {% if selected_exam and selected_exam.id == ex.id %}selected{% endif %}>
                  {{ ex.name }} — {{ ex.term.name }} ({{ ex.term.academic_year.year }})
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="small text-muted">Only published exams are available.</div>
        {% else %}
          <div class="alert alert-info mb-0">
            There are no published exams available for this student yet.
          </div>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        {% if published_exams and published_exams.exists %}
          <button type="button" class="btn btn-primary" id="confirmExamSelectBtn">Continue</button>
        {% endif %}
      </div>
    </div>
  </div>
  </div>

<!-- Action choose modal (Download or Print) -->
<div class="modal fade" id="actionChooseModal" tabindex="-1" aria-labelledby="actionChooseModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="actionChooseModalLabel">Choose Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">Would you like to download a PDF or print?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-info" id="choosePrintBtn"><i class="fa fa-print"></i> Print</button>
        <button type="button" class="btn btn-primary" id="chooseDownloadBtn"><i class="fa fa-download"></i> Download PDF</button>
      </div>
    </div>
  </div>
  </div>

<script>
// Flag from backend to indicate if results are restricted for this viewer
// Use string comparisons to keep JS parsers happy before Django templating runs
const __restrictResultsByFee = "{{ restrict_results_by_fee|yesno:'true,false' }}" === 'true';
const __canViewResults = "{{ can_view_results|yesno:'true,false' }}" === 'true';
window.resultsRestricted = __restrictResultsByFee && !__canViewResults;
window.resultsRestrictionMessage = "{{ fee_restriction_message|escapejs }}";
// Exam publishing/selection flags
const __selectedExamIdStr = "{{ selected_exam.id|default:'' }}";
window.selectedExamId = __selectedExamIdStr ? parseInt(__selectedExamIdStr, 10) : null;
const __publishedExamsCountStr = "{{ published_exams|length|default:'0' }}";
window.publishedExamsCount = parseInt(__publishedExamsCountStr, 10);

// Switch to correct tab when opening modal from a card
const feeDetailsModal = document.getElementById('feeDetailsModal');
if (feeDetailsModal) {
  feeDetailsModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    if (!button) return;
    const tab = button.getAttribute('data-tab');
    if (!tab) return;
    const tabBtn = document.getElementById(tab+'-tab');
    if (tabBtn) {
      const tabTrigger = new bootstrap.Tab(tabBtn);
      tabTrigger.show();
    }
  });
}

function printSection(sectionId, title) {
  const content = document.getElementById(sectionId);
  if (!content) {
    alert('Section not found!');
    return;
  }

  const printWindow = window.open('', '', 'height=800,width=1000');
  const styles = Array.from(document.querySelectorAll('link[rel=stylesheet], style')).map(node => node.outerHTML).join('');
  const now = new Date().toLocaleString();
  const studentName = "{{ student.user.get_full_name|default:student.user.username }}";
  const adm = "{{ student.admission_no }}";
  const term = "{{ current_term.name|default:'-' }}";

  printWindow.document.write(`<!doctype html>
  <html><head><meta charset="utf-8"><title>${title}</title>${styles}
  <style>
    @media print { .no-print { display:none!important; } }
    body { padding: 24px; }
    .print-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; border-bottom:1px solid #ddd; padding-bottom:10px; }
    .print-header h2 { margin:0; font-size:1.25rem; }
    .print-meta { font-size:.9rem; color:#555; }
  </style></head><body>`);

  printWindow.document.write(`
    <div class="print-header">
      <div style="display:flex;align-items:center;gap:12px;">
        {% if school.logo %}
          <img src="{{ school.logo.url }}" alt="Logo" style="height:54px;width:auto;object-fit:contain;">
        {% endif %}
        <div>
          <div style="font-weight:800;font-size:1.1rem;line-height:1.2;">{{ school.name|default:'School' }}</div>
          {% if school.motto %}<div style="font-size:.9rem;color:#666;">{{ school.motto }}</div>{% endif %}
          <div style="font-size:.95rem;margin-top:4px;">${title}</div>
        </div>
      </div>
      <div class="print-meta" style="text-align:right;">
        <div>Generated: ${now}</div>
        <div>Adm: ${adm}</div>
        <div>Term: ${term}</div>
      </div>
    </div>
  `);

  // Clone the section HTML
  printWindow.document.write(`<div>${content.outerHTML}</div>`);
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.focus();
  printWindow.onload = function() {
    printWindow.print();
    setTimeout(() => { printWindow.close(); }, 300);
  };
}

// Wire the chooser modal to either download or print
let selectedSectionId = null;
let selectedTitle = null;
const actionChooseModal = document.getElementById('actionChooseModal');
if (actionChooseModal) {
  actionChooseModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    selectedSectionId = button?.getAttribute('data-section');
    selectedTitle = button?.getAttribute('data-title');
    // If opened programmatically (no button), default to result slip if an exam was selected
    if (!button && (!selectedSectionId || !selectedTitle) && window.selectedExamId) {
      selectedSectionId = 'result-slip-section';
      selectedTitle = 'Result Slip';
    }
    // Block opening for restricted result slip
    if (window.resultsRestricted && selectedSectionId === 'result-slip-section') {
      event.preventDefault();
      event.stopPropagation();
      const msg = window.resultsRestrictionMessage || 'Results access is restricted due to outstanding fees.';
      alert(msg);
      return false;
    }
    // If result slip and no selected exam yet, force exam picker first
    if (selectedSectionId === 'result-slip-section') {
      const hasSelectedExam = !!window.selectedExamId;
      if (!hasSelectedExam) {
        event.preventDefault();
        event.stopPropagation();
        if (!window.publishedExamsCount || Number(window.publishedExamsCount) === 0) {
          alert('No published exams available to print or download.');
          return false;
        }
        const examModalEl = document.getElementById('examSelectModal');
        const examModal = new bootstrap.Modal(examModalEl);
        examModal.show();
        return false;
      }
    }
  });
  document.getElementById('chooseDownloadBtn').addEventListener('click', function(){
    if (selectedSectionId && selectedTitle) {
      if (window.resultsRestricted && selectedSectionId === 'result-slip-section') {
        alert(window.resultsRestrictionMessage || 'Results access is restricted due to outstanding fees.');
        return;
      }
      const modal = bootstrap.Modal.getInstance(actionChooseModal);
      modal?.hide();
      // debug
      try { console.debug('Download PDF for section', selectedSectionId, 'title', selectedTitle, 'exam', window.selectedExamId); } catch(_) {}
      downloadSection(selectedSectionId, selectedTitle);
    }
  });
  document.getElementById('choosePrintBtn').addEventListener('click', function(){
    if (selectedSectionId && selectedTitle) {
      if (window.resultsRestricted && selectedSectionId === 'result-slip-section') {
        alert(window.resultsRestrictionMessage || 'Results access is restricted due to outstanding fees.');
        return;
      }
      const modal = bootstrap.Modal.getInstance(actionChooseModal);
      modal?.hide();
      // debug
      try { console.debug('Print section', selectedSectionId, 'title', selectedTitle, 'exam', window.selectedExamId); } catch(_) {}
      printSection(selectedSectionId, selectedTitle);
    }
  });
}

// Helper: fetch server-rendered result slip for a specific exam and return a detached DOM node
async function fetchResultSlipNodeForExam(examId) {
  try {
    const url = new URL(window.location.href);
    url.searchParams.set('exam_id', String(examId));
    url.searchParams.set('tab', 'performance');
    const resp = await fetch(url.toString(), { credentials: 'same-origin' });
    if (!resp.ok) throw new Error('Failed to load exam result slip');
    const html = await resp.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const node = doc.getElementById('result-slip-section');
    return node ? node.cloneNode(true) : null;
  } catch (e) {
    console.warn('fetchResultSlipNodeForExam error', e);
    return null;
  }
}

// Handle exam selection "Continue" action
const confirmExamBtn = document.getElementById('confirmExamSelectBtn');
if (confirmExamBtn) {
  confirmExamBtn.addEventListener('click', function() {
    const sel = document.getElementById('examSelect');
    const val = sel && sel.value ? parseInt(sel.value, 10) : null;
    if (!val) {
      alert('Please select an exam.');
      return;
    }
    window.selectedExamId = val;
    // Close exam select modal
    const examModalEl = document.getElementById('examSelectModal');
    const examModal = bootstrap.Modal.getInstance(examModalEl) || new bootstrap.Modal(examModalEl);
    examModal.hide();
    // Re-open action chooser if we came from result slip flow
    if (selectedSectionId === 'result-slip-section') {
      const acmEl = document.getElementById('actionChooseModal');
      const acm = bootstrap.Modal.getInstance(acmEl) || new bootstrap.Modal(acmEl);
      acm.show();
    }
  });
}

// Auto-activate tabs from URL param: ?tab=performance
document.addEventListener('DOMContentLoaded', function(){
  const params = new URLSearchParams(window.location.search || '');
  const tab = params.get('tab');
  if (!tab) return;
  try {
    const tabBtn = document.getElementById(`${tab}-tab`);
    if (tabBtn) {
      const t = new bootstrap.Tab(tabBtn);
      t.show();
      // Optionally scroll into view
      setTimeout(() => {
        document.getElementById(tab)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 150);
    }
  } catch(e) { /* ignore */ }
});

// Download the same sections as PDF
function downloadSection(sectionId, title) {
  const nodeEl = document.getElementById(sectionId);
  if (!nodeEl) { alert('Section not found!'); return; }

  // If exporting Result Slip and an exam is chosen, fetch server-rendered HTML for that exam
  let node = nodeEl;
  const isResultSlip = sectionId === 'result-slip-section';
  const examId = window.selectedExamId;
  const shouldFetch = isResultSlip && examId;

  const proceed = () => {
    // Clone and prepare content
    const clone = node.cloneNode(true);
    try {
      clone.style.display = 'block';
      clone.style.visibility = 'visible';
      clone.style.position = 'static';
      clone.style.opacity = '1';
      clone.style.width = 'auto';
      clone.style.maxWidth = '100%';
      clone.classList.remove('d-none','collapse','collapsed','tab-pane','fade');
      clone.classList.add('show');
      clone.querySelectorAll('.collapse, .tab-pane').forEach(el => {
        el.classList.remove('collapse','tab-pane','fade');
        el.classList.add('show');
        el.style.display = 'block';
        el.style.visibility = 'visible';
      });
      clone.querySelectorAll('[data-pdf-fixed-width]')?.forEach(el => {
        const r = el.getBoundingClientRect();
        el.style.width = r.width + 'px';
      });
      clone.querySelectorAll('img').forEach(img => {
        try {
          const src = img.getAttribute('src') || '';
          if (!src || src.startsWith('data:')) return;
          img.setAttribute('crossorigin', 'anonymous');
        } catch(_) {}
      });
      // Remove elements that are not needed in PDF
      try {
        const selectors = ['#subjectSummaryTbl', '#subjectTrendChart', '#subjectTrendImg', '#subjectTrendSelect'];
        selectors.forEach(sel => {
          clone.querySelectorAll(sel).forEach(el => {
            const col = el.closest('.col-12.col-lg-6');
            const card = el.closest('.card');
            if (col && col.parentElement) col.remove(); else if (card) card.remove();
          });
        });
        const perfTargets = clone.querySelectorAll('#reportCardPerformanceChart, #rcPerfImg');
        perfTargets.forEach(t => { const card = t.closest('.card'); if (card) card.remove(); });
        clone.querySelectorAll('.row.g-3').forEach(r => { if (!r.querySelector('.card')) r.remove(); });
      } catch (_) {}
      try {
        const liveCanvas = document.getElementById('reportCardPerformanceChart');
        const liveImg = document.getElementById('rcPerfImg');
        if (liveCanvas) {
          let dataUrl = null; try { dataUrl = liveCanvas.toDataURL('image/png'); } catch(e) { dataUrl = null; }
          const targetCanvas = clone.querySelector('#reportCardPerformanceChart');
          const targetImg = clone.querySelector('#rcPerfImg');
          if (dataUrl) {
            const imgEl = document.createElement('img');
            imgEl.src = dataUrl; imgEl.alt = 'Performance Over Time'; imgEl.style.maxWidth = '100%'; imgEl.style.height = 'auto';
            if (targetCanvas) targetCanvas.replaceWith(imgEl); else if (targetImg) { targetImg.src = dataUrl; targetImg.style.display = 'block'; }
          } else if (targetImg && liveImg && liveImg.src) {
            targetImg.src = liveImg.src; targetImg.style.display = 'block';
          }
        }
      } catch(_) {}
    } catch(_) {}

    const header = document.createElement('div');
    header.innerHTML = `
      <div class="pdf-header">
        <div class="pdf-brand">
          {% if school.logo %}
            <img src="{{ school.logo.url }}" alt="Logo" class="pdf-logo">
          {% endif %}
          <div class="pdf-brand-text">
            <div class="pdf-school">{{ school.name|default:'School' }}</div>
            {% if school.motto %}<div class="pdf-motto">{{ school.motto }}</div>{% endif %}
            <div class="pdf-title">${title}</div>
          </div>
        </div>
        <div class="pdf-meta">
          <div><strong>Generated:</strong> ${new Date().toLocaleString()}</div>
          <div><strong>Adm:</strong> {{ student.admission_no }}</div>
        </div>
      </div>`;

    const filename = `${title.replace(/\s+/g,'_')}_{{ student.admission_no }}.pdf`;
    const opt = {
      margin:       10,
      filename:     filename,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false, allowTaint: false },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    showExportProgress();
    setExportStatus('Preparing content…');
    setExportProgress(15);

    const wrapper = document.createElement('div');
    wrapper.style.position = 'fixed';
    wrapper.style.left = '-10000px';
    wrapper.style.top = '0';
    wrapper.style.background = '#ffffff';
    wrapper.id = 'pdf-render-wrapper';
    const root = document.createElement('div');
    root.id = 'pdf-root';
    root.className = 'pdf-root';

    const style = document.createElement('style');
    style.textContent = `
      .pdf-root { background:#f6f8fb; padding:16px; font-family: "Segoe UI", Roboto, Arial, sans-serif; color:#0f172a; width:794px; }
      .pdf-card { background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; box-shadow: 0 4px 16px rgba(15,23,42,.08); overflow:hidden; }
      .pdf-header { display:flex; justify-content:space-between; align-items:center; padding:16px 18px; border-bottom:1px solid #e5e7eb; background: linear-gradient(90deg, #1f6feb 0%, #0ea5e9 100%); color:#fff; }
      .pdf-brand { display:flex; align-items:center; gap:12px; }
      .pdf-logo { height:48px; width:auto; object-fit:contain; filter: drop-shadow(0 2px 6px rgba(0,0,0,.25)); background:#fff; border-radius:8px; padding:6px; }
      .pdf-brand-text .pdf-school { font-weight:800; font-size:18px; line-height:1.1; }
      .pdf-brand-text .pdf-motto { font-size:12px; opacity:.9; }
      .pdf-brand-text .pdf-title { margin-top:4px; font-size:13px; font-weight:600; }
      .pdf-meta { text-align:right; font-size:12px; }
      .pdf-body { padding:18px; }
      .pdf-body table { width:100%; border-collapse:collapse; }
      .pdf-body th { background:#eef2ff; color:#111827; border:1px solid #e5e7eb; padding:6px; font-weight:700; font-size:12px; }
      .pdf-body td { border:1px solid #e5e7eb; padding:6px; font-size:12px; }
      .pdf-section-title { font-weight:800; color:#1f6feb; margin:12px 0 8px; border-left:4px solid #1f6feb; padding-left:8px; }
      .pdf-footer { border-top:1px solid #e5e7eb; padding:10px 18px; font-size:11px; color:#6b7280; display:flex; justify-content:space-between; }
      .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#e0f2fe; color:#0369a1; font-size:11px; font-weight:700; }
    `;

    const card = document.createElement('div');
    card.className = 'pdf-card';
    const body = document.createElement('div');
    body.className = 'pdf-body';
    body.appendChild(clone);

    const footer = document.createElement('div');
    footer.className = 'pdf-footer';
    footer.innerHTML = `
      <div>Powered by EduTrack School Manager</div>
      <div>{{ site_settings.contact_address|default:'' }}</div>
    `;

    card.appendChild(header);
    card.appendChild(body);
    card.appendChild(footer);

    root.appendChild(style);
    root.appendChild(card);
    wrapper.appendChild(root);
    document.body.appendChild(wrapper);

    function ensureLibs(){
      if (window.html2pdf) return Promise.resolve();
      return new Promise((resolve, reject)=>{
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
        s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
      });
    }

    function ensurePerfGraphReady(){
      return new Promise((resolve) => {
        try {
          if (!clone.querySelector('#reportCardPerformanceChart, #rcPerfImg')) { resolve(); return; }
          const liveCanvas = document.getElementById('reportCardPerformanceChart');
          const liveImg = document.getElementById('rcPerfImg');
          const targetCanvas = clone.querySelector('#reportCardPerformanceChart');
          const targetImg = clone.querySelector('#rcPerfImg');
          const container = targetCanvas ? targetCanvas.parentElement : (targetImg ? targetImg.parentElement : null);
          try { window.dispatchEvent(new Event('beforeprint')); } catch(_) {}
          let attempts = 0; const maxAttempts = 60;
          const replaceWithSrc = (src) => {
            if (!src || src.length < 100) return false;
            if (targetImg && targetImg.parentElement) try { targetImg.remove(); } catch(_) {}
            if (targetCanvas && targetCanvas.parentElement) { const imgEl = document.createElement('img'); imgEl.src = src; imgEl.alt = 'Performance Over Time'; imgEl.style.maxWidth='100%'; imgEl.style.height='auto'; targetCanvas.replaceWith(imgEl); return true; }
            if (container) { const imgEl = document.createElement('img'); imgEl.src = src; imgEl.alt = 'Performance Over Time'; imgEl.style.maxWidth='100%'; imgEl.style.height='auto'; container.prepend(imgEl); return true; }
            return false;
          };
          const tryMake = async () => {
            let done = false;
            try {
              if (liveCanvas) {
                const box = liveCanvas.getBoundingClientRect();
                if ((box.width || liveCanvas.width) === 0 || (box.height || liveCanvas.height) === 0) throw new Error('chart-not-ready');
                let d = null; try { d = liveCanvas.toDataURL('image/png'); } catch(e) { d = null; }
                if (replaceWithSrc(d)) done = true;
              }
              if (!done && liveImg && liveImg.src) { if (replaceWithSrc(liveImg.src)) done = true; }
              if (!done && targetCanvas && liveCanvas) {
                try { const cloneCanvas = document.createElement('canvas'); const w = liveCanvas.width || 800, h = liveCanvas.height || 300; cloneCanvas.width = w; cloneCanvas.height = h; cloneCanvas.style.maxWidth='100%'; cloneCanvas.style.height='auto'; const ctx = cloneCanvas.getContext('2d'); ctx.drawImage(liveCanvas, 0, 0); targetCanvas.replaceWith(cloneCanvas); done = true; } catch(_) {}
              }
              if (!done && container) {
                if (!window.domtoimage) { await new Promise((res, rej)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/dom-to-image-more@3.4.0/dist/dom-to-image-more.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }
                try { const png = await window.domtoimage.toPng(container, { bgcolor: '#ffffff', quality: 1 }); if (replaceWithSrc(png)) done = true; } catch(_) {}
              }
            } catch(_) {}
            if (done || attempts++ >= maxAttempts) { resolve(); } else { setTimeout(tryMake, 120); }
          };
          tryMake();
        } catch(_) { resolve(); }
      });
    }

    setExportStatus('Loading exporter…');
    setExportProgress(35);
    const watchdog = setTimeout(() => {
      try { setExportStatus('Taking too long. Using Print…'); hideExportProgress(); wrapper.remove(); printSection(sectionId, title); } catch(_) {}
    }, 45000);

    ensureLibs().then(() => {
      setExportStatus('Finalizing layout…');
      setExportProgress(55);
      setTimeout(() => {
        setExportStatus('Rendering pages…');
        setExportProgress(75);
        ensurePerfGraphReady().then(() => window.html2pdf().from(root).set(opt).save()).then(() => {
          setExportProgress(100);
          setExportStatus('Done');
          clearTimeout(watchdog);
          setTimeout(() => { hideExportProgress(); wrapper.remove(); }, 350);
        }).catch(async err => {
          console.warn('html2pdf failed, using fallback', err);
          try {
            setExportStatus('Using fallback renderer…');
            setExportProgress(85);
            async function ensureDomToImage() { if (window.domtoimage) return; await new Promise((resolve, reject)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/dom-to-image-more@3.4.0/dist/dom-to-image-more.min.js'; s.onload=resolve; s.onerror=reject; document.head.appendChild(s); }); }
            await ensureDomToImage();
            const dataUrl = await window.domtoimage.toPng(root, { bgcolor: '#ffffff', quality: 1 });
            if (!window.jspdf || !window.jspdf.jsPDF) { await new Promise((resolve, reject)=>{ const s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'; s.onload=resolve; s.onerror=reject; document.head.appendChild(s); }); }
            const { jsPDF } = window.jspdf || {}; if (!jsPDF) throw new Error('jsPDF not available after load');
            const pdf = new jsPDF(opt.jsPDF);
            const imgProps = pdf.getImageProperties(dataUrl);
            const pdfW = pdf.internal.pageSize.getWidth();
            const pdfH = (imgProps.height * pdfW) / imgProps.width;
            pdf.addImage(dataUrl, 'PNG', 0, 0, pdfW, pdfH);
            pdf.save(filename);
            setExportProgress(100);
            setExportStatus('Done');
            clearTimeout(watchdog);
            setTimeout(()=>{ hideExportProgress(); wrapper.remove(); }, 350);
          } catch (e2) {
            console.error('Fallback failed', e2);
            try { setExportStatus('Opening Print as fallback…'); clearTimeout(watchdog); hideExportProgress(); wrapper.remove(); printSection(sectionId, title); return; } catch(_) { setExportError('Unable to generate PDF on this device. Please use Print instead.'); setExportStatus('Failed'); setExportProgress(100); wrapper.remove(); }
          }
        });
      }, 400);
    }).catch(() => {
      setExportError('PDF library failed to load. Using Print instead.');
      hideExportProgress();
      wrapper.remove();
      printSection(sectionId, title);
    });
  };

  if (shouldFetch) {
    showExportProgress();
    setExportStatus('Loading selected exam…');
    setExportProgress(10);
    fetchResultSlipNodeForExam(examId).then(fetched => {
      if (fetched) node = fetched;
      hideExportProgress();
      proceed();
    }).catch(() => { hideExportProgress(); proceed(); });
  } else {
    proceed();
  }
}
// Progress helpers for export
function showExportProgress(){
  try {
    const modalEl = document.getElementById('exportProgressModal');
    if (!modalEl) return;
    const bar = document.getElementById('exportProgressBar');
    const status = document.getElementById('exportStatus');
    const err = document.getElementById('exportError');
    if (bar) { bar.style.width = '0%'; bar.textContent = '0%'; }
    if (status) status.textContent = 'Starting…';
    if (err) { err.textContent = ''; err.classList.add('d-none'); }
    const modal = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });
    modal.show();
  } catch(_) {}
}
function setExportProgress(p){
  try { const bar = document.getElementById('exportProgressBar'); if (!bar) return; const v = Math.max(0, Math.min(100, Math.round(p))); bar.style.width = v + '%'; bar.textContent = v + '%'; } catch(_) {}
}
function setExportStatus(text){ try { const el = document.getElementById('exportStatus'); if (el) el.textContent = text; } catch(_) {}
}
function setExportError(text){ try { const el = document.getElementById('exportError'); if (el) { el.textContent = text; el.classList.remove('d-none'); } } catch(_) {}
}
function hideExportProgress(){ try { const el = document.getElementById('exportProgressModal'); if (!el) return; const inst = bootstrap.Modal.getInstance(el); if (inst) inst.hide(); } catch(_) {}
}
</script>
</div>
{% endblock %}

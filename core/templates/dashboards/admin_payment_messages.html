{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2>All Payment Messages (M-Pesa Reference Codes)</h2>
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <form method="get" class="form-inline mb-0">
            <input type="text" name="search" class="form-control mr-2" placeholder="Search by student, reference, phone..." value="{{ request.GET.search }}">
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
        <a href="/admin_payment_messages/logs/" class="btn btn-info ml-2" style="white-space:nowrap;">
            View Transaction Messages
        </a>
    </div>
        <form method="get" class="form-inline">
            <input type="text" name="search" class="form-control mr-2" placeholder="Search by student, reference, phone..." value="{{ request.GET.search }}">
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Class</th>
                    <th>Amount Paid</th>
                    <th>Payment Date</th>
                    <th>Payment Method</th>
                    <th>M-Pesa Reference</th>
                    <th>Phone Number</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in payments %}
                <tr>
                    <td>{{ payment.student.user.get_full_name }} ({{ payment.student.admission_no }})</td>
                    <td>{{ payment.fee_assignment.class_group }}</td>
                    <td>Ksh. {{ payment.amount_paid }}</td>
                    <td>{{ payment.payment_date|date:'Y-m-d H:i' }}</td>
                    <td>{{ payment.payment_method }}</td>
                    <td>{{ payment.reference }}</td>
                    <td>{{ payment.phone_number }}</td>
                    <td>
    {{ payment.get_status_display }}
    {% if payment.status == 'pending' %}
        <button class="btn btn-success btn-sm verify-btn" data-payment-id="{{ payment.id }}">Verify</button>
    {% endif %}
</td>
                </tr>
                {% empty %}
                <tr><td colspan="8">No payment records found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.verify-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            const paymentId = btn.getAttribute('data-payment-id');
            if (!confirm('Are you sure you want to verify this payment?')) return;
            btn.disabled = true;
            fetch(`/verify_payment/${paymentId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]') || {}).value || '',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    btn.parentElement.innerHTML = data.status;
                } else {
                    alert(data.error || 'Verification failed.');
                    btn.disabled = false;
                }
            })
            .catch(() => {
                alert('An error occurred.');
                btn.disabled = false;
            });
        });
    });
});
</script>
{% endblock %}

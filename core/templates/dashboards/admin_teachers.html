{% extends 'base.html' %}
{% block title %}Admin Teachers{% endblock %}
{% block content %}

<div class="container-fluid py-4">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    .teacher-avatar {
        width: 38px;
        height: 38px;
        background: #e9ecef;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #495057;
        font-size: 1.1rem;
        margin-right: 12px;
    }
    .table-hover tbody tr:hover {
        background: #f8f9fa;
    }
    .teacher-actions .btn {
        padding: 0.25rem 0.5rem;
        font-size: 1.1rem;
    }
    .sticky-search-bar {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #fff;
        padding: 1rem 0 0.5rem 0;
        border-bottom: 1px solid #eee;
        margin-bottom: 1rem;
    }
</style>

<div class="d-flex align-items-center justify-content-between mb-4">
    <h1 class="mb-0">Teachers</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTeacherModal">
        <i class="bi bi-plus-lg me-1"></i> Add New Teacher
    </button>
</div>

<div class="sticky-search-bar mb-3">
    <form class="row g-2 align-items-center" method="get">
        <div class="col-md-3">
            <input type="text" name="search" class="form-control" placeholder="Search by name, email, phone, TSC/Staff ID..." value="{{ request.GET.search }}">
        </div>
        <div class="col-md-2">
            <select name="department" class="form-select">
                <option value="">All Departments</option>
                {% for dept in departments %}
                    <option value="{{ dept.id }}" {% if request.GET.department == dept.id|stringformat:'s' %}selected{% endif %}>{{ dept.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <select name="subject" class="form-select">
                <option value="">All Subjects</option>
                {% for subj in subjects %}
                    <option value="{{ subj.id }}" {% if request.GET.subject == subj.id|stringformat:'s' %}selected{% endif %}>{{ subj.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <select name="gender" class="form-select">
                <option value="">All Genders</option>
                <option value="male" {% if request.GET.gender == 'male' %}selected{% endif %}>Male</option>
                <option value="female" {% if request.GET.gender == 'female' %}selected{% endif %}>Female</option>
                <option value="other" {% if request.GET.gender == 'other' %}selected{% endif %}>Other</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-outline-primary w-100"><i class="bi bi-search"></i> Search/Filter</button>
        </div>
    </form>
</div>

<div class="table-responsive">
    <table class="table table-hover align-middle shadow-sm bg-white rounded">
        <thead class="table-light">
            <tr>
                <th>Name</th>
                <th>TSC Number</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Gender</th>
                <th>Department</th>
                <th>Subjects Taught</th>
                <th>Class Teacher Of</th>
                <th>Current Class/Stream</th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for teacher in teachers %}
            <tr>
                <td class="d-flex align-items-center">
                    <span class="teacher-avatar">
                        {% if teacher.user.first_name %}{{ teacher.user.first_name|slice:":1" }}{% endif %}{% if teacher.user.last_name %}{{ teacher.user.last_name|slice:":1" }}{% endif %}
                        {% if not teacher.user.first_name and not teacher.user.last_name %}{{ teacher.user.username|slice:":2"|upper }}{% endif %}
                    </span>
                    <a href="{% url 'edit_teacher' teacher.id %}" class="fw-semibold text-decoration-none">{{ teacher.user.get_full_name|default:teacher.user.username }}</a>
                </td>
                <td>{{ teacher.tsc_number }}</td>
                <td>{{ teacher.user.email }}</td>
                <td>{{ teacher.phone }}</td>
                <td>{{ teacher.gender|title }}</td>
                <td>{% if teacher.department %}{{ teacher.department.name }}{% else %}-{% endif %}</td>
                <td>
                    {% for subj in teacher.subjects.all %}
                        <span class="badge bg-secondary mb-1">{{ subj.name }}</span>
                    {% empty %}-{% endfor %}
                </td>
                <td>
                    {% if teacher.class_set.all %}
                        {% for c in teacher.class_set.all %}
                            <span class="badge bg-success mb-1">{{ c.name }}</span>
                        {% endfor %}
                    {% else %}-{% endif %}
                </td>
                <td>
                    {% if teacher.class_set.all %}
                        {% for c in teacher.class_set.all %}
                            <span class="badge bg-info mb-1">{{ c.name }}</span>
                        {% endfor %}
                    {% else %}-{% endif %}
                </td>
                <td class="text-center teacher-actions">
                    <a href="{% url 'edit_teacher' teacher.id %}" class="btn btn-outline-primary me-1" title="Edit"><i class="bi bi-pencil"></i></a>
                    <a href="{% url 'delete_teacher' teacher.id %}" class="btn btn-outline-danger" title="Delete"><i class="bi bi-trash"></i></a>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="10" class="text-center text-muted">No teachers found.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Add Teacher Modal -->
<div class="modal fade" id="addTeacherModal" tabindex="-1" aria-labelledby="addTeacherModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" action="{% url 'admin_teachers' %}" autocomplete="off" class="add-teacher-form">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addTeacherModalLabel">Add New Teacher</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {% if add_teacher_form.errors %}
            <div class="alert alert-danger mb-3">Please fix the errors below.</div>
          {% endif %}
          <div class="row g-3">
            <div class="col-md-6 mb-2">
              <label for="id_first_name" class="form-label">First Name</label>
              {{ add_teacher_form.first_name }}
              {% if add_teacher_form.first_name.errors %}<div class="text-danger small">{{ add_teacher_form.first_name.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6 mb-2">
              <label for="id_last_name" class="form-label">Last Name</label>
              {{ add_teacher_form.last_name }}
              {% if add_teacher_form.last_name.errors %}<div class="text-danger small">{{ add_teacher_form.last_name.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6 mb-2">
              <label for="id_username" class="form-label">Username</label>
              {{ add_teacher_form.username }}
              {% if add_teacher_form.username.errors %}<div class="text-danger small">{{ add_teacher_form.username.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6 mb-2">
              <label for="id_email" class="form-label">Email</label>
              {{ add_teacher_form.email }}
              {% if add_teacher_form.email.errors %}<div class="text-danger small">{{ add_teacher_form.email.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6 mb-2">
              <label for="id_password" class="form-label">Password</label>
              {{ add_teacher_form.password }}
              {% if add_teacher_form.password.errors %}<div class="text-danger small">{{ add_teacher_form.password.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6 mb-2">
              <label for="id_tsc_number" class="form-label">TSC Number</label>
              {{ add_teacher_form.tsc_number }}
              {% if add_teacher_form.tsc_number.errors %}<div class="text-danger small">{{ add_teacher_form.tsc_number.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6 mb-2">
              <label for="id_staff_id" class="form-label">Staff ID</label>
              {{ add_teacher_form.staff_id }}
              {% if add_teacher_form.staff_id.errors %}<div class="text-danger small">{{ add_teacher_form.staff_id.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6 mb-2">
              <label for="id_phone" class="form-label">Phone</label>
              {{ add_teacher_form.phone }}
              {% if add_teacher_form.phone.errors %}<div class="text-danger small">{{ add_teacher_form.phone.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6 mb-2">
              <label for="id_gender" class="form-label">Gender</label>
              {{ add_teacher_form.gender }}
              {% if add_teacher_form.gender.errors %}<div class="text-danger small">{{ add_teacher_form.gender.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6 mb-2">
              <label for="id_department" class="form-label">Department</label>
              {{ add_teacher_form.department }}
              {% if add_teacher_form.department.errors %}<div class="text-danger small">{{ add_teacher_form.department.errors }}</div>{% endif %}
            </div>
            <div class="col-12 mb-2">
              <label class="form-label">Subjects</label>
              <div class="row row-cols-2 row-cols-md-3 g-1">
                {% for checkbox in add_teacher_form.subjects %}
                  <div class="col">
                    <div class="form-check">
                      {{ checkbox.tag }} {{ checkbox.choice_label }}
                    </div>
                  </div>
                {% endfor %}
              </div>
              {% if add_teacher_form.subjects.errors %}
                <div class="text-danger small">{{ add_teacher_form.subjects.errors }}</div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Teacher</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="card-header bg-info text-white">
<script>
document.addEventListener('DOMContentLoaded', function() {
  var form = document.querySelector('#addTeacherModal form');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      var submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      var formData = new FormData(form);
      fetch('', {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: formData
      })
      .then(response => response.text())
      .then(html => {
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        var newModal = tempDiv.querySelector('#addTeacherModal .modal-content');
        if (newModal) {
          document.querySelector('#addTeacherModal .modal-content').innerHTML = newModal.innerHTML;
          // If no errors, modal will close and page reload
          var hasErrors = document.querySelector('#addTeacherModal .alert-danger');
          if (!hasErrors) {
            var modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addTeacherModal'));
            modal.hide();
            window.location.reload();
          }
        } else {
          window.location.reload();
        }
      })
      .catch(() => window.location.reload())
      .finally(() => { submitBtn.disabled = false; });
    });
  }
});
</script>

{% if add_teacher_form.errors %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var addModal = new bootstrap.Modal(document.getElementById('addTeacherModal'));
    addModal.show();
  });
</script>
{% endif %}

{% endblock %}

{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
    <style>
      /* Mobile-first refinements for student profile dashboard */
      .fee-card .card-body { padding: 1rem; }
      .fee-card .metric-title { font-size: 1rem; }
      .fee-card .metric-value { font-size: 1.25rem; font-weight: 700; }
      .fee-card .metric-icon { font-size: 1.5rem; margin-right: .75rem; }

      /* Make nav tabs scrollable on small screens */
      .nav-tabs { flex-wrap: nowrap; overflow-x: auto; overflow-y: hidden; }
      .nav-tabs .nav-link { white-space: nowrap; }

      /* Wrap action buttons and reduce size on very small widths */
      .action-buttons { gap: .5rem; flex-wrap: wrap; }
      @media (max-width: 576.98px) {
        .btn-lg { padding: .45rem .75rem; font-size: .95rem; }
        .fee-card .metric-title { font-size: .95rem; }
        .fee-card .metric-value { font-size: 1.15rem; }
        .fee-card .metric-icon { font-size: 1.35rem; }
        .profile-photo { width: 120px !important; height: 135px !important; }
        .card-header { align-items: flex-start !important; }
      }

      /* Ensure tables are scrollable horizontally on mobile */
      .table-responsive-mobile { overflow-x: auto; }
    </style>
    <div class="d-flex justify-content-end mb-3">
    <a href="{% url 'logout' %}" class="btn btn-outline-danger">
        <i class="bi bi-power"></i> Log Out
    </a>
</div>
<!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" id="studentProfileTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">Dashboard</button>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab" aria-controls="performance" aria-selected="false">Performance</a>
      </li>
    </ul>
    <!-- End Tab Navigation -->
<div class="tab-content" id="studentProfileTabsContent">
  <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">

    {% if current_term %}
    <div class="alert alert-success">
        <strong>Current Term:</strong> {{ current_term.name }} ({{ current_term.start_date|date:'M d, Y' }} to {{ current_term.end_date|date:'M d, Y' }}) in Academic Year {{ current_term.academic_year.year }}
    </div>
    {% endif %}
    <!-- Fee Summary Cards -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-md-4">
            <div class="card text-white fee-card" style="background-color: #f39c12;">
                <div class="card-body d-flex align-items-center">
                    <div class="metric-icon"><i class="fa fa-tag"></i></div>
                    <div>
                        <div class="metric-title">TOTAL BILLED:</div>
                        <div class="metric-value">Ksh. {{ total_billed|floatformat:2 }}</div>
                        <a href="#" class="btn btn-link text-white p-0" data-bs-toggle="modal" data-bs-target="#feeDetailsModal" data-tab="billed">View Details <i class="fa fa-arrow-circle-right"></i></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card text-white fee-card" style="background-color: #16a085;">
                <div class="card-body d-flex align-items-center">
                    <div class="metric-icon"><i class="fa fa-heart"></i></div>
                    <div>
                        <div class="metric-title">TOTAL PAID:</div>
                        <div class="metric-value">Ksh. {{ total_paid|floatformat:2 }}</div>
                        <a href="#" class="btn btn-link text-white p-0" data-bs-toggle="modal" data-bs-target="#feeDetailsModal" data-tab="paid">View Details <i class="fa fa-arrow-circle-right"></i></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card text-white fee-card" style="background-color: #00bcd4;">
                <div class="card-body d-flex align-items-center">
                    <div class="metric-icon"><i class="fa fa-comment"></i></div>
                    <div>
                        <div class="metric-title">BALANCE:</div>
                        <div class="metric-value">Ksh. {{ balance|floatformat:2 }}</div>
                        <a href="#" class="btn btn-link text-white p-0" data-bs-toggle="modal" data-bs-target="#feeDetailsModal" data-tab="billed">View Details <i class="fa fa-arrow-circle-right"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Ranking Widgets -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-md-4">
        <div class="card border-0" style="background:#f8f9fa;">
          <div class="card-body d-flex align-items-center">
            <div class="metric-icon me-3" style="font-size:1.5rem;"><i class="fa fa-trophy text-warning"></i></div>
            <div>
              <div class="metric-title">Class Rank</div>
              <div class="metric-value">
                {% if class_rank %} {{ class_rank }} <small class="text-muted">/ {{ class_total }}</small>{% else %} N/A {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card border-0" style="background:#f8f9fa;">
          <div class="card-body d-flex align-items-center">
            <div class="metric-icon me-3" style="font-size:1.5rem;"><i class="fa fa-sitemap text-primary"></i></div>
            <div>
              <div class="metric-title">Stream Rank</div>
              <div class="metric-value">
                {% if stream_rank %} {{ stream_rank }} <small class="text-muted">/ {{ stream_total }}</small>{% else %} N/A {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card border-0" style="background:#f8f9fa;">
          <div class="card-body d-flex align-items-center">
            <div class="metric-icon me-3" style="font-size:1.5rem;"><i class="fa fa-globe text-success"></i></div>
            <div>
              <div class="metric-title">Overall Level Rank</div>
              <div class="metric-value">
                {% if overall_level_rank %} {{ overall_level_rank }} <small class="text-muted">/ {{ overall_level_total }}</small>{% else %} N/A {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Profile and Info Section -->
    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <strong>User Profile</strong>
    <div class="d-flex gap-2">
        <a href="{% url 'student_messaging' %}" class="btn btn-outline-success btn-sm">
            Message Admin/Class Teacher
        </a>
        <a href="{% url 'student_messaging' %}?recipient_role=clerk" class="btn btn-outline-primary btn-sm">
            Message Clerk
        </a>
    </div>
                    <button class="btn btn-sm btn-outline-secondary float-end" title="Close" onclick="this.closest('.card').remove();">&times;</button>
                </div>
                <div class="card-body text-center">
                    {% if student.photo %}
                        <img src="{{ student.photo.url }}" class="rounded mb-2 profile-photo" style="width:160px;height:180px;object-fit:cover;" alt="Profile Photo">
                    {% else %}
                        <img src="https://ui-avatars.com/api/?name={{ student.user.get_full_name|default:student.user.username|urlencode }}&size=180" class="rounded mb-2 profile-photo" style="width:160px;height:180px;object-fit:cover;" alt="Profile Photo">
                    {% endif %}
                    <div class="fw-bold fs-5 mt-2">{{ student.admission_no }}</div>
                    <div class="text-muted mb-2"><b>Programme</b><br> {{ student.class_group.name }}</div>
                    <hr>
                    <div class="accordion" id="profileAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="stageHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#stageCollapse" aria-expanded="false" aria-controls="stageCollapse">
                                    My Stage
                                </button>
                            </h2>
                            <div id="stageCollapse" class="accordion-collapse collapse" aria-labelledby="stageHeading" data-bs-parent="#profileAccordion">
                                <div class="accordion-body">
                                    <!-- Stage info placeholder -->
                                    {{ student.class_group.level|default:'N/A' }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header bg-light d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
                    <strong class="me-md-3">Personal Information</strong>
                    <div class="ms-md-auto d-flex flex-wrap align-items-center gap-2">
                        <div class="btn-group btn-group-sm me-md-2 flex-wrap" role="group" aria-label="Print actions">
                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#actionChooseModal" data-section="result-slip-section" data-title="Result Slip"><i class="fa fa-file"></i> Result Slip</button>
                            <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#actionChooseModal" data-section="fees-statement-section" data-title="Fees Statement"><i class="fa fa-file"></i> Fees Statement</button>
                            <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#actionChooseModal" data-section="fees-structure-section" data-title="Fees Structure"><i class="fa fa-file"></i> Fees Structure</button>
                        </div>
                        <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#editContactModal">Update Profile</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">Admission No:</div>
                        <div class="col-sm-8">{{ student.admission_no }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">ID/Passport:</div>
                        <div class="col-sm-8">{{ student.id_number|default:'-' }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">Full Name:</div>
                        <div class="col-sm-8">{{ student.user.get_full_name|default:student.user.username }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">Gender:</div>
                        <div class="col-sm-8">{{ student.gender|title }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">Date of Birth:</div>
                        <div class="col-sm-8">{{ student.birthdate|date:'d/m/Y' }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">Phone Number:</div>
                        <div class="col-sm-8">{{ student.phone|default:'-' }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">Email Address:</div>
                        <div class="col-sm-8">{{ student.user.email }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">Postal Address:</div>
                        <div class="col-sm-8">{{ student.postal_address|default:'-' }}</div>
                    </div>

                    {% if can_update_contact %}
<div class="text-end mb-2">
    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editContactModal" title="Edit Contact Info">
        <i class="bi bi-pencil"></i>
    </button>
</div>
{% endif %}

<!-- Modal: Always rendered for all users -->
<div class="modal fade" id="editContactModal" tabindex="-1" aria-labelledby="editContactModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editContactModalLabel">Update Contact Information</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post">
        <div class="modal-body">
            {% csrf_token %}
            <div class="mb-3">
                <label class="form-label">Phone Number</label>
                {{ contact_form.phone }}
            </div>
            <div class="mb-3">
                <label class="form-label">Email Address</label>
                {{ contact_form.email }}
            </div>
            <div class="mb-3">
                <label class="form-label">Postal Address</label>
                {{ contact_form.postal_address }}
            </div>
            {% if contact_form.errors %}
                <div class="alert alert-danger mt-2">{{ contact_form.errors }}</div>
            {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" name="update_contact" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Attendance Section -->
<div class="card mb-4" id="attendance-section">
  <div class="card-header bg-light d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
    <strong class="me-md-3">Attendance</strong>
    <form method="get" class="ms-md-auto d-flex align-items-center gap-2">
      <label for="att_term" class="form-label mb-0">Term</label>
      <select name="att_term" id="att_term" class="form-select form-select-sm" onchange="this.form.submit()">
        <option value="">All</option>
        {% for t in attendance_terms %}
          <option value="{{ t.id }}" {% if attendance_current_term_id == t.id %}selected{% endif %}>
            {{ t.name }} - {{ t.academic_year.year }}
          </option>
        {% endfor %}
      </select>
    </form>
  </div>
  <div class="card-body">
    <div class="row g-2 mb-3">
      <div class="col-6 col-md-2">
        <div class="border rounded p-2 text-center">
          <div class="text-muted" style="font-size: .85rem;">Total Lessons</div>
          <div class="fw-bold">{{ attendance_summary.total }}</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="border rounded p-2 text-center">
          <div class="text-muted" style="font-size: .85rem;">Present</div>
          <div class="fw-bold text-success">{{ attendance_summary.present }}</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="border rounded p-2 text-center">
          <div class="text-muted" style="font-size: .85rem;">Absent</div>
          <div class="fw-bold text-danger">{{ attendance_summary.absent }}</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="border rounded p-2 text-center">
          <div class="text-muted" style="font-size: .85rem;">Late</div>
          <div class="fw-bold text-warning">{{ attendance_summary.late }}</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="border rounded p-2 text-center">
          <div class="text-muted" style="font-size: .85rem;">Excused</div>
          <div class="fw-bold text-info">{{ attendance_summary.excused }}</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="border rounded p-2 text-center">
          <div class="text-muted" style="font-size: .85rem;">Attendance Rate</div>
          <div class="fw-bold">{{ attendance_summary.rate }}%</div>
        </div>
      </div>
    </div>
    <div class="table-responsive-mobile">
      <table class="table table-sm table-striped align-middle">
        <thead>
          <tr>
            <th>Date</th>
            <th>Subject</th>
            <th>Status</th>
            <th>Teacher</th>
          </tr>
        </thead>
        <tbody>
          {% for att in attendance_records %}
            <tr>
              <td>{{ att.date|date:'Y-m-d' }}</td>
              <td>{{ att.subject.name }}</td>
              <td>
                {% if att.status == 'present' %}<span class="badge bg-success">Present</span>
                {% elif att.status == 'absent' %}<span class="badge bg-danger">Absent</span>
                {% elif att.status == 'late' %}<span class="badge bg-warning text-dark">Late</span>
                {% elif att.status == 'excused' %}<span class="badge bg-info text-dark">Excused</span>
                {% else %}{{ att.status|title }}{% endif %}
              </td>
              <td>{{ att.teacher.user.get_full_name|default:att.teacher.user.username }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="4" class="text-center">No attendance records found for the selected term.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>


                    <div class="text-end mt-3">
                        {% if user.role == 'admin' %}
<a href="{% url 'admin_payment' %}?student_id={{ student.id }}" class="btn btn-success btn-lg"><i class="fa fa-credit-card"></i> Make Payment</a>
<button type="button" class="btn btn-outline-primary btn-lg ms-2" data-bs-toggle="modal" data-bs-target="#editContactModal" title="Edit Profile">
    <i class="bi bi-pencil"></i>
</button>
{% else %}
<a href="{% url 'student_fees' %}" class="btn btn-success btn-lg"><i class="fa fa-credit-card"></i> Make Payment</a>
<button type="button" class="btn btn-outline-primary btn-lg ms-2" data-bs-toggle="modal" data-bs-target="#editContactModal" title="Edit Profile">
    <i class="bi bi-pencil"></i>
</button>
{% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

  </div>
  <div class="tab-pane fade" id="performance" role="tabpanel" aria-labelledby="performance-tab">
    <div id="result-slip-section">
    {% include 'dashboards/student_report_card.html' with student=student grades=grades average_score=average_score term=current_term %}
    </div>
    <!-- html2pdf for client-side PDF downloads (no SRI to avoid mismatch blocking) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- dom-to-image fallback for more reliable rasterization -->
<script src="https://cdn.jsdelivr.net/npm/dom-to-image-more@3.4.0/dist/dom-to-image-more.min.js"></script>
  </div>
<!-- Fee Details Modal -->
<div class="modal fade" id="feeDetailsModal" tabindex="-1" aria-labelledby="feeDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="feeDetailsModalLabel">Fee Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs mb-3" id="feeDetailsTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="billed-tab" data-bs-toggle="tab" data-bs-target="#billed" type="button" role="tab">Assigned Fees</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="paid-tab" data-bs-toggle="tab" data-bs-target="#paid" type="button" role="tab">Payment History</button>
          </li>
        </ul>
        <div class="tab-content" id="feeDetailsTabsContent">
          <div class="tab-pane fade show active" id="billed" role="tabpanel">
    <div id="fees-structure-section" class="table-responsive-mobile">
        <h6>Assigned Fees</h6>
        <table class="table table-bordered mb-0">
          <thead>
            <tr>
              <th>Fee Category</th>
              <th>Amount</th>
              <th>Paid</th>
              <th>Outstanding</th>
            </tr>
          </thead>
          <tbody>
          {% for assignment in fee_assignments %}
            <tr>
              <td>{{ assignment.fee_category.name }}</td>
              <td>{{ assignment.amount }}</td>
              <td>{{ assignment.paid }}</td>
              <td>{{ assignment.outstanding }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="4">No fees assigned for this term.</td></tr>
          {% endfor %}
          </tbody>
        </table>
    </div>
</div>
          <div class="tab-pane fade" id="paid" role="tabpanel">
    <div id="fees-statement-section" class="table-responsive-mobile">
        <h6>Payment History</h6>
        <table class="table table-sm table-striped mb-0">
          <thead>
            <tr>
              <th>Date</th>
              <th>Fee Category</th>
              <th>Amount Paid</th>
              <th>Method</th>
              <th>Reference</th>
            </tr>
          </thead>
          <tbody>
          {% for payment in fee_payments|dictsortreversed:'payment_date' %}
            <tr>
              <td>{{ payment.payment_date|date:'Y-m-d H:i' }}</td>
              <td>{{ payment.fee_assignment.fee_category.name }}</td>
              <td>{{ payment.amount_paid }}</td>
              <td>{{ payment.payment_method|default:'-' }}</td>
              <td>{{ payment.reference|default:'-' }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="5">No payments recorded.</td></tr>
          {% endfor %}
          </tbody>
        </table>
    </div>
</div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Action choose modal (Download or Print) -->
<div class="modal fade" id="actionChooseModal" tabindex="-1" aria-labelledby="actionChooseModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="actionChooseModalLabel">Choose Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">Would you like to download a PDF or print?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-info" id="choosePrintBtn"><i class="fa fa-print"></i> Print</button>
        <button type="button" class="btn btn-primary" id="chooseDownloadBtn"><i class="fa fa-download"></i> Download PDF</button>
      </div>
    </div>
  </div>
  </div>

<script>
// Switch to correct tab when opening modal from a card
const feeDetailsModal = document.getElementById('feeDetailsModal');
if (feeDetailsModal) {
  feeDetailsModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    if (!button) return;
    const tab = button.getAttribute('data-tab');
    if (!tab) return;
    const tabBtn = document.getElementById(tab+'-tab');
    if (tabBtn) {
      const tabTrigger = new bootstrap.Tab(tabBtn);
      tabTrigger.show();
    }
  });
}

function printSection(sectionId, title) {
  const content = document.getElementById(sectionId);
  if (!content) {
    alert('Section not found!');
    return;
  }

  const printWindow = window.open('', '', 'height=800,width=1000');
  const styles = Array.from(document.querySelectorAll('link[rel=stylesheet], style')).map(node => node.outerHTML).join('');
  const now = new Date().toLocaleString();
  const studentName = "{{ student.user.get_full_name|default:student.user.username }}";
  const adm = "{{ student.admission_no }}";
  const term = "{{ current_term.name|default:'-' }}";

  printWindow.document.write(`<!doctype html>
  <html><head><meta charset="utf-8"><title>${title}</title>${styles}
  <style>
    @media print { .no-print { display:none!important; } }
    body { padding: 24px; }
    .print-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; border-bottom:1px solid #ddd; padding-bottom:10px; }
    .print-header h2 { margin:0; font-size:1.25rem; }
    .print-meta { font-size:.9rem; color:#555; }
  </style></head><body>`);

  printWindow.document.write(`
    <div class="print-header">
      <div style="display:flex;align-items:center;gap:12px;">
        {% if school.logo %}
          <img src="{{ school.logo.url }}" alt="Logo" style="height:54px;width:auto;object-fit:contain;">
        {% endif %}
        <div>
          <div style="font-weight:800;font-size:1.1rem;line-height:1.2;">{{ school.name|default:'School' }}</div>
          {% if school.motto %}<div style="font-size:.9rem;color:#666;">{{ school.motto }}</div>{% endif %}
          <div style="font-size:.95rem;margin-top:4px;">${title}</div>
        </div>
      </div>
      <div class="print-meta" style="text-align:right;">
        <div>Generated: ${now}</div>
        <div>Adm: ${adm}</div>
        <div>Term: ${term}</div>
      </div>
    </div>
  `);

  // Clone the section HTML
  printWindow.document.write(`<div>${content.outerHTML}</div>`);
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.focus();
  printWindow.onload = function() {
    printWindow.print();
    setTimeout(() => { printWindow.close(); }, 300);
  };
}

// Wire the chooser modal to either download or print
let selectedSectionId = null;
let selectedTitle = null;
const actionChooseModal = document.getElementById('actionChooseModal');
if (actionChooseModal) {
  actionChooseModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    selectedSectionId = button?.getAttribute('data-section');
    selectedTitle = button?.getAttribute('data-title');
  });
  document.getElementById('chooseDownloadBtn').addEventListener('click', function(){
    if (selectedSectionId && selectedTitle) {
      const modal = bootstrap.Modal.getInstance(actionChooseModal);
      modal?.hide();
      downloadSection(selectedSectionId, selectedTitle);
    }
  });
  document.getElementById('choosePrintBtn').addEventListener('click', function(){
    if (selectedSectionId && selectedTitle) {
      const modal = bootstrap.Modal.getInstance(actionChooseModal);
      modal?.hide();
      printSection(selectedSectionId, selectedTitle);
    }
  });
}

// Auto-activate tabs from URL param: ?tab=performance
document.addEventListener('DOMContentLoaded', function(){
  const params = new URLSearchParams(window.location.search || '');
  const tab = params.get('tab');
  if (!tab) return;
  try {
    const tabBtn = document.getElementById(`${tab}-tab`);
    if (tabBtn) {
      const t = new bootstrap.Tab(tabBtn);
      t.show();
      // Optionally scroll into view
      setTimeout(() => {
        document.getElementById(tab)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 150);
    }
  } catch(e) { /* ignore */ }
});

// Download the same sections as PDF
function downloadSection(sectionId, title) {
  const node = document.getElementById(sectionId);
  if (!node) { alert('Section not found!'); return; }

  // Build header + clone
  const clone = node.cloneNode(true);
  // Ensure the clone is visible and not constrained by hidden/tab/collapse styles
  try {
    clone.style.display = 'block';
    clone.style.visibility = 'visible';
    clone.style.position = 'static';
    clone.style.opacity = '1';
    clone.style.width = 'auto';
    clone.style.maxWidth = '100%';
    clone.classList.remove('d-none','collapse','collapsed','tab-pane','fade');
    clone.classList.add('show');
    // Expand any nested collapse/tab panes inside the clone
    clone.querySelectorAll('.collapse, .tab-pane').forEach(el => {
      el.classList.remove('collapse','tab-pane','fade');
      el.classList.add('show');
      el.style.display = 'block';
      el.style.visibility = 'visible';
    });
  } catch(_) {}
  const header = document.createElement('div');
  header.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;border-bottom:1px solid #ccc;padding-bottom:8px;">
      <div style="display:flex;align-items:center;gap:12px;">
        {% if school.logo %}
          <img src="{{ school.logo.url }}" alt="Logo" style="height:54px;width:auto;object-fit:contain;">
        {% endif %}
        <div>
          <div style="font-weight:800;font-size:18px;">{{ school.name|default:'School' }}</div>
          {% if school.motto %}<div style="font-size:12px;color:#666;">{{ school.motto }}</div>{% endif %}
          <div style="font-size:13px;margin-top:4px;">${title}</div>
        </div>
      </div>
      <div style="text-align:right;font-size:12px;color:#555;">
        <div>Generated: ${new Date().toLocaleString()}</div>
        <div>Adm: {{ student.admission_no }}</div>
        <div>Term: {{ current_term }}</div>
      </div>
    </div>`;

  // Render inside an offscreen iframe that imports page styles
  const iframe = document.createElement('iframe');
  iframe.style.position = 'fixed';
  iframe.style.left = '-10000px';
  iframe.style.top = '0';
  iframe.style.width = '900px';
  iframe.style.height = '1200px';
  iframe.setAttribute('aria-hidden', 'true');
  document.body.appendChild(iframe);

  const filename = `${title.replace(/\s+/g,'_')}_{{ student.admission_no }}.pdf`;
  const opt = {
    margin:       10,
    filename:     filename,
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false, allowTaint: true },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };

  function copyStyles(srcDoc, destDoc){
    // Copy link stylesheets
    srcDoc.querySelectorAll('link[rel="stylesheet"]').forEach(l => {
      const link = destDoc.createElement('link');
      link.rel = 'stylesheet';
      link.href = l.href;
      destDoc.head.appendChild(link);
    });
    // Copy inline styles
    srcDoc.querySelectorAll('style').forEach(s => {
      const st = destDoc.createElement('style');
      st.textContent = s.textContent;
      destDoc.head.appendChild(st);
    });
  }

  function runExport(){
    const doc = iframe.contentDocument;
    const win = iframe.contentWindow;
    try {
      doc.open();
      const baseHref = document.baseURI || window.location.origin + '/';
      doc.write(`<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><base href="${baseHref}">`);
      doc.write('</head><body style="background:#fff;color:#000;padding:16px;">');
      doc.write('<div id="pdf-root"></div>');
      doc.write('</body></html>');
      doc.close();

      copyStyles(document, doc);
      const root = doc.getElementById('pdf-root');
      root.appendChild(doc.importNode(header, true));
      root.appendChild(doc.importNode(clone, true));

      // Ensure required libraries exist inside iframe
      function loadScript(src){
        return new Promise((resolve, reject) => { const s = doc.createElement('script'); s.src = src; s.onload = resolve; s.onerror = reject; doc.head.appendChild(s); });
      }
      const libLoads = [];
      if (!win.html2pdf) libLoads.push(loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js'));
      if (!win.domtoimage) libLoads.push(loadScript('https://cdn.jsdelivr.net/npm/dom-to-image-more@3.4.0/dist/dom-to-image-more.min.js'));

      const waitFonts = doc.fonts && doc.fonts.ready ? doc.fonts.ready.catch(()=>{}) : Promise.resolve();
      const waitImages = () => {
        const imgs = Array.from(doc.images || []);
        return Promise.all(imgs.map(img => img.complete ? Promise.resolve() : new Promise(res => { img.onload = img.onerror = res; })));
      };

      Promise.all([waitFonts, waitImages(), Promise.all(libLoads).catch(()=>{})]).then(() => {
        // Small layout delay
        setTimeout(() => {
          // Try html2pdf first
          win.html2pdf().from(root).set(opt).save().then(() => {
            iframe.remove();
          }).catch(async err => {
            console.warn('html2pdf in iframe failed, fallback to dom-to-image', err);
            try {
              const dataUrl = await win.domtoimage.toPng(root, { bgcolor: '#ffffff', quality: 1 });
              const pdf = new win.jspdf ? new win.jspdf.jsPDF('p','mm','a4') : new (window.jspdf ? window.jspdf.jsPDF : jsPDF)('p','mm','a4');
              const pageW = 210 - 20; const pageH = 297 - 20;
              const im = new Image(); im.src = dataUrl; await new Promise(r => { im.onload = r; im.onerror = r; });
              let w = pageW; let hScaled = (im.height / im.width) * w;
              if (hScaled > pageH) { hScaled = pageH; w = (im.width / im.height) * hScaled; }
              pdf.addImage(dataUrl, 'PNG', 10, 10, w, hScaled);
              pdf.save(filename);
            } catch (e2) {
              alert('Unable to generate PDF on this device. Please use Print instead.');
            } finally { iframe.remove(); }
          });
        }, 800);
      });
    } catch (e) {
      console.error(e);
      iframe.remove();
      alert('Unable to generate PDF on this device. You can use Print instead.');
    }
  }
  if (typeof window.html2pdf === 'undefined') {
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
    s.onload = runExport;
    s.onerror = function(){ alert('PDF library failed to load. Using Print instead.'); printSection(sectionId, title); };
    document.head.appendChild(s);
  } else {
    runExport();
  }
}
</script>
</div>
{% endblock %}

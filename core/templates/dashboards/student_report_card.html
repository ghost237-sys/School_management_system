<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <h3 class="mb-0">Student Report Card</h3>
    </div>
    <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <strong>Name:</strong> {{ student.user.get_full_name|default:student.user.username }}<br>
                    <strong>Admission No:</strong> {{ student.admission_no }}<br>
                    <strong>Class:</strong> {{ student.class_group.name }}<br>
<strong>Class Teacher:</strong> {{ student.class_group.class_teacher.user.get_full_name|default:"Not assigned" }}<br>
                </div>
                <div class="col-md-6">
                    <strong>Term:</strong> {{ term.name }}<br>
                    <strong>Academic Year:</strong> {{ term.academic_year.year }}<br>
                </div>
            </div>
            <h5 class="mt-4">Subject Performance</h5>
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Subject</th>
                        <th>Exam</th>
                        <th>Score</th>
                        <th>Grade</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody>
                {% for grade in grades %}
                    <tr>
                        <td>{{ grade.subject.name }}</td>
                        <td>{{ grade.exam.name }}</td>
                        <td>{{ grade.score|floatformat:1 }}</td>
                        <td>{{ grade.grade_letter }}</td>
                        <td>{{ grade.remarks }}</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="5">No grades available.</td></tr>
                {% endfor %}
                </tbody>
            </table>
            <div class="mt-4">
                <strong>Total Points:</strong> {{ total_points }}<br>
                <strong>Average Score:</strong> {{ average_score|floatformat:2 }}<br>
{% if stream_rank and stream_total %}
<strong>Class Rank:</strong> {{ stream_rank }}/{{ stream_total }}<br>
{% endif %}
{% if overall_level_rank and overall_level_total %}
<strong>Overall Rank:</strong> {{ overall_level_rank }}/{{ overall_level_total }}<br>
{% endif %}
            </div>
            {# Performance Over Time (All Exams) #}
            {{ exam_performance|json_script:"rc-perf-data" }}
            <div class="mt-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <strong>Performance Over Time (All Exams)</strong>
                    </div>
                    <div class="card-body">
                        {% if exam_performance and exam_performance|length > 0 %}
                            <canvas id="reportCardPerformanceChart" height="100"></canvas>
                            <img id="rcPerfImg" alt="Performance Chart" style="display:none; max-width:100%; height:auto;" />
                            <div class="table-responsive mt-3">
                              <table class="table table-sm table-striped mb-0">
                                <thead>
                                  <tr>
                                    <th style="width:140px;">Date</th>
                                    <th>Exam</th>
                                    <th class="text-end" style="width:140px;">Average</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {% for ex in exam_performance %}
                                    <tr>
                                      <td>{{ ex.date|default:'-' }}</td>
                                      <td>{{ ex.exam_name }}</td>
                                      <td class="text-end">{{ ex.average_score|floatformat:2 }}</td>
                                    </tr>
                                  {% endfor %}
                                </tbody>
                              </table>
                            </div>
                        {% else %}
                            <div class="alert alert-info mb-0">No performance data available for this student yet.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {# Subject Summary and Per-Subject Trend #}
            <div class="mt-4">
              <div class="row g-3">
                <div class="col-12 col-lg-6">
                  <div class="card">
                    <div class="card-header bg-secondary text-white">
                      <strong>Subjects Summary</strong>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-sm table-striped" id="subjectSummaryTbl">
                          <thead>
                            <tr>
                              <th>Subject</th>
                              <th class="text-end">Exams Taken</th>
                              <th class="text-end">Average Score</th>
                            </tr>
                          </thead>
                          <tbody>
                            <!-- Filled by JS from the Subject Performance table -->
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-lg-6">
                  <div class="card">
                    <div class="card-header bg-secondary text-white d-flex align-items-center gap-2">
                      <strong class="me-auto">Subject Trend</strong>
                      <select id="subjectTrendSelect" class="form-select form-select-sm" style="max-width: 260px;"></select>
                    </div>
                    <div class="card-body">
                      <canvas id="subjectTrendChart" height="120"></canvas>
                      <img id="subjectTrendImg" alt="Subject Trend" style="display:none; max-width:100%; height:auto;" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <style>
              @media print {
                #reportCardPerformanceChart { display: none !important; }
                #rcPerfImg { display: block !important; }
                #subjectTrendChart { display: none !important; }
                #subjectTrendImg { display: block !important; }
              }
              /* Make charts larger on small screens */
              @media (max-width: 576.98px) {
                #reportCardPerformanceChart { height: 260px !important; }
                #subjectTrendChart { height: 280px !important; }
              }
            </style>
            <script>
              (function() {
                const dataEl = document.getElementById('rc-perf-data');
                if (!dataEl) return;
                let perfData = [];
                try { perfData = JSON.parse(dataEl.textContent) || []; } catch(e) { perfData = []; }
                const filtered = perfData.filter(e => e && e.average_score !== null && e.average_score !== undefined);
                const labels = filtered.map(e => `${e.date} - ${e.exam_name}`);
                const scores = filtered.map(e => e.average_score);

                const mount = () => {
                  const canvasEl = document.getElementById('reportCardPerformanceChart');
                  if (!canvasEl || scores.length === 0) return;
                  const ctx = canvasEl.getContext('2d');
                  const rcChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                      labels: labels,
                      datasets: [{
                        label: 'Average Score',
                        data: scores,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 3
                      }]
                    },
                    options: {
                      animation: { duration: 0 },
                      responsive: true,
                      maintainAspectRatio: false,
                      scales: { y: { beginAtZero: true, suggestedMax: 100 } },
                      plugins: { legend: { display: true } }
                    }
                  });
                  // Pre-generate image immediately so print preview catches it
                  const imgEl = document.getElementById('rcPerfImg');
                  if (!imgEl) return;
                  const updateImg = () => { try { imgEl.src = canvasEl.toDataURL('image/png'); } catch(e) {} };
                  if (window.requestAnimationFrame) requestAnimationFrame(updateImg); else updateImg();
                  setTimeout(updateImg, 150); // small delay to ensure paint
                  // Update right before print as well
                  const beforePrint = () => { updateImg(); };
                  if (window.matchMedia) {
                    const mql = window.matchMedia('print');
                    if (mql && mql.addEventListener) mql.addEventListener('change', mq => { if (mq.matches) beforePrint(); });
                    else if (mql && mql.addListener) mql.addListener(mq => { if (mq.matches) beforePrint(); });
                  }
                  window.addEventListener('beforeprint', beforePrint);
                };

                const ensureChartJsThenMount = () => {
                  if (typeof Chart !== 'undefined') { mount(); return; }
                  // Lazy-load Chart.js once, then mount
                  const existing = document.querySelector('script[data-load="chartjs"]');
                  if (existing) { existing.addEventListener('load', mount, { once: true }); return; }
                  const s = document.createElement('script');
                  s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                  s.async = true;
                  s.defer = true;
                  s.setAttribute('data-load', 'chartjs');
                  s.addEventListener('load', mount, { once: true });
                  document.head.appendChild(s);
                };

                // Run after DOM is ready
                if (document.readyState === 'loading') {
                  document.addEventListener('DOMContentLoaded', ensureChartJsThenMount);
                } else {
                  ensureChartJsThenMount();
                }

                // Build Subject Summary + Subject Trend from the Subject Performance table above
                const buildSubjectAnalytics = () => {
                  const table = document.querySelector('table.table.table-bordered');
                  if (!table) return;
                  const rows = Array.from(table.querySelectorAll('tbody tr'));
                  // Map: subject -> { scores: [{exam, date, score}], avg, count }
                  const subjMap = new Map();
                  rows.forEach(tr => {
                    const tds = tr.querySelectorAll('td');
                    if (!tds || tds.length < 5) return;
                    const subject = (tds[0].textContent || '').trim();
                    const exam = (tds[1].textContent || '').trim();
                    const scoreStr = (tds[2].textContent || '').trim();
                    const score = parseFloat(scoreStr);
                    if (!subject || isNaN(score)) return;
                    if (!subjMap.has(subject)) subjMap.set(subject, { scores: [], sum: 0, count: 0 });
                    const rec = subjMap.get(subject);
                    rec.scores.push({ exam, score });
                    rec.sum += score; rec.count += 1;
                  });

                  // Fill summary table
                  const tbody = document.querySelector('#subjectSummaryTbl tbody');
                  if (tbody) {
                    tbody.innerHTML = '';
                    Array.from(subjMap.keys()).sort().forEach(subject => {
                      const r = subjMap.get(subject);
                      const avg = r.count ? (r.sum / r.count) : 0;
                      const tr = document.createElement('tr');
                      tr.innerHTML = `<td>${subject}</td><td class="text-end">${r.count}</td><td class="text-end">${avg.toFixed(2)}</td>`;
                      tbody.appendChild(tr);
                    });
                  }

                  // Populate subject selector
                  const select = document.getElementById('subjectTrendSelect');
                  const canvas = document.getElementById('subjectTrendChart');
                  const imgEl = document.getElementById('subjectTrendImg');
                  if (!select || !canvas) return;
                  select.innerHTML = '';
                  Array.from(subjMap.keys()).sort().forEach(subject => {
                    const opt = document.createElement('option');
                    opt.value = subject; opt.textContent = subject; select.appendChild(opt);
                  });
                  if (!select.value && select.options.length) select.value = select.options[0].value;

                  let trendChart = null;
                  const updateTrend = () => {
                    const subject = select.value;
                    const r = subjMap.get(subject);
                    if (!r) return;
                    const labels = r.scores.map(s => s.exam);
                    const data = r.scores.map(s => s.score);
                    const ctx = canvas.getContext('2d');
                    if (trendChart) { trendChart.destroy(); }
                    trendChart = new Chart(ctx, {
                      type: 'line',
                      data: { labels, datasets: [{ label: subject, data, borderColor: 'rgba(255, 159, 64, 1)', backgroundColor: 'rgba(255, 159, 64, 0.2)', tension: 0.3, fill: true, pointRadius: 3 }] },
                      options: { animation: { duration: 0 }, responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, suggestedMax: 100 } }, plugins: { legend: { display: true } } }
                    });
                    // update image for print
                    const updateImg = () => { try { imgEl.src = canvas.toDataURL('image/png'); } catch(e) {} };
                    if (window.requestAnimationFrame) requestAnimationFrame(updateImg); else updateImg();
                    setTimeout(updateImg, 150);
                  };
                  select.addEventListener('change', updateTrend);

                  const mountTrend = () => {
                    if (typeof Chart !== 'undefined') { updateTrend(); return; }
                    const existing = document.querySelector('script[data-load="chartjs"]');
                    if (existing) { existing.addEventListener('load', updateTrend, { once: true }); return; }
                    const s = document.createElement('script'); s.src = 'https://cdn.jsdelivr.net/npm/chart.js'; s.async = true; s.defer = true; s.setAttribute('data-load','chartjs'); s.addEventListener('load', updateTrend, { once: true }); document.head.appendChild(s);
                  };
                  mountTrend();
                };

                if (document.readyState === 'loading') {
                  document.addEventListener('DOMContentLoaded', buildSubjectAnalytics);
                } else {
                  buildSubjectAnalytics();
                }
              })();
            </script>
        </div>
    </div>
</div>

{% extends 'base.html' %}
{% block title %}Teacher Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Header: Teacher Info & Subject Load -->
  <div class="row mb-4">
    <div class="col-md-8">
      <h2>Welcome, {{ teacher.user.get_full_name|default:teacher.user.username }}</h2>
      <span class="badge bg-info">Subject Load: {{ teacher.subjects.count }} subject{{ teacher.subjects.count|pluralize }}</span>
      <span class="badge bg-secondary">Assigned Classes: {{ teacher.class_count }}</span>
    </div>
    <div class="col-md-4 text-end">
      <a href="#" class="btn btn-outline-primary">Export Schedule as PDF</a>
    </div>
  </div>

  <!-- Class & Subject Assignment Section -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <span>Class & Subject Assignment</span>
      <a href="#" class="btn btn-sm btn-light">Assign New</a>
    </div>
    <div class="card-body">
      <table class="table table-bordered align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Class/Stream</th>
            <th>Subjects Assigned</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for assignment in teacher.assignments %}
          <tr>
            <td>{{ assignment.class_group.name }}</td>
            <td>
              {% for subject in assignment.subjects %}
                <span class="badge bg-success">{{ subject.name }}</span>
              {% endfor %}
            </td>
            <td>
              <a href="#" class="btn btn-sm btn-outline-primary">Edit</a>
              <a href="#" class="btn btn-sm btn-outline-danger">Remove</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="3">No assignments yet.</td></tr>
        {% endfor %}
        </tbody>
      </table>
      {% if teacher.conflicts %}
      <div class="alert alert-warning mt-3">
        <strong>Conflicts Detected:</strong>
        <ul class="mb-0">
          {% for conflict in teacher.conflicts %}
            <li>{{ conflict }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Performance & Attendance Section -->
  <div class="card mb-4">
    <div class="card-header bg-success text-white">Performance & Attendance</div>
    <div class="card-body">
      <table class="table table-striped align-middle mb-0">
        <thead>
          <tr>
            <th>Subject</th>
            <th>Average Student Score</th>
            <th>Last Marked</th>
            <th>Trend</th>
          </tr>
        </thead>
        <tbody>
        {% for perf in teacher.performance %}
          <tr>
            <td>{{ perf.subject.name }}</td>
            <td>{{ perf.avg_score|floatformat:2 }}</td>
            <td>{{ perf.last_marked|date:'Y-m-d' }}</td>
            <td>{% if perf.trend == 'up' %}↑{% elif perf.trend == 'down' %}↓{% else %}→{% endif %}</td>
          </tr>
        {% empty %}
          <tr><td colspan="4">No performance data yet.</td></tr>
        {% endfor %}
        </tbody>
      </table>
      <div class="mt-3">
        <a href="#" class="btn btn-outline-info">View Detailed Performance</a>
        <a href="#" class="btn btn-outline-secondary">Mark Attendance</a>
      </div>
    </div>
  </div>

  <!-- Timetable Integration Section -->
  <div class="card mb-4">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
      <span>Timetable</span>
      <a href="#" class="btn btn-sm btn-light">Edit Timetable</a>
    </div>
    <div class="card-body">
      <table class="table table-bordered align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Day</th>
            <th>8:00-9:00</th>
            <th>9:00-10:00</th>
            <th>10:00-11:00</th>
            <th>11:00-12:00</th>
            <th>12:00-1:00</th>
          </tr>
        </thead>
        <tbody>
        {% for day, slots in teacher.timetable.items %}
          <tr>
            <td>{{ day }}</td>
            {% for slot in slots %}
              <td>{% if slot %}{{ slot }}{% else %}-{% endif %}</td>
            {% endfor %}
          </tr>
        {% endfor %}
        </tbody>
      </table>
      <div class="mt-3">
        <a href="#" class="btn btn-outline-info">Check Conflicts</a>
        <a href="#" class="btn btn-outline-primary">Export as PDF</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

                              </div>
                            </div>
                          </div>
                        </div>
                    </td>
                </tr>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
        // Placeholder JS for charts (to be replaced with real data)
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Chart) {
                // Bar Chart Example
                var ctxBar = document.getElementById('barChart_{{ class.class }}');
                if (ctxBar) {
                    new Chart(ctxBar, {
                        type: 'bar',
                        data: {
                            labels: ['Student1', 'Student2'],
                            datasets: [{
                                label: 'Scores',
                                data: [70, 85],
                                backgroundColor: 'rgba(54, 162, 235, 0.7)'
                            }]
                        },
                        options: {responsive: true}
                    });
                }
                // Grade Distribution Pie Example
                var ctxPie = document.getElementById('gradeDistChart_{{ class.class }}');
                if (ctxPie) {
                    new Chart(ctxPie, {
                        type: 'pie',
                        data: {
                            labels: ['A', 'B', 'C'],
                            datasets: [{
                                data: [5, 10, 3],
                                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc']
                            }]
                        },
                        options: {responsive: true}
                    });
                }
                // Mean calculation placeholder

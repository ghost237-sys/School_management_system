<div class="card mb-4">
    <div class="card-header bg-success text-white d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
    <h5 class="mb-0">History of Payments</h5>
    <form method="get" class="d-flex flex-wrap gap-2 align-items-center mb-0" style="max-width: 100%;">
        <input type="text" name="payment_search" value="{{ request.GET.payment_search|default:'' }}" class="form-control form-control-sm" placeholder="Search by admission # or username" style="width: 200px;">
        <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-search"></i> Search</button>
        <input type="hidden" name="tab" value="history">
        <button type="submit" name="payment_sort" value="newest" class="btn btn-outline-light btn-sm {% if request.GET.payment_sort != 'oldest' %}active{% endif %}"><i class="bi bi-sort-down"></i> Newest</button>
        <button type="submit" name="payment_sort" value="oldest" class="btn btn-outline-light btn-sm {% if request.GET.payment_sort == 'oldest' %}active{% endif %}"><i class="bi bi-sort-up"></i> Oldest</button>
    </form>
</div>
    <div class="card-body">
        <div style="max-height: 400px; overflow-y: auto; border-radius: 8px; border: 1px solid #e0e7ef; box-shadow: 0 1px 4px rgba(80,120,200,0.07);">
            <table class="table table-striped mb-0">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Payer</th>
                    <th>Fee</th>
                    <th>Amount Paid</th>
                    <th>Method</th>
                    <th>Reference</th>
                </tr>
            </thead>
            <tbody>
            {% for payment in all_fee_payments %}
                <tr>
                    <td>{{ payment.payment_date|date:"Y-m-d H:i" }}</td>
                    <td>{% if payment.student and payment.student.user %}{{ payment.student.user.get_full_name|default:payment.student.user.username }}{% else %}N/A{% endif %}</td>
                    <td>{{ payment.fee_assignment.fee_category.name }}</td>
                    <td>{{ payment.amount_paid }}</td>
                    <td>{{ payment.payment_method|default:'-' }}</td>
                    <td>{{ payment.reference|default:'-' }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="6">No payments recorded.</td></tr>
            {% endfor %}
            </tbody>
            </table>
        </div>
    </div>
</div>

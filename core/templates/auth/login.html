{% extends 'base.html' %}

{% block title %}Analitica - Login{% endblock %}
{% load static %}

{% block extra_head %}
<style>
  /* Hero gradient backdrop */
  .auth-hero {
    min-height: 100vh;
    background: linear-gradient(180deg, color-mix(in srgb, var(--bg) 85%, #fff) 0%, var(--bg) 100%);
    display: grid; place-items: center; padding: 2rem; overflow: hidden;
  }

  /* Glass card */
  .glass-card {
    position: relative; z-index: 1;
    width: 100%; max-width: 420px;
    border-radius: 14px; border: 1px solid var(--border);
    background: var(--surface);
    box-shadow: 0 8px 24px rgba(15,23,42,.06);
    backdrop-filter: blur(10px) saturate(140%);
    opacity: 0; transform: translateY(8px);
    animation: enter .35s ease forwards;
  }
  @keyframes enter { to { opacity: 1; transform: translateY(0) } }
  .brand-title { font-weight: 800; letter-spacing: .4px; }
  .subtitle { color: var(--muted); font-size: .95rem }

  /* Inputs with icons */
  .input-icon .input-group-text { border-right: 0; }
  .input-icon .form-control { border-left: 0; }
  .input-icon .form-control:focus { z-index: 2; }

  /* Primary gradient button */
  .btn-gradient {
    background: linear-gradient(90deg, color-mix(in srgb, var(--primary) 92%, black) 0%, var(--secondary) 100%);
    border: none; color: #fff; box-shadow: 0 8px 20px rgba(31,111,235,.22);
  }
  .btn-gradient:hover { filter: brightness(.96); }

  /* Small links */
  .muted-link { color: var(--muted); text-decoration: none; }
  .muted-link:hover { color: var(--text); text-decoration: underline; }

  @media (max-width: 480px) { .glass-card { border-radius: 14px } }

  /* CapsLock indicator */
  .caps-indicator { display:none; font-size:.8rem; color: var(--danger); }

  /* (simplified) */

  /* Two-column layout with a big robot */
  .auth-wrap { display:grid; grid-template-columns: minmax(320px, 540px) 420px; gap: 2rem; align-items: center; }
  @media (max-width: 992px) { .auth-wrap { grid-template-columns: 1fr; } }

  .bot-stage { display:flex; align-items:center; gap:1rem; justify-content:space-between; flex-direction: row-reverse; position: relative; z-index: 3; }
  .big-bot { position: relative; width: 360px; max-width: 42vw; aspect-ratio: 1/1; z-index: 3; margin-right: 0; cursor: pointer; }
  @media (max-width: 1200px) { .big-bot { width: 300px } }
  @media (max-width: 992px) { .bot-stage { justify-content:center } .big-bot { margin-right: 0 } }
  .big-bot svg { width:100%; height:100%; filter: drop-shadow(0 10px 28px rgba(15,23,42,.12)); }
  .big-bot .hand-right { transform-origin: 78% 58%; transform-box: fill-box; animation: hand-wave 3s ease-in-out infinite; transition: transform .28s ease; }
  .big-bot .hand-left { transform-origin: 22% 58%; transform-box: fill-box; transition: transform .28s ease; }
  .big-bot .bot-head { transform-origin: 50% 38%; transform-box: fill-box; transition: transform .28s ease; }
  @keyframes hand-wave { 0%,100%{ transform: rotate(0deg) } 50%{ transform: rotate(-8deg) } }

  /* (pointer removed per request) */

  .bot-chat { max-width: 360px; margin-left: 0; margin-right: 12px; }
  .bot-speech { position: relative; background: var(--surface); border:1px solid var(--border); border-radius: .75rem; padding:.75rem .9rem; box-shadow: 0 10px 22px rgba(15,23,42,.10); transition: opacity .28s ease, transform .28s ease, box-shadow .2s ease, border-color .2s ease; }
  /* Comic bubble during guide */
  .bot-speech.speak { border: 2px solid #ef4444; box-shadow: 0 8px 20px rgba(239,68,68,.08); }
  .bot-speech.speak::before { content:""; position: absolute; right: -14px; top: 36px; width: 0; height: 0; border-left: 16px solid #ef4444; border-top: 10px solid transparent; border-bottom: 10px solid transparent; }
  .bot-speech.speak::after { content:""; position: absolute; right: -12px; top: 37px; width: 0; height: 0; border-left: 14px solid var(--surface); border-top: 9px solid transparent; border-bottom: 9px solid transparent; }
  /* Show speech bubble by default */
  #botSpeech { display:block }
  .bot-speech.hidden { opacity: 0; transform: translateY(6px) scale(.985); pointer-events: none; }
  #botSay { color: var(--muted); font-size:.9rem; }

  /* Bored pose when help is hidden */
  .big-bot.bored .hand-right { animation: none; transform: rotate(65deg) translateY(6px); transition: transform .25s ease; }
  .big-bot.bored .hand-left { transform: rotate(-65deg) translateY(6px); transition: transform .25s ease; }
  .big-bot.bored .bot-head { transform: rotate(20deg) translateX(12px) translateY(2px); transition: transform .25s ease; }

  /* Collapsible help panel */
  #helpPanel { display:none; border:1px solid var(--border); border-radius:.8rem; padding: .75rem; background: color-mix(in srgb, var(--surface) 96%, transparent); }
  .steps { list-style:none; padding-left:0; margin:0 }
  .steps li { display:flex; align-items:flex-start; gap:.6rem; padding:.4rem 0 }
  .steps .num { width:22px; height:22px; border-radius:50%; display:grid; place-items:center; font-weight:600; font-size:.8rem; color:#fff; background: var(--primary) }
  .steps .txt { color: var(--muted); font-size:.92rem }

  /* Glow highlight for guided steps (soft blue aura) */
  .highlight {
    position: relative; z-index: 2; outline: none;
    /* outer glow rings to simulate margin glow */
    box-shadow:
      0 0 0 4px rgba(59,130,246,.28),
      0 0 0 10px rgba(59,130,246,.12),
      0 6px 18px rgba(15,23,42,.08);
    transition: box-shadow .2s ease;
    animation: glow-breathe 1.8s ease-in-out infinite;
  }
  @keyframes glow-breathe { 0%, 100% { box-shadow:
      0 0 0 4px rgba(59,130,246,.28),
      0 0 0 10px rgba(59,130,246,.12),
      0 6px 18px rgba(15,23,42,.08); }
    50% { box-shadow:
      0 0 0 6px rgba(59,130,246,.24),
      0 0 0 14px rgba(59,130,246,.10),
      0 8px 22px rgba(15,23,42,.10); }
  }
</style>
{% endblock %}

{% block content %}
<section class="auth-hero">
  <div class="d-flex justify-content-center">
    <div class="glass-card p-4 p-md-5">
    <div class="text-center mb-3">
      <div class="mb-2">
        <i class="bi bi-shield-lock" style="font-size:2rem;color:var(--primary);"></i>
      </div>
      <h2 class="brand-title mb-1">Analitica Login</h2>
      <div class="subtitle">Welcome back. Please sign in to continue.</div>
    </div>

    <!-- Bot moves outside; helper content removed from inside card -->

    {% if form.errors %}
      <div class="alert alert-danger" role="alert">
        Your username, password, or role was incorrect. Please try again.
      </div>
    {% endif %}

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" role="alert">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <form method="post" action="{% url 'login' %}" autocomplete="on">
      {% csrf_token %}

      <div class="mb-3 input-icon">
        <label for="id_username" class="form-label">Username</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-person"></i></span>
          <input type="text" name="username" class="form-control highlight" id="id_username" placeholder="e.g. johndoe" required>
        </div>
      </div>

      <div class="mb-3 input-icon">
        <div class="d-flex justify-content-between align-items-center">
          <label for="id_password" class="form-label mb-0">Password</label>
          <a href="#" class="muted-link small" tabindex="-1">Forgot password?</a>
        </div>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-lock"></i></span>
          <input type="password" name="password" class="form-control" id="id_password" placeholder="Your secure password" required autocomplete="current-password">
          <button class="btn btn-outline-secondary" type="button" id="togglePassword" aria-label="Show password"><i class="bi bi-eye"></i></button>
        </div>
        <div id="capsIndicator" class="caps-indicator mt-1"><i class="bi bi-exclamation-triangle me-1"></i>Caps Lock is on</div>
      </div>

      <div class="mb-4">
        <label for="id_role" class="form-label">Role</label>
        <select name="role" class="form-select" id="id_role" required>
          <option value="" disabled selected>Select Role</option>
          <option value="admin">Admin</option>
          <option value="teacher">Teacher</option>
          <option value="student">Student</option>
          <option value="clerk">Clerk</option>
        </select>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="1" id="rememberMe" name="remember">
          <label class="form-check-label" for="rememberMe">Keep me signed in</label>
        </div>
        <span></span>
      </div>

      <div class="d-grid gap-2">
        <button id="submitBtn" type="submit" class="btn btn-primary py-2" disabled>
          <span class="btn-label">Login</span>
          <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
        </button>
      </div>
      <input type="hidden" name="next" value="{{ request.GET.next }}">
    </form>

    <div class="text-center mt-4">
      <span class="small text-muted">Tip: You can switch to dark mode anytime using the moon button.</span>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function(){
    const toggle = document.getElementById('togglePassword');
    const input = document.getElementById('id_password');
    const caps = document.getElementById('capsIndicator');
    const roleSelect = document.getElementById('id_role');
    const username = document.getElementById('id_username');
    const submitBtn = document.getElementById('submitBtn');
    const spinner = submitBtn.querySelector('.spinner-border');
    const btnLabel = submitBtn.querySelector('.btn-label');
    const rememberMe = document.getElementById('rememberMe');

    if (toggle && input) {
      toggle.addEventListener('click', function(){
        const isPw = input.getAttribute('type') === 'password';
        input.setAttribute('type', isPw ? 'text' : 'password');
        this.querySelector('i').className = isPw ? 'bi bi-eye-slash' : 'bi bi-eye';
        this.setAttribute('aria-label', isPw ? 'Hide password' : 'Show password');
      });

      const show = () => { input.setAttribute('type', 'text'); toggle.querySelector('i').className = 'bi bi-eye-slash'; };
      const hide = () => { input.setAttribute('type', 'password'); toggle.querySelector('i').className = 'bi bi-eye'; };
      toggle.addEventListener('mousedown', show);
      toggle.addEventListener('mouseup', hide);
      toggle.addEventListener('mouseleave', hide);
      toggle.addEventListener('touchstart', e => { e.preventDefault(); show(); }, {passive:false});
      toggle.addEventListener('touchend', hide);
    }

    const capCheck = (e) => {
      if (!caps) return;
      const on = e.getModifierState && e.getModifierState('CapsLock');
      caps.style.display = on ? 'block' : 'none';
    };
    input.addEventListener('keyup', capCheck);
    input.addEventListener('keydown', capCheck);

    function validate(){
      const ok = username.value.trim() && input.value.trim() && roleSelect.value;
      submitBtn.disabled = !ok;
    }
    ['input','change','keyup'].forEach(evt => {
      username.addEventListener(evt, validate);
      input.addEventListener(evt, validate);
      roleSelect.addEventListener(evt, validate);
    });
    validate();

    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', function(){
        submitBtn.disabled = true;
        spinner.classList.remove('d-none');
        btnLabel.textContent = 'Signing in...';
      });
    }

    try {
      const savedUser = localStorage.getItem('login_username');
      const savedRole = localStorage.getItem('login_role');
      if (savedUser) username.value = savedUser;
      if (savedRole) { roleSelect.value = savedRole; }
      validate();

      rememberMe.addEventListener('change', function(){
        if (this.checked) {
          localStorage.setItem('login_username', username.value.trim());
          localStorage.setItem('login_role', roleSelect.value);
        } else {
          localStorage.removeItem('login_username');
          localStorage.removeItem('login_role');
        }
      });
      ['input','change'].forEach(evt => {
        username.addEventListener(evt, () => { if (rememberMe.checked) localStorage.setItem('login_username', username.value.trim()); });
      });
    } catch(e) { /* storage may be blocked; ignore */ }
  });
</script>
{% endblock %}
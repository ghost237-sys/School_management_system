{% extends 'base.html' %}
{% block title %}Admin Classes{% endblock %}
{% block content %}

<h1 class="mb-4">Classes <span class="fs-5 text-muted">({{ class_list|length }})</span></h1>
<style>
  /* Page tweaks for readability */
  .class-card .card-header { padding: .6rem .9rem; }
  .class-card .card-body { padding: .9rem; }
  .badge + .badge { margin-left: .35rem; }
  .tiny-chart { max-height: 180px; }
  .tab-content { padding-top: .75rem; }
  .table-sm td, .table-sm th { padding: .35rem .5rem; }
  .toolbar { position: sticky; top: .5rem; z-index: 2; background: var(--bs-body-bg); padding-bottom: .4rem; }
  /* Scroll area for classes */
  .classes-scroll { max-height: 70vh; overflow: auto; scroll-behavior: smooth; padding-right: .25rem; }
  .classes-scroll::-webkit-scrollbar { width: .55rem; }
  .classes-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,.2); border-radius: .5rem; }
  .classes-scroll:hover::-webkit-scrollbar-thumb { background: rgba(0,0,0,.35); }
</style>
<!-- Add New Class Form (collapse target remains; trigger moved to toolbar) -->
<div class="mb-4">
  <div class="collapse" id="addClassFormCollapse">
    <div class="card card-body border-0 shadow-sm rounded-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Add New Class</h6>
        <span class="badge text-bg-light">Quick setup</span>
      </div>
      <form method="post" action="" class="row g-3">
        {% csrf_token %}
        <input type="hidden" name="add_class" value="1">
        <div class="col-md-6">
          <label for="level_select" class="form-label">Level</label>
          <select class="form-select" id="level_select" name="level" required>
            {% for i in "123456789" %}
              <option value="{{ i }}">{{ i }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label for="id_stream" class="form-label">Stream</label>
          <select class="form-select" name="stream" required>
            <option value="East">East</option>
            <option value="West">West</option>
            <option value="North">North</option>
            <option value="South">South</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="id_level" class="form-label">Year/Level</label>
          {{ add_class_form.level }}
          {% if add_class_form.level.errors %}
            <div class="text-danger small">{{ add_class_form.level.errors.0 }}</div>
          {% endif %}
        </div>
        <div class="col-md-6">
          <label for="id_class_teacher" class="form-label">{{ add_class_form.class_teacher.label }}</label>
          {{ add_class_form.class_teacher }}
          {% if add_class_form.class_teacher.errors %}
            <div class="text-danger small">{{ add_class_form.class_teacher.errors.0 }}</div>
          {% endif %}
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-success">Add Class</button>
        </div>
      </form>
      <script>
      // Sync Level and Year/Level selects both ways
      document.addEventListener('DOMContentLoaded', function() {
        const levelA = document.getElementById('level_select'); // manual Level
        const levelB = document.getElementById('id_level');      // Year/Level from Django form
        if (!levelA || !levelB) return;
        // Initialize B from A if B is empty or different
        try {
          if (levelA.value && levelB.value !== levelA.value) levelB.value = levelA.value;
        } catch(e){}
        levelA.addEventListener('change', function(){ levelB.value = this.value; });
        levelB.addEventListener('change', function(){ levelA.value = this.value; });
      });
      </script>
    </div>
  </div>
</div>
<!-- Quick Filter Buttons + Add Button on one line -->
<div class="mb-3 toolbar">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
    <div class="d-flex flex-wrap gap-3 align-items-center">
      <div>
        <span class="me-2">Level:</span>
        <div class="btn-group btn-group-sm" role="group" aria-label="Level">
          <button type="button" class="btn btn-outline-primary" data-level-filter="">All</button>
          {% for i in "123456789" %}
            <button type="button" class="btn btn-outline-primary" data-level-filter="{{ i }}">{{ i }}</button>
          {% endfor %}
        </div>
      </div>
      <div>
        <span class="me-2">Stream:</span>
        <div class="btn-group btn-group-sm" role="group" aria-label="Stream">
          <button type="button" class="btn btn-outline-success" data-stream-filter="">All</button>
          <button type="button" class="btn btn-outline-success" data-stream-filter="east">East</button>
          <button type="button" class="btn btn-outline-success" data-stream-filter="west">West</button>
          <button type="button" class="btn btn-outline-success" data-stream-filter="north">North</button>
          <button type="button" class="btn btn-outline-success" data-stream-filter="south">South</button>
        </div>
      </div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'admin_graduated_students' %}">
        <i class="bi bi-mortarboard"></i> Graduated Students
      </a>
      <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#addClassFormCollapse" aria-expanded="false" aria-controls="addClassFormCollapse">
        <i class="bi bi-plus-circle me-1"></i> Add New Class
      </button>
    </div>
  </div>
  <div class="form-text mt-2">Filters apply instantly on the cards below.</div>
  <hr class="mt-2 mb-0"/>
</div>
<div class="card mb-4">
    <div class="card-header bg-secondary text-white">
        <h5 class="mb-0">All Classes <span class="fw-normal">({{ class_list|length }})</span></h5>
    </div>
    <div class="card-body">
        <div class="classes-scroll">
          <div id="classesGridContainer">
            <div class="text-center p-4">
              <div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading...</span></div>
              <p class="mt-2 mb-0">Loading classes...</p>
            </div>
          </div>
        </div>
        <script>
        // Deferred load classes partial with current filter state and enable pagination via event delegation
        document.addEventListener('DOMContentLoaded', function(){
          const container = document.getElementById('classesGridContainer');
          if (!container) return;

          function buildBaseUrl() {
            // Build from relative path to be resilient to different hosts
            return new URL('{% url "admin_classes_partial" %}', window.location.href);
          }
          function currentParams() {
            return new URLSearchParams(window.location.search);
          }
          function loadPartial(params) {
            const url = buildBaseUrl();
            // Bust caches to ensure fresh partial
            params.set('v', String(Date.now()));
            url.search = params.toString();
            // keep last query so pagination can reuse
            window._classesQuery = params.toString();
            container.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-secondary" role="status"></div><p class="mt-2 mb-0">Loading classes...</p></div>';
            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest', 'Cache-Control': 'no-cache' }, cache: 'no-store' })
              .then(r => r.text())
              .then(html => { container.innerHTML = html; })
              .catch(() => { container.innerHTML = '<div class="alert alert-danger">Failed to load classes.</div>'; });
          }

          // Initial load
          loadPartial(currentParams());

          // Event delegation for pagination links inside the loaded partial
          container.addEventListener('click', function(e){
            const a = e.target.closest('a.page-link[data-page]');
            if (!a) return;
            e.preventDefault();
            const page = a.getAttribute('data-page');
            const params = new URLSearchParams(window._classesQuery || window.location.search);
            params.set('page', page);
            try { console.debug('[Classes] paginate -> page', page); } catch(_){}
            loadPartial(params);
          });
        });
        </script>
    </div>
  </div>
</div>
<script>
// Client-side class filters
document.addEventListener('DOMContentLoaded', function() {
  let currentLevel = '';
  let currentStream = '';
  const cards = () => Array.from(document.querySelectorAll('.class-card'));
  function applyFilters() {
    cards().forEach(card => {
      const level = (card.getAttribute('data-level') || '').toString();
      const stream = (card.getAttribute('data-stream') || '').toLowerCase();
      const levelMatch = !currentLevel || level === currentLevel;
      const streamMatch = !currentStream || stream.includes(currentStream);
      card.style.display = (levelMatch && streamMatch) ? '' : 'none';
    });
  }
  // Level buttons
  document.querySelectorAll('[data-level-filter]').forEach(btn => {
    btn.addEventListener('click', () => {
      currentLevel = btn.getAttribute('data-level-filter');
      // update active styles
      document.querySelectorAll('[data-level-filter]').forEach(b => b.classList.remove('btn-primary'));
      document.querySelectorAll('[data-level-filter]').forEach(b => b.classList.add('btn-outline-primary'));
      btn.classList.remove('btn-outline-primary');
      btn.classList.add('btn-primary');
      applyFilters();
    });
  });
  // Stream buttons
  document.querySelectorAll('[data-stream-filter]').forEach(btn => {
    btn.addEventListener('click', () => {
      currentStream = btn.getAttribute('data-stream-filter');
      document.querySelectorAll('[data-stream-filter]').forEach(b => b.classList.remove('btn-success'));
      document.querySelectorAll('[data-stream-filter]').forEach(b => b.classList.add('btn-outline-success'));
      btn.classList.remove('btn-outline-success');
      btn.classList.add('btn-success');
      applyFilters();
    });
  });
});
</script>

{% endblock %}

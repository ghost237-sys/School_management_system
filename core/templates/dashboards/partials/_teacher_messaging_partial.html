{% load static %}
<style>
    .chat-container { display: flex; height: 78vh; border-radius: 14px; overflow: hidden; background: #ffffff; box-shadow: 0 10px 30px rgba(2,6,23,0.06), 0 4px 12px rgba(2,6,23,0.04); position: relative; }
    .chat-sidebar { width: 260px; background: linear-gradient(180deg, #f7fafd 0%, #f5f7fb 100%); border-right: 1px solid #e9eef5; display: flex; flex-direction: column; }
    .chat-sidebar-top { padding: 14px 14px 6px 14px; border-bottom: 1px solid #e9eef5; background: rgba(255,255,255,0.6); backdrop-filter: blur(6px); position: sticky; top: 0; z-index: 2; }
    .chat-search { width: 100%; border: 1px solid #d9e2ef; border-radius: 10px; padding: 8px 12px; font-size: 14px; outline: none; background: #fff; transition: box-shadow .2s, border-color .2s; }
    .chat-search:focus { border-color: #b6c6e3; box-shadow: 0 0 0 3px rgba(13,110,253,.15); }
    .chat-user-list { list-style: none; padding: 0; margin: 0; }
    .chat-user-list li { cursor: pointer; padding: 12px 14px; display: flex; align-items: center; border-bottom: 1px solid #f1f3f7; transition: background 0.2s, transform .06s; }
    .chat-user-list li.active, .chat-user-list li:hover { background: #eef7ff; }
    .chat-user-list li:active { transform: scale(0.998); }
    .chat-user-avatar { width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg,#c7d6f3 0%, #a8c0f0 100%); color: #1e293b; font-size: 1.1rem; font-weight: 700; text-align: center; line-height: 40px; margin-right: 12px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.6); }
    .chat-main { flex: 1; display: flex; flex-direction: column; background: linear-gradient(180deg,#fbfcff 0%, #f8fafc 100%); }
    .chat-header { padding: 14px 18px; border-bottom: 1px solid #eef2f7; display: flex; align-items: center; gap: 12px; position: sticky; top: 0; background: rgba(255,255,255,0.85); backdrop-filter: blur(6px); z-index: 2; }
    .chat-header .chat-user-avatar { margin-right: 10px; }
    .chat-header .hamburger { display: none; border: 1px solid #e2e8f0; background:#fff; border-radius:10px; width:40px; height:40px; align-items:center; justify-content:center; }
    .chat-header .hamburger i { font-size: 1.1rem; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 22px 18px; }
    .chat-bubble { max-width: 72%; padding: 12px 16px; border-radius: 14px; margin-bottom: 12px; font-size: 14px; line-height: 1.55; position: relative; box-shadow: 0 1px 3px rgba(2,6,23,0.06); border: 1px solid rgba(15,23,42,0.06); }
    .chat-bubble.sent { background: #e7f7e9; align-self: flex-end; border-bottom-right-radius: 6px; color: #0f172a; margin-left: 20%; }
    .chat-bubble.received { background: #ffffff; align-self: flex-start; border-bottom-left-radius: 6px; color: #0f172a; margin-right: 20%; }
    .chat-bubble .chat-time { display: block; text-align: right; font-size: 11px; color: #6b7280; margin-top: 6px; }
    .chat-input-area { padding: 12px 14px; background: rgba(248,250,252,0.85); border-top: 1px solid #eef2f7; display: flex; align-items: center; flex-shrink: 0; gap: 10px; position: sticky; bottom: 0; backdrop-filter: blur(6px); }
    .chat-input-area textarea { flex: 1; resize: none; border-radius: 12px; border: 1px solid #d1d5db; padding: 10px 12px; min-height: 44px; max-height: 160px; outline: none; transition: box-shadow .2s, border-color .2s; }
    .chat-input-area textarea:focus { border-color: #9cb6ea; box-shadow: 0 0 0 3px rgba(13,110,253,.12); }
    .chat-input-area button { border-radius: 12px; width: auto; height: 44px; display: inline-flex; align-items: center; gap: 8px; padding: 0 14px; }
    .chat-input-area .btn-success { background: linear-gradient(135deg,#22c55e 0%, #16a34a 100%); border: none; }
    .chat-input-area .btn-success:hover { filter: brightness(0.98); }

    /* Overlay for mobile sidebar */
    .chat-overlay { display:none; position:absolute; inset:0; background:rgba(15,23,42,0.25); z-index:2; }

    /* Custom scrollbars */
    .chat-sidebar, .chat-messages { scrollbar-width: thin; scrollbar-color: #c5cfdd transparent; }
    .chat-sidebar::-webkit-scrollbar, .chat-messages::-webkit-scrollbar { width: 8px; }
    .chat-sidebar::-webkit-scrollbar-thumb, .chat-messages::-webkit-scrollbar-thumb { background: #c5cfdd; border-radius: 6px; }

    /* Responsive adjustments */
    @media (max-width: 767.98px) {
        .chat-container { flex-direction: column; height: auto; }
        /* Sidebar becomes off-canvas */
        .chat-sidebar { position:absolute; top:0; bottom:0; left:0; width:min(85vw, 320px); max-width:100%; transform: translateX(-100%); transition: transform .25s ease; border-right:1px solid #e0e0e0; border-bottom:none; z-index:3; }
        .chat-container.sidebar-open .chat-sidebar { transform: translateX(0); }
        .chat-container.sidebar-open .chat-overlay { display:block; }
        /* Show hamburger */
        .chat-header .hamburger { display:inline-flex; }

        .chat-user-list li { padding: 12px 12px; }
        .chat-main { min-height: 60vh; }
        .chat-messages { padding: 14px; max-height: 50vh; }
        .chat-header { padding: 12px 14px; }
        .chat-bubble { max-width: 85%; padding: 10px 12px; font-size: 14px; }
        .chat-input-area { padding: 10px; gap: 8px; }
        .chat-input-area textarea { min-height: 42px; max-height: 140px; }
        .chat-input-area button { height: 40px; padding: 0 12px; }
    }

    @media (min-width: 768px) and (max-width: 991.98px) {
        .chat-container { height: 72vh; }
        .chat-sidebar { width: 280px; }
        .chat-messages { padding: 18px; }
        .chat-bubble { max-width: 80%; }
    }

    @media (max-width: 380px) {
        .chat-user-avatar { width: 34px; height: 34px; line-height: 34px; font-size: 1.1em; margin-right: 10px; }
        .chat-header { gap: 8px; }
        .chat-bubble { font-size: 13px; }
    }
</style>
<div class="chat-container" id="chatContainer" aria-live="polite">
    <!-- Sidebar: User List -->
    <div class="chat-sidebar">
        <div class="chat-sidebar-top">
            <input id="chatSearch" class="chat-search" type="text" placeholder="Search students..." oninput="filterRecipients()" />
        </div>
        <ul class="chat-user-list">
            {% for user in recipients %}
            <li {% if user.id|stringformat:'s' == selected_recipient_id %}class="active"{% endif %}>
                <a href="{% url 'teacher_messaging' %}?recipient={{ user.id }}" class="d-flex align-items-center text-reset text-decoration-none" style="gap:12px; width:100%;">
                    <div class="chat-user-avatar">{{ user.name|slice:':1'|upper }}</div>
                    <div>{{ user.name }}</div>
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
    <!-- Main Chat Area -->
    <div class="chat-main" aria-label="Messages">
        <div class="chat-header">
            <button type="button" class="hamburger" aria-label="Toggle recipients" aria-expanded="false" onclick="toggleSidebar()">
                <i class="bi bi-list"></i>
            </button>
            {% if selected_user %}
                <div class="chat-user-avatar">{{ selected_user.name|slice:':1'|upper }}</div>
                <div>
                    <strong>{{ selected_user.name }}</strong><br>
                    <small>{{ selected_user.role|capfirst }}</small>
                </div>
            {% else %}
                <span class="text-muted">Select a student to message</span>
            {% endif %}
        </div>
        <div class="chat-messages" id="chat-messages">
            {% if chat_history %}
                {% for msg in chat_history %}
                    <div class="chat-bubble {% if msg.sender_id == request.user.id %}sent{% else %}received{% endif %}">
                        {{ msg.content }}
                        <span class="chat-time">{{ msg.timestamp|date:'H:i' }}</span>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center text-muted">No messages yet. Start the conversation!</div>
            {% endif %}
        </div>
        {% if selected_user %}
        <form method="post" class="chat-input-area" autocomplete="off" action="{% url 'teacher_messaging' %}?recipient={{ selected_user.id }}">
            {% csrf_token %}
            <textarea name="message" rows="1" placeholder="Type a message..." required></textarea>
            <input type="hidden" name="recipient" value="{{ selected_user.id }}">
            <button type="submit" class="btn btn-success"><i class="bi bi-send"></i><span class="d-none d-sm-inline"> Send</span></button>
        </form>
        {% endif %}
    </div>
    <div class="chat-overlay" role="presentation" onclick="closeSidebar()"></div>
</div>
<script>
window.onload = function() {
    var chatMessages = document.getElementById('chat-messages');
    if (chatMessages) { chatMessages.scrollTop = chatMessages.scrollHeight; }
};

function filterRecipients() {
    var q = (document.getElementById('chatSearch').value || '').toLowerCase();
    var items = document.querySelectorAll('.chat-user-list li');
    items.forEach(function(li) {
        var name = (li.textContent || '').toLowerCase();
        li.style.display = name.indexOf(q) !== -1 ? '' : 'none';
    });
}

function toggleSidebar() {
    var container = document.getElementById('chatContainer');
    var isOpen = container.classList.toggle('sidebar-open');
    var btn = document.querySelector('.chat-header .hamburger');
    if (btn) btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
}

function closeSidebar() {
    var container = document.getElementById('chatContainer');
    container.classList.remove('sidebar-open');
    var btn = document.querySelector('.chat-header .hamburger');
    if (btn) btn.setAttribute('aria-expanded', 'false');
}

// Close with ESC key when open
document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') { closeSidebar(); }
});
</script>
